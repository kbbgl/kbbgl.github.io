<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Blog | Kobbi&#x27;s Knowledgebase</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kbbgl.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://kbbgl.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://kbbgl.github.io/blog/page/2"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Blog | Kobbi&#x27;s Knowledgebase"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kbbgl.github.io/blog/page/2"><link data-rh="true" rel="alternate" href="https://kbbgl.github.io/blog/page/2" hreflang="en"><link data-rh="true" rel="alternate" href="https://kbbgl.github.io/blog/page/2" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://kbbgl.github.io/blog/page/2","mainEntityOfPage":"https://kbbgl.github.io/blog/page/2","headline":"Blog","description":"Blog","blogPost":[{"@type":"BlogPosting","@id":"https://kbbgl.github.io/blog/installing-ubuntu-2004-on-2013-macbook-air","mainEntityOfPage":"https://kbbgl.github.io/blog/installing-ubuntu-2004-on-2013-macbook-air","url":"https://kbbgl.github.io/blog/installing-ubuntu-2004-on-2013-macbook-air","headline":"Installing Ubuntu 20.04 on 2013 MacBook Air","name":"Installing Ubuntu 20.04 on 2013 MacBook Air","description":"Fill me up!","datePublished":"2024-09-26T20:02:05.000Z","author":{"@type":"Person","name":"Kobbi Gal","description":"I like to pick things apart and see how they work inside","url":"https://github.com/kbbgl","image":"https://avatars.githubusercontent.com/u/14372649"},"keywords":[]},{"@type":"BlogPosting","@id":"https://kbbgl.github.io/blog/macbook-pro-2020-high-cpu-caused-siri","mainEntityOfPage":"https://kbbgl.github.io/blog/macbook-pro-2020-high-cpu-caused-siri","url":"https://kbbgl.github.io/blog/macbook-pro-2020-high-cpu-caused-siri","headline":"MacBook Pro 2020 High CPU caused by Siri","name":"MacBook Pro 2020 High CPU caused by Siri","description":"Fill me up!","datePublished":"2024-09-26T20:02:05.000Z","author":{"@type":"Person","name":"Kobbi Gal","description":"I like to pick things apart and see how they work inside","url":"https://github.com/kbbgl","image":"https://avatars.githubusercontent.com/u/14372649"},"keywords":[]},{"@type":"BlogPosting","@id":"https://kbbgl.github.io/blog/prod-down-mongodb-corrupt-heketi-glusterfs-provisioning","mainEntityOfPage":"https://kbbgl.github.io/blog/prod-down-mongodb-corrupt-heketi-glusterfs-provisioning","url":"https://kbbgl.github.io/blog/prod-down-mongodb-corrupt-heketi-glusterfs-provisioning","headline":"Fixing Production Down caused by MongoDB Corruption and Heketi/GlusterFS Failed Provisioning","name":"Fixing Production Down caused by MongoDB Corruption and Heketi/GlusterFS Failed Provisioning","description":"Fill me up!","datePublished":"2024-09-26T20:02:05.000Z","author":{"@type":"Person","name":"Kobbi Gal","description":"I like to pick things apart and see how they work inside","url":"https://github.com/kbbgl","image":"https://avatars.githubusercontent.com/u/14372649"},"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kobbi&#39;s Knowledgebase RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kobbi&#39;s Knowledgebase Atom Feed"><link rel="stylesheet" href="/assets/css/styles.735d0977.css">
<script src="/assets/js/runtime~main.1ec4ccfa.js" defer="defer"></script>
<script src="/assets/js/main.87b33758.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Kobbi&#x27;s Knowledgebase</b></a><a class="navbar__item navbar__link" href="/docs/cloud_services/aws/configure-aws-cli">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" sidebarid="blogSidebar" href="/blog">Blog</a><a class="navbar__item navbar__link" sidebarid="hackBlogSidebar" href="/hack_blog">Hack Blog</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/3-way-data-migration-between-support-systems">3-Way Data Migration between Support Systems</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/angstrom-ctf2021-exploiting-python-pickle-in-flask">Angstrom CTF2021 | Exploiting Python Pickle in Flask Web App</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/catch-ebusy-on-nodejs">How To Catch EBUSY Event on Windows using NodeJS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/debugging-nodejs-microservice-with-shared-storage-on kubernetes">Debugging NodeJS Microservice with Shared Storage on Kubernetes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/dotless-email-regex-validation-swagger">How To Set Up Dotless Email Validation in Swagger</a></li></ul></div></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/installing-ubuntu-2004-on-2013-macbook-air">Installing Ubuntu 20.04 on 2013 MacBook Air</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-09-26T20:02:05.000Z">September 26, 2024</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/kbbgl" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/14372649" alt="Kobbi Gal"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/kbbgl" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Kobbi Gal</span></a></div><small class="authorTitle_nd0D" title="I like to pick things apart and see how they work inside">I like to pick things apart and see how they work inside</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>The other day when visiting my family, under a large pile of torn up binders and laminated documents, I found my sibling’s old 2013 MacBook Air. I thought it would be wasteful to just leave it there so I picked it up and took it to the lab, AKA home.
I discovered that the laptop was password locked with my sibling’s user and password. Since it must’ve been laying at my family’s house for a few years at least, and we as human’s have a tendency to forget our credentials, I decided to save the attempts and just format it and start with a clean OS.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="formatting-and-reinstalling-macos">Formatting and Reinstalling MacOS<a href="#formatting-and-reinstalling-macos" class="hash-link" aria-label="Direct link to Formatting and Reinstalling MacOS" title="Direct link to Formatting and Reinstalling MacOS">​</a></h2>
<ol>
<li>In the <a href="https://support.apple.com/en-il/guide/mac-help/aside/mchl385f1eea/10.13/mac/10.13" target="_blank" rel="noopener noreferrer">menu bar</a>, choose Apple menu &gt; Restart. As your Mac restarts, hold down the <code>Command + R</code> keys until the macOS Utilities window appears.</li>
<li>Select <em>Disk Utility</em>, then click Continue.</li>
<li>Select your startup disk on the left, then click <em>Erase</em>.</li>
<li>Click the Format pop-up menu, choose <a href="https://support.apple.com/en-il/guide/mac-help/aside/dsku61bc26a5/10.13/mac/10.13" target="_blank" rel="noopener noreferrer">Mac OS Extended format</a>, enter a name, then click <em>Erase</em>.</li>
<li>After the disk is erased, choose <em>Disk Utility &gt; Quit Disk Utility</em>.</li>
<li>Select <a href="https://support.apple.com/en-il/guide/mac-help/reinstall-macos-mchlp1599/10.13/mac/10.13" target="_blank" rel="noopener noreferrer">Reinstall macOS</a>, click <em>Continue</em>, then follow the onscreen instructions.</li>
</ol>
<p>All of the steps ran smoothly and I had a working machine! The battery was still in really good shape as well, the screen was scratchless and the keyboard still had that bounce to it.
So I began downloading all the applications I usually use like Google Chrome, iTerm, Visual Studio Code. But when launching Google Chrome, I discovered that when navigating to GMail or Google Drive, I received an error message indicating that the applications do not support this browser and operating system.
I wasn’t buying it that the hardware would not be able to run the browser and applications and I had a strong belief that it’s some Apple-imposed limitation as part of the ‘<a href="https://en.wikipedia.org/wiki/Planned_obsolescence" target="_blank" rel="noopener noreferrer">Lightbulb Conspiracy</a>.’ So I decided to pursue a different option: installing the latest Ubuntu on this 2013 MacBook Air to free the software restrictions of the machine manufacturer and unleash the power of the hardware.
I decided the best approach would be to initially dual boot MacOS and Ubuntu, ensure that Ubuntu is stable and then remove the partition where MacOS lives.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-bootable-ubuntu-usb-stick">Create a Bootable Ubuntu USB Stick<a href="#create-a-bootable-ubuntu-usb-stick" class="hash-link" aria-label="Direct link to Create a Bootable Ubuntu USB Stick" title="Direct link to Create a Bootable Ubuntu USB Stick">​</a></h2>
<p>The first step was to generate a bootable USB stick which would hold the Ubuntu image.
I logged into MacOS and downloaded the latest Ubuntu image from <a href="https://ubuntu.com/download/desktop" target="_blank" rel="noopener noreferrer">https://ubuntu.com/download/desktop</a> and saved it in <code>~/Downloads/ubuntu-20.04.2.0-desktop-amd.iso</code>.</p>
<p>I then opened the Terminal and ran the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hdiutil convert </span><span class="token parameter variable" style="color:#36acaa">-format</span><span class="token plain"> UDRW </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> /tmp/ubuntu.img ~/Downloads/ubuntu-20.04.2.0-desktop-amd.iso</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The command utilizes the MacOS <code>hdutil</code> tool to convert an image between two data types: <code>.iso</code> (disk image in ISO-9660 standard) to <code>.img.dmg</code> (disk image specifically by MacOS). The <code>-format UDRW</code> argument specifies that we want to read and write the image with the Apple <code>UDIF</code> format. To read more about the hdutil and UDIF format, I suggest reading the <a href="https://ss64.com/osx/hdiutil.html" target="_blank" rel="noopener noreferrer">hdutil man page</a> and <a href="http://disktype.sourceforge.net/doc/ch03s13.html" target="_blank" rel="noopener noreferrer">disk image formats</a>.</p>
<p>The command above created a new file in <code>/tmp/ubuntu.img.dmg</code>. But since we don’t want to run the MacOS installer (which is what the dmg image and extension do by default) in this case but want to create a bootable USB stick, we’ll need to convert the image from <code>.img.dmg</code> to <code>.img</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> /tmp/ubuntu.img.dmg /tmp/ubuntu.img</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At this point we can insert the USB stick which will likely be mounted by default to <code>/dev/disk1</code>.
Next, we need to unmounting the disk representing the USB stick, copying all files from the image to the unmounted disk using the dd binary and then ejecting the disk. We can perform all these steps using the MacOS <code>diskutil</code> binary within the Terminal:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">diskutil unmountDisk /dev/disk1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dd</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">if</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/ubuntu.img </span><span class="token assign-left variable" style="color:#36acaa">of</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/dev/rdisk1 </span><span class="token assign-left variable" style="color:#36acaa">bs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">diskutil </span><span class="token function" style="color:#d73a49">eject</span><span class="token plain"> /dev/disk1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We’re done with this step! We now have a USB stick containing the Ubuntu OS. We can eject it for now.
Next, we need to prepare some disk space on the hard disk where we intend to install Ubuntu.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-partition">Creating a Partition<a href="#creating-a-partition" class="hash-link" aria-label="Direct link to Creating a Partition" title="Direct link to Creating a Partition">​</a></h2>
<p>A partition is basically a separation of the hard disk into individual sections (also known as containers).</p>
<p><img decoding="async" loading="lazy" src="https://www.maketecheasier.com/assets/uploads/2012/05/partitions-partition-diagram.png" alt="cont" class="img_ev3q"></p>
<p>To be able to run both Ubuntu and MacOS on the same machine, we require to create a partition in the hard disk to hold both operating systems.
This step is rather straightforward with the use of the MacOS Disk Utility. We need to launch it, select the first disk we see on the left navver (called <em>Macintosh HD</em> in the image below):</p>
<p>Then click on <em>Partition</em>, choose the size of the disk you want to allocate to the partition where we’ll store Ubuntu, make sure the selected format is <em>Mac OS Extended (Case-sensitive, Journaled)</em> and click Apply. My hard disk size was 120GB so I allocated 80GB to Ubuntu and left the rest for MacOS.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="replacing-macos-default-boot-manager">Replacing MacOS Default Boot Manager<a href="#replacing-macos-default-boot-manager" class="hash-link" aria-label="Direct link to Replacing MacOS Default Boot Manager" title="Direct link to Replacing MacOS Default Boot Manager">​</a></h2>
<p>Let’s recap what we have done so far:</p>
<p>What would be the next logical step? We would need to tell the machine to let us decide which operating system we want to boot into. By default, the Apple bootloader will load MacOS. To change this behavior, we need to install a different boot manager. We need <a href="https://www.rodsbooks.com/refind/" target="_blank" rel="noopener noreferrer">rEFInd Boot Manager</a> to do this.</p>
<p><a href="http://sourceforge.net/projects/refind/files/0.13.2/refind-bin-0.13.2.zip/download" target="_blank" rel="noopener noreferrer">Download the binary</a> from here and extract it:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">unzip</span><span class="token plain"> ~/Downloads/refind-bin-0.13.2.zip</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then reboot the machine and hold <code>Command + R</code>. This should bring you into Recovery Mode.</p>
<p>We need to run the <code>rEFInd</code> installation script. From the main menu bar, choose Utilities &gt; Terminal and type the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /Volumes/Macintosh</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"> HD/Users/YOUR_USERNAME/Downloads/refined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./refind-install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will install the rEFInd boot manager. After it completes, shut down the machine, insert the USB stick we’ve prepared earlier and turn on the machine.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="launching-and-installing-ubuntu">Launching and Installing Ubuntu<a href="#launching-and-installing-ubuntu" class="hash-link" aria-label="Direct link to Launching and Installing Ubuntu" title="Direct link to Launching and Installing Ubuntu">​</a></h2>
<p>When we turn on the machine the next time, we will be greeted with the rEFInd Boot Manager:</p>
<p><img decoding="async" loading="lazy" src="https://www.rodsbooks.com/refind/refind.png" alt="refind" class="img_ev3q"></p>
<p>Select Tux (the penguin, Linux mascot) and use the arrows to navigate to the <em>Try Ubuntu without install</em> option. Then press <em>e</em> which will expose a configuration file where we will make some changes. We will need to add the following commands between ‘splash‘ and ‘---‘:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nomodeset </span><span class="token assign-left variable" style="color:#36acaa">radeon.audio</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is because by default, the Radeon HDMI audio driver is disabled in the Linux kernel. After making this change, press F10 to save and exit.
After a minute or two, you should be the Ubuntu menu:</p>
<p><img decoding="async" loading="lazy" src="https://ubuntucommunity.s3-us-east-2.amazonaws.com/original/2X/a/ad5e454a9fd45fd56d90da951702c2f2224cd32a.png" alt="ubuntu" class="img_ev3q"></p>
<p>Click on <em>Install Ubuntu</em>, follow the installation wizard you should be set!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="addendum-fixing-camera-detection">Addendum: Fixing Camera Detection<a href="#addendum-fixing-camera-detection" class="hash-link" aria-label="Direct link to Addendum: Fixing Camera Detection" title="Direct link to Addendum: Fixing Camera Detection">​</a></h2>
<p>One of the applications I use most nowadays is Zoom so I was surprised when I joined a call and saw that my camera was not detected by Zoom. I also downloaded <a href="https://wiki.gnome.org/Apps/Cheese" target="_blank" rel="noopener noreferrer">Cheese</a> just to confirm sure that the issue wasn’t specific to Zoom. I saw the same greeting: ‘no device detected’.
I did some research and found that there was some firmware missing for the Facetime HD (Broadcom 1570) PCIe webcam which prevented the kernel from detecting the driver. I opened up the terminal and ran the following commands to get the driver to work (you will need <code>git</code> and <code>curl</code> installed):</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> /usr/local/src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/patjak/bcwc_pcie.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cloning into </span><span class="token string" style="color:#e3116c">&#x27;bcwc_pcie&#x27;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote: Enumerating objects: </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote: Counting objects: </span><span class="token number" style="color:#36acaa">100</span><span class="token plain">% </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token plain">/8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote: Compressing objects: </span><span class="token number" style="color:#36acaa">100</span><span class="token plain">% </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">/6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote: Total </span><span class="token number" style="color:#36acaa">1057</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">delta </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, reused </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">delta </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, pack-reused </span><span class="token number" style="color:#36acaa">1049</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Receiving objects: </span><span class="token number" style="color:#36acaa">100</span><span class="token plain">% </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1057</span><span class="token plain">/1057</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">352.48</span><span class="token plain"> KiB </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">537.00</span><span class="token plain"> KiB/s, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resolving deltas: </span><span class="token number" style="color:#36acaa">100</span><span class="token plain">% </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">709</span><span class="token plain">/709</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> /usr/local/src/bcwc_pcie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/patjak/facetimehd-firmware</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cloning into </span><span class="token string" style="color:#e3116c">&#x27;facetimehd-firmware&#x27;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote: Enumerating objects: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote: Counting objects: </span><span class="token number" style="color:#36acaa">100</span><span class="token plain">% </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote: Total </span><span class="token number" style="color:#36acaa">886</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">delta </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, reused </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">delta </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, pack-reused </span><span class="token number" style="color:#36acaa">885</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Receiving objects: </span><span class="token number" style="color:#36acaa">100</span><span class="token plain">% </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">886</span><span class="token plain">/886</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">290.76</span><span class="token plain"> KiB </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">294.00</span><span class="token plain"> KiB/s, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resolving deltas: </span><span class="token number" style="color:#36acaa">100</span><span class="token plain">% </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">585</span><span class="token plain">/585</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> /usr/local/src/bcwc_pcie/facetimehd-firmware</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Checking dependencies </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> driver download</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/bin/curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/bin/xzcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/bin/cpio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Downloading the driver, please wait</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Found matching </span><span class="token builtin class-name">hash</span><span class="token plain"> from OS X, El Capitan </span><span class="token number" style="color:#36acaa">10.11</span><span class="token plain">.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Extracting firmware</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> --</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Decompressing the firmware using gzip</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> --</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Deleting temporary files</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> --</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Extracted firmware version </span><span class="token number" style="color:#36acaa">1.43</span><span class="token plain">.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copying firmware into </span><span class="token string" style="color:#e3116c">&#x27;//lib/firmware/facetimehd&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> /usr/local/src/bcwc_pcie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-C</span><span class="token plain"> /lib/modules/5.0.0-23-generic/build </span><span class="token assign-left variable" style="color:#36acaa">M</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/local/src/bcwc_pcie modules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: Entering directory </span><span class="token string" style="color:#e3116c">&#x27;/usr/src/linux-headers-5.0.0-23-generic&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CC </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  /usr/local/src/bcwc_pcie/fthd_ddr.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CC </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  /usr/local/src/bcwc_pcie/fthd_hw.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CC </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  /usr/local/src/bcwc_pcie/fthd_drv.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CC </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  /usr/local/src/bcwc_pcie/fthd_ringbuf.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CC </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  /usr/local/src/bcwc_pcie/fthd_isp.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CC </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  /usr/local/src/bcwc_pcie/fthd_v4l2.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CC </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  /usr/local/src/bcwc_pcie/fthd_buffer.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CC </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  /usr/local/src/bcwc_pcie/fthd_debugfs.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LD </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  /usr/local/src/bcwc_pcie/facetimehd.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Building modules, stage </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MODPOST </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> modules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CC      /usr/local/src/bcwc_pcie/facetimehd.mod.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LD </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  /usr/local/src/bcwc_pcie/facetimehd.ko</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: Leaving directory </span><span class="token string" style="color:#e3116c">&#x27;/usr/src/linux-headers-5.0.0-23-generic&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-C</span><span class="token plain"> /lib/modules/5.0.0-23-generic/build </span><span class="token assign-left variable" style="color:#36acaa">M</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/local/src/bcwc_pcie modules_install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: Entering directory </span><span class="token string" style="color:#e3116c">&#x27;/usr/src/linux-headers-5.0.0-23-generic&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INSTALL /usr/local/src/bcwc_pcie/facetimehd.ko</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">At main.c:160:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- SSL error:02001002:system library:fopen:No such </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> or directory: </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/crypto/bio/bss_file.c:72</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- SSL error:2006D080:BIO routines:BIO_new_file:no such file: </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/crypto/bio/bss_file.c:79</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sign-file: certs/signing_key.pem: No such </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> or directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DEPMOD  </span><span class="token number" style="color:#36acaa">5.0</span><span class="token plain">.0-23-generic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: modules_install: missing </span><span class="token string" style="color:#e3116c">&#x27;System.map&#x27;</span><span class="token plain"> file. Skipping depmod.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: Leaving directory </span><span class="token string" style="color:#e3116c">&#x27;/usr/src/linux-headers-5.0.0-23-generic&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Don’t worry too much about the SSL errors above, they are red herrings.
I then needed to load the drivers into the kernel:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> depmod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe </span><span class="token parameter variable" style="color:#36acaa">-r</span><span class="token plain"> bdc_pci</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe facetimehd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I relaunched Cheese and saw my messy face on the camera 🙂
But once I restarted the computer, I saw that the changes were reverted. I needed to persist them somehow. After some more research, I found that I needed to add <code>facetimehd</code> to the kernel modules that are loaded during boot time:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token builtin class-name">echo</span><span class="token plain"> facetimehd </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /etc/modules</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After restarting, I saw that I was able to detect my camera in Zoom and Cheese!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mac">mac</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ubuntu">ubuntu</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/macbook-pro-2020-high-cpu-caused-siri">MacBook Pro 2020 High CPU caused by Siri</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-09-26T20:02:05.000Z">September 26, 2024</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/kbbgl" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/14372649" alt="Kobbi Gal"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/kbbgl" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Kobbi Gal</span></a></div><small class="authorTitle_nd0D" title="I like to pick things apart and see how they work inside">I like to pick things apart and see how they work inside</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>A few months ago, I received a highly-anticipated 2020 32GB, 2.3 GHz Quad-Core Intel Core i7 MacBook Pro. Highly-anticipated because I already had one stolen (a 2019 version) earlier last year in a robbery in an AirBnB apartment I was renting while I was staying in Barcelona. It was quite a dramatic story but I won’t get into the details. This is a tech blog after all.</p>
<p>Back to the new computer I acquired, the thing was flying. I could open large projects in IntelliJ and VSCode, run a Kubernetes cluster using <a href="https://minikube.sigs.k8s.io/docs/start/" target="_blank" rel="noopener noreferrer"><code>minikube</code></a> and endless amounts of terminals simultaneously on different workspaces and the thing would not miss a beat.</p>
<p>Within the first week of receiving machine, I got a notification indicating that there was a system update. I never had any fears come with system updates. I always found myself jumping ship and hoping no regressions or new issues are introduced upon upgrades/updates. I’m not a skeptic, I believe Apple’s QA is up to the highest testing standards.</p>
<p>Anyway, I let the update run for a few hours and after a couple of restarts, the OS was back up and could work on the machine again.</p>
<p>Pretty soon thereafter, I heard the machine fan working intensively and the low-carbon aluminum enclosure was excessively hot. I also noticed that I the interaction with the OS and applications was crawlingly-slow. I even had the machine crash 2-3 times! I decided I had enough and that it was time to put on my Sherlock Holmes hat and start the investigation.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="finding-the-culprit-process">Finding the Culprit Process<a href="#finding-the-culprit-process" class="hash-link" aria-label="Direct link to Finding the Culprit Process" title="Direct link to Finding the Culprit Process">​</a></h2>
<p>It makes sense that the first place to review would be Activity Monitor. It allows us to check the amount of energy each running process is utilizing in addition to CPU cycles and RAM allocation. Below is the screenshot of what I saw after launching Activity Monitor:</p>
<p><img decoding="async" loading="lazy" src="https://tilsupport.files.wordpress.com/2021/03/image.png" alt="activity-monitor" class="img_ev3q"></p>
<p>We can see that the top process, <code>ZscalerTunnel</code> was really using up the CPU. I knew what this process belonged to (a VPN service). I was able to fix the <code>ZscalerTunnel</code> CPU hog by installing the latest version of the application and restarting the machine.</p>
<p>But the second process, <code>corespeechd</code> was not letting go and was at times using between 3 to 4 CPUs (300-400%). And the worst part was that I had no idea what <code>corespeechd</code> was (aside from a guess that it was some sort of daemon because of the letter ‘d’ in the suffix).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-corespeechd">What is <code>corespeechd</code>?<a href="#what-is-corespeechd" class="hash-link" aria-label="Direct link to what-is-corespeechd" title="Direct link to what-is-corespeechd">​</a></h2>
<p>This question was hard to find online. I believe because I am not a registered Apple developer, I could not see any relevant documentation about this process/service. What I did find was that many people had a problem with this daemon hogging machine resources such as <a href="https://discussions.apple.com/thread/8643914?page=2" target="_blank" rel="noopener noreferrer">massive network utilization (1)</a> and <a href="https://discussions.apple.com/thread/250955260?page=2" target="_blank" rel="noopener noreferrer">massive network utilization (2)</a>. And I also found a lot of people experiencing the <a href="https://forums.macrumors.com/threads/cpu-usage-corespeechd.2158710/" target="_blank" rel="noopener noreferrer">high CPU consumption</a> and on <a href="https://twitter.com/alecmuffett/status/1089721018015539200?lang=en" target="_blank" rel="noopener noreferrer">Twitter as well</a>.</p>
<p>According to the online research, all fingers were pointing to one feature: Siri. In addition, all recommendations to mitigate this issue mentioned disabling/enabling or turning off Siri completely. Unfortunately for me, corespeechd was still causing problems after my attempt to disable Siri.
Since the machine had crashed a few times, I decided the next step would be to review the system crash report.
What I found was that the OS crashed because of a segmentation fault:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Crashed Thread:        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  Dispatch queue: com.apple.main-thread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Exception Type:        EXC_BAD_ACCESS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SIGSEGV</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Exception Codes:       KERN_INVALID_ADDRESS at 0x0000000108745050</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Exception Note:        EXC_CORPSE_NOTIFY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Termination Signal:    Segmentation fault: </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Termination Reason:    Namespace SIGNAL, Code 0xb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terminating Process:   exc handler </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">11719</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> Crashed:: Dispatch queue: com.apple.main-thread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token plain">   libobjc.A.dylib                0x00007fff202639af objc_release + </span><span class="token number" style="color:#36acaa">15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain">   com.apple.CoreFoundation       0x00007fff20478a76 -</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">__NSDictionaryI dealloc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">146</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   libobjc.A.dylib                0x00007fff2028139d AutoreleasePoolPage::releaseUntil</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">objc_object**</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">167</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">   libobjc.A.dylib                0x00007fff2026433e objc_autoreleasePoolPop + </span><span class="token number" style="color:#36acaa">161</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">   com.apple.CoreFoundation       0x00007fff2047e1f0 _CFAutoreleasePoolPop + </span><span class="token number" style="color:#36acaa">22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">   com.apple.CoreFoundation       0x00007fff20587748 __CFRunLoopPerCalloutARPEnd + </span><span class="token number" style="color:#36acaa">41</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6</span><span class="token plain">   com.apple.CoreFoundation       0x00007fff204bc88b __CFRunLoopRun + </span><span class="token number" style="color:#36acaa">2788</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">7</span><span class="token plain">   com.apple.CoreFoundation       0x00007fff204bb6ce CFRunLoopRunSpecific + </span><span class="token number" style="color:#36acaa">563</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">8</span><span class="token plain">   com.apple.Foundation           0x00007fff21248fa1 -</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NSRunLoop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NSRunLoop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> runMode:beforeDate:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">212</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">9</span><span class="token plain">   com.apple.Foundation           0x00007fff212d7384 -</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NSRunLoop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NSRunLoop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> run</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">76</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10</span><span class="token plain">  com.apple.authorizationhost    0x0000000108661727 main + </span><span class="token number" style="color:#36acaa">302</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">11</span><span class="token plain">  libdyld.dylib                  0x00007fff203e0621 start + </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>What was immediately visible was that there were instructions in memory address <code>0x00007fff20478a76</code> that were being allocated by the <code>com.apple.CoreFoundation</code> package. This gave me the evidence I needed that tied the system crash to the issues witnessed by the <code>Core</code> services.</p>
<p>I decided to run <code>corespeechd</code> using <code>strace</code> so I could see what system calls the process was executing during run-time. I found the following output indicating there was some permission issues attempting to access a certain process probe:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dtrace: error on enabled probe ID </span><span class="token number" style="color:#36acaa">2378</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ID </span><span class="token number" style="color:#36acaa">918</span><span class="token plain">: syscall::kevent_id:return</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: invalid user access </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> action </span><span class="token comment" style="color:#999988;font-style:italic">#5 at DIF offset 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dtrace: error on enabled probe ID </span><span class="token number" style="color:#36acaa">2385</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ID </span><span class="token number" style="color:#36acaa">904</span><span class="token plain">: syscall::workq_kernreturn:return</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: invalid user access </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> action </span><span class="token comment" style="color:#999988;font-style:italic">#5 at DIF offset 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-launchctl-to-disable-corespeechd">Using <code>launchctl</code> to Disable <code>corespeechd</code><a href="#using-launchctl-to-disable-corespeechd" class="hash-link" aria-label="Direct link to using-launchctl-to-disable-corespeechd" title="Direct link to using-launchctl-to-disable-corespeechd">​</a></h2>
<p>Since Siri was already off, I was pretty sure that if I found a way to completely disable <code>corespeechd</code>, I would be able to release the daemon from eating up my processors.</p>
<p>I am familiar with using <code>systemctl</code> and <code>init.d</code> on Linux to be able to control system services. On Windows I usually just use the <code>Stop-Service</code> PowerShell cmdlet. But for Mac I wasn’t sure what command line tool needs to be used. I found out that the preferred way is to use <code>launchctl</code>.</p>
<p>I also wanted to understand where MacOS startup scripts are stored. I found out that there were 5 different directories:</p>
<ul>
<li><code>/System/Library/LaunchDaemons/</code> – System-wide daemons provided by the operating system.</li>
<li><code>/System/Library/LaunchAgents/</code> – Per-user agents provided by the operating system.</li>
<li><code>~/Library/LaunchAgents/</code> – Per-user agents provided by the user.</li>
<li><code>/Library/LaunchAgents/</code> – Per-user agents provided by the administrator.</li>
<li><code>/Library/LaunchDaemons/</code> – System-wide daemons provided by the administrator.</li>
</ul>
<p><code>launchd</code> manages the processes, both for the system as a whole and for individual users using configuration files with the <code>.plist</code> extension.</p>
<p>I reviewed the <code>launchctl</code> <code>man</code> page and found that we can disable a service by using the <code>unload</code> command, for example:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> launchctl unload </span><span class="token parameter variable" style="color:#36acaa">-w</span><span class="token plain"> com.apple.corespeechd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>That looked great! The <code>corespeechd</code> daemon was no longer running and my CPU was back to normal consumption. Unfortunately, I realized my celebrations were premature when I restarted my machine. <code>corespeechd</code> was back up and feasting on my machine resources again.</p>
<p>I went back to the <code>launchctl man</code> page and found that there was another option, <code>remove</code>, that could do the trick as it seemed to perform a persistent disabling of services (unlike the <code>unload</code> operation which was temporary until system restart relaunched all daemons). The problem was that I was unable to run the command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> launchctl remove com.apple.corespeechd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>because the operating system had <a href="https://support.apple.com/en-us/HT204899" target="_blank" rel="noopener noreferrer">System Integrity Protection (SIP)</a> enabled. I found that I could use the csrutil command-line tool to interact with SIP. To interact with SIP, we need to go into Recovery Mode.</p>
<p>tl;dr ,these are the steps I took to completely disable <code>corespeechd</code>:</p>
<ol>
<li>Reboot the machine.</li>
<li>Press and hold <code>Command + R</code>.</li>
<li>Once the Recovery menu loads up, in the top menu bar, select <code>Utilities &gt; Terminal</code>.</li>
<li>Run the following command to disable System Integrity Protection (SIP):</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">csrutil disable</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>Reboot the machine.</li>
<li>Press and hold Command + R.</li>
<li>Once the Recovery menu loads up, in the top menu bar, select Utilities &gt; Terminal.</li>
<li>Run the following command to disable System Integrity Protection (SIP):</li>
</ol>
<p>You should see the following message to acknowledge that SIP was actually disabled:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">System Integrity Protection status: disabled.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>Reboot the machine.</li>
<li>When OS loads, open a Terminal and run the following command to disable <code>corespeechd</code> daemon:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> launchctl remove com.apple.corespeechd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see that corespeechd daemon is no longer running and consuming massive CPU!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/apple">apple</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/corespeechd">corespeechd</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cpu">cpu</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/debugging">debugging</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/macos">macos</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/prod-down-mongodb-corrupt-heketi-glusterfs-provisioning">Fixing Production Down caused by MongoDB Corruption and Heketi/GlusterFS Failed Provisioning</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-09-26T20:02:05.000Z">September 26, 2024</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/kbbgl" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/14372649" alt="Kobbi Gal"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/kbbgl" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Kobbi Gal</span></a></div><small class="authorTitle_nd0D" title="I like to pick things apart and see how they work inside">I like to pick things apart and see how they work inside</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>Today I received an escalation from one of our largest and most strategic customers. Over the weekend, the customer had ‘patched’ their 3 Ubuntu 18.04 nodes running Kubernetes 1.17.  They were using <a href="https://www.gluster.org/" target="_blank" rel="noopener noreferrer"><code>glusterfs</code></a> as their shared storage class.
I was trying to figure out what this ‘patching’ job entailed so we could assess which step of the maintenance to focus on but could not get all the necessary details from the customer support team except for the following order of operations:</p>
<ol>
<li>They ran <code>kubectl drain</code> to prepare their 3 nodes for the patching. This ensured that all <code>Pods</code> would get evicted, including all persistent storage and services.</li>
<li>They ran kernel updates to patch security vulnerabilities.</li>
<li>They upgraded Ubuntu packages using <code>apt update&amp;&amp;apt upgrade</code>.</li>
<li>They restarted all their servers and ran <code>kubectl uncordon</code>.</li>
</ol>
<p>After they finished this maintenance job, their application was no longer loading.
They had not taken any snapshots of the system before running this ‘patch’ job so we had to figure out why the application was not available.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="salvaging-mongodb">Salvaging MongoDB<a href="#salvaging-mongodb" class="hash-link" aria-label="Direct link to Salvaging MongoDB" title="Direct link to Salvaging MongoDB">​</a></h2>
<p>I invited the customer to join me on a conference call so I could take a look and gather preliminary information about why the application is not running.
What I noticed when running <code>kubectl get pods</code> was that all the services were stuck on <code>Init 0/1</code>, which indicated that the execution of the first <code>initContainer</code> was terminating with non-zero return codes. All <code>initContainer</code>s were failing their connection to MongoDB as we can see from the spec of one of the <code>Pods</code> which was stuck on <code>Init</code>:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Init Containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  init</span><span class="token punctuation" style="color:#393A34">-</span><span class="token key atrule" style="color:#00a4db">mongodb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">         busybox</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.30.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      until nc </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zv mongodb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service.prod 27017; do echo waiting for mongodb; sleep 2; done;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It was pretty evident that the MongoDB service was the cause for the dependent application services inability to initialize because we saw that all 3 replica set member’s <code>Pod</code>s were in <code>Init: CrashLoopBackOff</code> state.</p>
<p>We needed to understand which <code>initContainer</code> of MongoDB was crashing. We were able to figure out why using <code>kubectl describe pod mongodb-replicaset-0</code> and <code>kubectl logs mongodb-replicaset-0 --all-containers</code>.
When running <code>kubectl describe pod mongodb-replicaset-0</code> we saw that the failing <code>initContainer</code> was one called <code>bootstrap</code>:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Init Containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">bootstrap</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">         mongo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">3.6.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /work</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dir/peer</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">finder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">on</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">start=/init/on</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">start.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service=mongodb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">replicaset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      REPLICA_SET</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    rs0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TIMEOUT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">900</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This container is a simple peer finder daemon that is useful with <code>StatefulSet</code> and related use cases.
All it does is watch DNS for changes in the set of endpoints that are part of the governing service. It periodically looks up the SRV record of the DNS entry that corresponds to a Kubernetes Service which enumerates the set of peers for this the specified service. Not really helpful. So we needed to review the logs and find out what’s causing this container to fail.</p>
<p>When we ran <code>kubectl logs mongod-replicaset-0 --all-containers</code> we noticed the following error:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">E STORAGE  WiredTiger error, file:WiredTiger.wt, connection: unable to read root page from file:WiredTiger.wt: WT_ERROR: non-specific WiredTiger error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E STORAGE  WiredTiger error, file:WiredTiger.wt, connection: WiredTiger has failed to open its metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E STORAGE  WiredTiger error, file:WiredTiger.wt, connection: This may be due to the database files being encrypted, being from an older version or due to corruption on disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E STORAGE  WiredTiger error, file:WiredTiger.wt, connection: You should confirm that you have opened the database with the correct options including all encryption and compression options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E -        WT_ERROR: non-specific WiredTiger error src\mongo\db\storage\wiredtiger\wiredtiger_kv_engine.cpp 397</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I STORAGE  WT_ERROR: non-specific WiredTiger error, terminating</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The log that immediately grabbed our attention was the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">E STORAGE  WiredTiger error, file:WiredTiger.wt, connection: This may be due to the database files being encrypted, being from an older version or due to corruption on disk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Although we did not have any incriminating evidence, we were pretty sure that the server patching likely caused some data disk corruption because of an unclean shutdown of the MongoDB service.
At this point we were facing a few of problems:</p>
<ol>
<li>We could not create a mongodump since the MongoDB server was not running and the <code>initContainers</code> were in a <code>CrashLoopBackOff</code>.</li>
<li>We did not have the necessary tools on the production environment since we could not install any additional sidecar containers or utilities.</li>
<li>As mentioned earlier, we did not have a snapshot of the server in a working state or a <code>mongodump</code> to rely on so we needed to figure out a way to fix this corrupted state somehow.</li>
</ol>
<p>Luckily, the environment did have a <code>Deployment</code> called <code>system-recovery</code> which allowed us access to the mounted storage points so we could access the MongoDB flat files. We could then take these flat files, compress them and transfer them to our lab environment to attempt recovery:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl scale deployment system-recovery </span><span class="token parameter variable" style="color:#36acaa">--replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/system-recovery scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> system-recovery-4184bfa40da-sah4131:/mongodb0 /tmp/mongodb0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> czvf /tmp/mongodb0.tar.gz /tmp/mongodb0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In our lab, we attempted to load MongoDB with the <code>--repair</code> flag but saw that it was failing with the same error we saw earlier on the production environment:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> mongod </span><span class="token parameter variable" style="color:#36acaa">--version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3.6</span><span class="token plain">.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> mongod </span><span class="token parameter variable" style="color:#36acaa">--dbpath</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/mongodb0 </span><span class="token parameter variable" style="color:#36acaa">--repair</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E STORAGE  WiredTiger error, file:WiredTiger.wt, connection: This may be due to the database files being encrypted, being from an older version or due to corruption on disk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We found out, after further research, that <a href="https://jira.mongodb.org/browse/SERVER-19815" target="_blank" rel="noopener noreferrer">MongoDB version 4 had a more robust repairing mechanism of corrupted WiredTiger schemas</a>. So we installed MongoDB 4 in our lab environment and reran the same repair:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> mongod </span><span class="token parameter variable" style="color:#36acaa">--version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4.2</span><span class="token plain">.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> mongod </span><span class="token parameter variable" style="color:#36acaa">--dbpath</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/mongodb0 </span><span class="token parameter variable" style="color:#36acaa">--repair</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We received a message that the operation was successful!
So now that we had a repaired MongoDB, we wanted to create a <code>mongodump</code> and then attempt to load the database in the lab environment to check whether the dependent Pods will successfully load which would mean that the application would load as well.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mongodb-version-conflict">MongoDB Version Conflict<a href="#mongodb-version-conflict" class="hash-link" aria-label="Direct link to MongoDB Version Conflict" title="Direct link to MongoDB Version Conflict">​</a></h2>
<p>Earlier, When attempting to repair the MongoDB, we needed to run the MongoDB server with version 4+ because of the new repair mechanism offered. The actual data which we extracted from the production environment was from version 3.6.8. We didn’t think this would be a problem until we actually attempted to load the database in order to generate a <code>mongodump</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> mongod </span><span class="token parameter variable" style="color:#36acaa">--version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3.6</span><span class="token plain">.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> mongod </span><span class="token parameter variable" style="color:#36acaa">--dbpath</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/mongodb0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Found an invalid featureCompatibilityVersion document </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ERROR: BadValue: Invalid value </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> version, found </span><span class="token number" style="color:#36acaa">3.6</span><span class="token plain">, expected </span><span class="token string" style="color:#e3116c">&#x27;4.2&#x27;</span><span class="token plain"> or </span><span class="token string" style="color:#e3116c">&#x27;4.0&#x27;</span><span class="token builtin class-name">.</span><span class="token plain"> Contents of featureCompatibilityVersion document </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> admin.system.version: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> _id: </span><span class="token string" style="color:#e3116c">&quot;featureCompatibilityVersion&quot;</span><span class="token plain">, version: </span><span class="token string" style="color:#e3116c">&quot;3.6&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">. See http://dochub.mongodb.org/core/4.0-feature-compatibility.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">. If the current featureCompatibilityVersion is below </span><span class="token number" style="color:#36acaa">4.0</span><span class="token plain">, see the documentation on upgrading at </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We were now blocked because MongoDB server and the actual data were different versions. We could not run the command:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setFeatureCompatibility</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> version</span><span class="token string" style="color:#e3116c">&quot;3.6&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>as suggested by a few different StackOverflow articles and MongoDB official documentation since we would need to be able to run the database.</p>
<p>This was really bad news since we did not know where this feature flag was actually stored, whether it was stored in clear text and if it was accessible. We decided to run a quick search within all the flat files in the MongoDB directory. It was a shot in the dark but we didn’t really have any other options at this point.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-rnwi</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;compatibility&quot;</span><span class="token plain"> ./mongodb0/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WiredTiger.turtle:1:Compatibility version</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We managed to find something interesting within the WiredTiger.turtle file which was clear text. The whole file contents looked like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Compatibility version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">major=4,minor=2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WiredTiger version string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WiredTiger 4.2.1: (September 15, 2019)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WiredTiger version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">major=4,minor=2,patch=1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Since we were in dire straits, we decided it was worth to modify the versions in this file and see if we could work around the MongoDB server validation. We modified it to the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Compatibility version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">major=3,minor=6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WiredTiger version string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WiredTiger 3.6.8: (July 12, 2018)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WiredTiger version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">major=3,minor=6,patch=8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Miraculously, when running MongoDB daemon again, we were able to load the database and the application! We created a dump file using <code>mongodump</code> and transferred it to the production environment.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="fixing-unhealthy-glusterfsheketi">Fixing Unhealthy GlusterFS/Heketi<a href="#fixing-unhealthy-glusterfsheketi" class="hash-link" aria-label="Direct link to Fixing Unhealthy GlusterFS/Heketi" title="Direct link to Fixing Unhealthy GlusterFS/Heketi">​</a></h2>
<p>We reconnected to the production environment, transferred the repaired and generated <code>mongodump</code> and we needed to somehow restore it onto the shared storage. We saw three possible ways of performing this:</p>
<ol>
<li>Modify the MongoDB <code>StateFulSet</code> specification by changing the executed commands to something like an infinite sleep so that the <code>bootstrap</code> <code>initContainer</code> would not terminate. This would allow us to copy the <code>mongodump</code> into the container and run <code>mongorestore</code> to load the repaired databased and ensure it’s replicated across all GlusterFS storage locations. This was the preferred option.</li>
<li>Replace all MongoDB flat files manually within each one of the GlusterFS shared storage locations. This would not be ideal since it would go against MongoDB replication best practices.</li>
<li>Removing all GlusterFS <code>PersistentVolumeClaims</code>, recreate them from scratch and then bind them to the MongoDB replica set members.</li>
</ol>
<p>After reviewing all three options, we decided to go with the 3rd approach. It was decided as the best option after consulting with our DevOps because they mentioned that they have set up dynamic storage allocation upon removal of the GlusterFS <code>PersistenVolumeClaims</code> and restart of the MongoDB <code>StateFulSet</code> <code>Pod</code>s.
The first step would be to delete the <code>PersistentVolumeClaims</code>. So we went to work.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl delete pvc datadir-mongodb-replicaset-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl delete pvc datadir-mongodb-replicaset-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl delete pvc datadir-mongodb-replicaset-2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>But we noticed that these pvcs were stuck on Terminating. We even attempted to force delete them but they were still stuck:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl delete pvc datadir-mongodb-replicaset-0 </span><span class="token parameter variable" style="color:#36acaa">--force</span><span class="token plain"> --grace-period </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After some research, we found out that these PersistentVolumeClaim specs had <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#finalizers" target="_blank" rel="noopener noreferrer"><code>finalizers</code></a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl describe pvc datadir-mongodb-replicaset-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:          datadir-mongodb-replicaset-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:     prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StorageClass:  gluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status:        Bound</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Volume:        pvc-64340467-8109-4856-9a49-2fc36563e9ab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:        </span><span class="token assign-left variable" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">mongodb-replicaset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:   pv.kubernetes.io/bind-completed: </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               pv.kubernetes.io/bound-by-controller: </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               volume.beta.kubernetes.io/storage-provisioner: kubernetes.io/glusterfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Finalizers:    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubernetes.io/pvc-protection</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Capacity:      150Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access Modes:  RWO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VolumeMode:    Filesystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Mounted By:    mongodb-replicaset-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Events:        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We edited the <code>PVC</code>s with:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl edit pvc datadir-mongodb-replicaset-0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>removed the <code>finalizer</code> section and reran the <code>kubectl delete pvc</code> commands. This resulted in a successful deletion. We then deleted the MongoDB <code>StateFulSet</code> to generate the <code>PVC</code>s using <code>kubectl delete pod mongodb-replicaset-{0,1,2}</code>. But to our surprise, the <code>PVC</code> and the <code>Pod</code>s were stuck <code>Pending</code>. Something was preventing the dynamic <code>PVC</code> allocation.</p>
<p>When we ran <code>kubectl describe pvc datadir-mongodb-replicaset-0</code> we saw that there was an <code>Event</code> with <code>ProvisioningFailed</code> with the following error message:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl describe pvc datadir-mongodb-replicaset-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Failed to provision volume with StorageClass </span><span class="token string" style="color:#e3116c">&quot;gluster&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> failed to create volume.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The error message was far from informative so we needed to step back and review the state of <code>heketi</code> and <code>glusterfs</code>. We noticed that neither the <code>glusterfs</code> or the <code>heketi</code> <code>Pod</code>s had any logs from standard output and all of them, according to <code>kubectl get pods -n storage</code>, were in healthy, <code>Running</code> state.</p>
<p>We decided it would be best to use the <code>gluster</code> CLI and try to troubleshoot why the provisioning is failing. Luckily, the issue was pretty easy to find. We accessed the <code>glusterfs</code> Pod and ran the following command to check the status of <code>heketidbstorage</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> glusterfs-k96d2 </span><span class="token parameter variable" style="color:#36acaa">-it</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ec2-user@node1 /</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> gluster volume status heketidbstorage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status of volume: heketidbstorage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Gluster process TCP Port RDMA Port Online Pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Brick node1:/var/lib/heketi/mounts/vg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_4a5d18544111232fc76cdc9872d340d6/brick_75c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ec7af846fbf2e770b9312c6bc56fe/brick </span><span class="token number" style="color:#36acaa">49152</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> N </span><span class="token number" style="color:#36acaa">198</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Brick node2:/var/lib/heketi/mounts/vg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_3cf3e12449047bba9b1260d301914187/brick_3ea</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">27507e65df9ec9a4c0841d27962f9/brick </span><span class="token number" style="color:#36acaa">49153</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> N </span><span class="token number" style="color:#36acaa">198</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Brick node3:/var/lib/heketi/mounts/vg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_78c5285b77bde0e7ed344df72ef5c630/brick_d54</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3d1ea6e83036e7796a89b1594f4cc/brick </span><span class="token number" style="color:#36acaa">49152</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> N </span><span class="token number" style="color:#36acaa">186</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Self-heal Daemon on localhost N/A N/A Y </span><span class="token number" style="color:#36acaa">177</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Self-heal Daemon on node1 N/A N/A Y </span><span class="token number" style="color:#36acaa">183</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Self-heal Daemon on node1 N/A N/A Y </span><span class="token number" style="color:#36acaa">189</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We noticed that none of the bricks on <code>node{1,2,3}</code> were online so we decided to restart it:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gluster volume stop heketidbstorage </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gluster volume start heketidbstorage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This resulted in all bricks on all nodes getting back online, released the GlusterFS <code>PVC</code> provisioning and allowed all MongoDB replicaset member <code>Pod</code>s to initialize successfully!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="restoring-mongodb-and-the-application">Restoring MongoDB and the Application<a href="#restoring-mongodb-and-the-application" class="hash-link" aria-label="Direct link to Restoring MongoDB and the Application" title="Direct link to Restoring MongoDB and the Application">​</a></h2>
<p>At this point, 3 intense and excruciating hours have passed, we had gone through a set a complex problems and we were all hoping that the last phase would result in a recovery of the MongoDB and the application.
We had the GlusterFS <code>PVC</code> provisioned, we had all 3 MongoDB replica set <code>Pod</code>s up. All that was left was to:</p>
<ol>
<li>
<p>Copy the <code>mongodump</code> from the host machine to the master MongoDB replica set:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Find out who is the master</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> mongodb-replicaset-0 </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> mongodb-replicaset -- mongo </span><span class="token parameter variable" style="color:#36acaa">--eval</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;db.isMaster().primary&#x27;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--quiet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mongodb-replicaset-0.mongodb-replicaset.svc.cluster.local:27017</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Copy the mongodump into the master Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> /tmp/mongodb0/mongodump mongodb-replicaset-0 </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> mongodb-replicaset:/tmp/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Run <code>mongorestore</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Restore the database</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> mongodb-replicaset-0 </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> mongodb-replicaset -- mongorestore </span><span class="token parameter variable" style="color:#36acaa">-d</span><span class="token plain"> prod </span><span class="token parameter variable" style="color:#36acaa">--drop</span><span class="token plain"> /tmp/mongodump/prod</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Clear cache by deleting all <code>Pod</code>s in the application namespace:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl delete pod </span><span class="token parameter variable" style="color:#36acaa">--all</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> prod</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<p>Voila! All Pods started successfully and the application was loading again!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cluster">cluster</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/gluster">gluster</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/glusterfs">glusterfs</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/heketi">heketi</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/kubectl">kubectl</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/kubernetes">kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mongo">mongo</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mongodb">mongodb</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/production">production</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/troubleshooting">troubleshooting</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog"><div class="pagination-nav__label">Newer entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Knowledgebase</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Knowledgebase</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/hack_blog">Hack Blog</a></li><li class="footer__item"><a href="https://github.com/kbbgl" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Kobbi's Knowledgebase, Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>