"use strict";(globalThis.webpackChunkkgkb=globalThis.webpackChunkkgkb||[]).push([[59157],{83290:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>i,contentTitle:()=>r,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>c});var a=s(74848),l=s(28453);const t={slug:"how-to-deploy-k8s-svcs-using-aws-lbc-gw-api",title:"Hot to Deploy Kubernetes Services using Gateway API/AWS Load Balancer Controller",description:"Hot to Deploy Kubernetes Services using Gateway API/AWS Load Balancer Controller",authors:["kgal-akl"],tags:["k8s","kubernetes","gateway","api","aws","load_balancer"]},r=void 0,o={permalink:"/blog/how-to-deploy-k8s-svcs-using-aws-lbc-gw-api",source:"@site/blog/how-to-deploy-k8s-svcs-using-aws-lbc-gw-api.md",title:"Hot to Deploy Kubernetes Services using Gateway API/AWS Load Balancer Controller",description:"Hot to Deploy Kubernetes Services using Gateway API/AWS Load Balancer Controller",date:"2026-02-17T21:19:03.000Z",tags:[{inline:!1,label:"K8s",permalink:"/blog/tags/k-8-s"},{inline:!1,label:"Kubernetes",permalink:"/blog/tags/kubernetes"},{inline:!0,label:"gateway",permalink:"/blog/tags/gateway"},{inline:!0,label:"api",permalink:"/blog/tags/api"},{inline:!0,label:"aws",permalink:"/blog/tags/aws"},{inline:!0,label:"load_balancer",permalink:"/blog/tags/load-balancer"}],readingTime:8.655,hasTruncateMarker:!1,authors:[{name:"Kobbi Gal (Akeyless)",title:"Escalations Engineer at Akeyless",url:"https://github.com/kgal-akl",imageURL:"https://avatars.githubusercontent.com/u/195813801",key:"kgal-akl",page:null}],frontMatter:{slug:"how-to-deploy-k8s-svcs-using-aws-lbc-gw-api",title:"Hot to Deploy Kubernetes Services using Gateway API/AWS Load Balancer Controller",description:"Hot to Deploy Kubernetes Services using Gateway API/AWS Load Balancer Controller",authors:["kgal-akl"],tags:["k8s","kubernetes","gateway","api","aws","load_balancer"]},unlisted:!1,prevItem:{title:"Hack The Box \u2018Archetype\u2019 Challenge",permalink:"/blog/hack-the-box-archetype-challenge"},nextItem:{title:"How To Set Up Split Tunneling with VPN",permalink:"/blog/how-to-set-up-split-tunneling"}},i={authorsImageUrls:[void 0]},c=[{value:"Environment",id:"environment",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Files",id:"files",level:2},{value:"Deployment",id:"deployment",level:2},{value:"1. Set Convenience Variables",id:"1-set-convenience-variables",level:3},{value:"2. Install Gateway API CRDs and AWS LBC Gateway CRDs",id:"2-install-gateway-api-crds-and-aws-lbc-gateway-crds",level:3},{value:"3. Install / upgrade AWS Load Balancer Controller (Helm)",id:"3-install--upgrade-aws-load-balancer-controller-helm",level:3},{value:"4. Apply LBC <code>LoadBalancerConfiguration</code>, <code>GatewayClass</code>, and <code>Gateway</code>",id:"4-apply-lbc-loadbalancerconfiguration-gatewayclass-and-gateway",level:3},{value:"5. Deploy LDAP + SSH Workloads and <code>NodePort</code> Services",id:"5-deploy-ldap--ssh-workloads-and-nodeport-services",level:3},{value:"6. Create <code>TCPRoute</code>s to attach Services to Gateway listeners",id:"6-create-tcproutes-to-attach-services-to-gateway-listeners",level:3},{value:"7. Verify AWS Resources (listeners + target groups + health)",id:"7-verify-aws-resources-listeners--target-groups--health",level:3},{value:"8. Validate <code>NodePorts</code> locally on the EC2 node (via SSH)",id:"8-validate-nodeports-locally-on-the-ec2-node-via-ssh",level:3},{value:"9. (Recommended) NLB cross-zone + subnet/AZ notes for single-node clusters",id:"9-recommended-nlb-cross-zone--subnetaz-notes-for-single-node-clusters",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"A) Gateway has an address, but NLB has <strong>no listeners</strong>",id:"a-gateway-has-an-address-but-nlb-has-no-listeners",level:3},{value:"B) Confirm <code>TCPRoute</code> attachment and backend resolution",id:"b-confirm-tcproute-attachment-and-backend-resolution",level:3},{value:"C) Verify Services/EndpointSlices",id:"c-verify-servicesendpointslices",level:3},{value:"D) Inspect AWS listeners / target groups / target health",id:"d-inspect-aws-listeners--target-groups--target-health",level:3},{value:"E) Security groups (NodePort/instance targets)",id:"e-security-groups-nodeportinstance-targets",level:3},{value:"F) Subnets / AZ mismatch",id:"f-subnets--az-mismatch",level:3},{value:"G) Multi-AZ NLB resolves to multiple IPs (some work, some time out)",id:"g-multi-az-nlb-resolves-to-multiple-ips-some-work-some-time-out",level:3},{value:"Notes / gotchas",id:"notes--gotchas",level:3}];function d(e){const n={admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.p,{children:["This tutorial contains a working example of exposing ",(0,a.jsx)(n.strong,{children:"TCP services"})," (LDAP/LDAPS + SSH) from a ",(0,a.jsx)(n.strong,{children:"single-node k3s"})," cluster running on an EC2 instance, using:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.strong,{children:"Kubernetes Gateway API"})}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"AWS Load Balancer Controller (LBC)"})," for:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"NLB"})," (L4) via ",(0,a.jsx)(n.code,{children:"TCPRoute"})]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"ALB"})," (L7) via ",(0,a.jsx)(n.code,{children:"HTTPRoute"}),"/",(0,a.jsx)(n.code,{children:"GRPCRoute"})," (example file included)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["The key implementation detail for k3s-on-EC2 with the default overlay networking (flannel): ",(0,a.jsxs)(n.strong,{children:["use ",(0,a.jsx)(n.code,{children:"instance"})," targets + NodePorts"]})," for L4 routes. ClusterIP + pod IP targets won\u2019t work unless pods are VPC-routable (AWS VPC CNI)."]}),"\n",(0,a.jsx)(n.h2,{id:"environment",children:"Environment"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Node OS"}),": Ubuntu 24.04.4 LTS"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Kernel"}),": 6.14.0-1018-aws"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"k3s / server"}),": v1.33.4+k3s1"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"containerd"}),": 2.0.5-k3s2"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"kubectl client"}),": v1.35.0 (warning: > +/-1 minor skew vs server)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Gateway API"}),": 1.3.0"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"AWS Load Balancer Controller"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Helm chart"}),": ",(0,a.jsx)(n.code,{children:"aws-load-balancer-controller-3.0.0"})," (app version v3.0.0)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Controller image"}),": ",(0,a.jsx)(n.code,{children:"public.ecr.aws/eks/aws-load-balancer-controller:v2.17.0"})]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Flags"}),":","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"--feature-gates=ALBGatewayAPI=true,NLBGatewayAPI=true"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"--enable-manage-backend-security-group-rules=true"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["An EC2 instance with k3s installed and reachable via SSH (example host alias: ",(0,a.jsx)(n.code,{children:"$DOMAIN_NAME"}),")"]}),"\n",(0,a.jsxs)(n.li,{children:["AWS credentials able to create/modify:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"ELBv2 load balancers/listeners/target groups"}),"\n",(0,a.jsx)(n.li,{children:"EC2 security groups and tags"}),"\n",(0,a.jsx)(n.li,{children:"(plus whatever IAM is required by the controller)"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"kubectl"}),", ",(0,a.jsx)(n.code,{children:"helm"}),", ",(0,a.jsx)(n.code,{children:"aws"})," CLI installed locally"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"files",children:"Files"}),"\n",(0,a.jsx)(n.p,{children:"Gateway API standard CRDs:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"wget --output-document standard_crds_1.3.0.yaml https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.3.0/standard-install.yam\n"})}),"\n",(0,a.jsx)(n.p,{children:"Gateway API experimental CRDs (needed for some L4 routes depending on version)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"wget --output-document experimental_crds_1.3.0.yaml https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.3.0/experimental-install.yaml\n"})}),"\n",(0,a.jsxs)(n.p,{children:["AWS LBC Gateway API CRDs (",(0,a.jsx)(n.code,{children:"gateway.k8s.aws/*"}),"):"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"wget --output-document aws_lbc_gateway-crds_3.0.yaml https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/refs/heads/release-3.0/config/crd/gateway/gateway-crds.yaml\n"})}),"\n",(0,a.jsx)(n.p,{children:"Helm values used to install/upgrade AWS LBC:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"helm show values eks/aws-load-balancer-controller > aws-lbc.yaml\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"GatewayClasses"})," definitions for both the ALB and NLB:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="00-gatewayclasses.yaml"',children:'apiVersion: "gateway.networking.k8s.io/v1"\nkind: GatewayClass\nmetadata: \n  name: aws-lbc-alb\nspec:\n  controllerName: gateway.k8s.aws/alb\n  parametersRef:\n    group: gateway.k8s.aws\n    kind: LoadBalancerConfiguration\n    name: alb-public-config\n    namespace: default\n---\napiVersion: "gateway.networking.k8s.io/v1"\nkind: GatewayClass\nmetadata: \n  name: aws-lbc-nlb\nspec:\n  controllerName: gateway.k8s.aws/nlb\n  parametersRef:\n    group: gateway.k8s.aws\n    kind: LoadBalancerConfiguration\n    name: nlb-public-config\n    namespace: default\n'})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"LoadBalancerConfiguration"})," for public ALB and NLB:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="12-lb-public-lbc.yaml"',children:'apiVersion: gateway.k8s.aws/v1beta1\nkind: LoadBalancerConfiguration\nmetadata:\n  name: alb-public-config\n  namespace: default\nspec:\n  scheme: internet-facing\n  loadBalancerSubnets:\n    - identifier: subnet-1\n    - identifier: subnet-2\n---\napiVersion: gateway.k8s.aws/v1beta1\nkind: LoadBalancerConfiguration\nmetadata:\n  name: nlb-public-config\n  namespace: default\nspec:\n  scheme: internet-facing\n  loadBalancerAttributes:\n    - key: load_balancing.cross_zone.enabled\n      value: "true"\n  loadBalancerSubnets:\n    - identifier: subnet-3\n    - identifier: subnet-4\n    - identifier: subnet-5\n'})}),"\n",(0,a.jsxs)(n.p,{children:["ALB HTTP 443 ",(0,a.jsx)(n.code,{children:"Gateway"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="10-gateway-alb.yaml"',children:'apiVersion: "gateway.networking.k8s.io/v1"\nkind: Gateway\nmetadata:\n  name: public-alb-gw\n  namespace: default\nspec:\n  gatewayClassName: aws-lbc-alb\n  listeners:\n    - name: https\n      protocol: HTTPS\n      port: 443\n      hostname: "*.$DOMAIN_NAME"\n      tls:\n        mode: Terminate\n        certificateRefs:\n          - kind: Secret\n            group: ""\n            name: tls-$DOMAIN_NAME-crt\n      allowedRoutes:\n        namespaces:\n          from: All\n'})}),"\n",(0,a.jsxs)(n.admonition,{type:"note",children:[(0,a.jsxs)(n.p,{children:["You need to make sure that there's a TLS secret named ",(0,a.jsx)(n.code,{children:"tls-$DOMAIN_NAME-crt"})," as referenced by the Gateway that has SAN that includes the hostname provided above. To create it:"]}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl create secret tls tls-$DOMAIN_NAME-crt --cert=$DOMAIN_NAME.crt.pem --key=deploy/ingress/certs/$DOMAIN_NAME.key.pem -n default\n"})})]}),"\n",(0,a.jsxs)(n.p,{children:["NLB TCP 636 and 2222 ",(0,a.jsx)(n.code,{children:"Gateway"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="11-gateway-nlb.yaml"',children:'apiVersion: "gateway.networking.k8s.io/v1"\nkind: Gateway\nmetadata:\n  name: public-nlb-gw\n  namespace: default\nspec:\n  gatewayClassName: aws-lbc-nlb\n  listeners:\n    - name: ldaps\n      protocol: TCP\n      port: 636\n      allowedRoutes:\n        namespaces:\n          from: All\n\n    - name: ssh\n      protocol: TCP\n      port: 2222\n      allowedRoutes:\n        namespaces:\n          from: All\n'})}),"\n",(0,a.jsxs)(n.p,{children:["LDAP ",(0,a.jsx)(n.code,{children:"TCPRoute"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="20-route-ldap-tcp.yaml"',children:'apiVersion: "gateway.networking.k8s.io/v1alpha2"\nkind: TCPRoute\nmetadata:\n  name: ldap-ldaps-route\n  namespace: ldap\nspec:\n  parentRefs:\n    - name: public-nlb-gw\n      namespace: default\n      sectionName: ldaps\n  rules:\n    - backendRefs:\n      - name: ldap\n        port: 636\n'})}),"\n",(0,a.jsxs)(n.p,{children:["SSH ",(0,a.jsx)(n.code,{children:"TCPRoute"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="21-route-ssh-tcp.yaml"',children:'apiVersion: "gateway.networking.k8s.io/v1alpha2"\nkind: TCPRoute\nmetadata:\n  name: ssh-tcp-route\n  namespace: ssh\nspec:\n  parentRefs:\n    - name: public-nlb-gw\n      namespace: default\n      sectionName: ssh\n  rules:\n    - backendRefs:\n        - name: ssh\n          port: 2222\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Example ",(0,a.jsx)(n.code,{children:"HTTPRoute"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="30-route-http-example.yaml"',children:"# 30-route-http-example.yaml (optional example)\n# Replace namespace/service/port with your actual HTTP app\napiVersion: gateway.networking.k8s.io/v1\nkind: HTTPRoute\nmetadata:\n  name: example-web-route\n  namespace: default\nspec:\n  parentRefs:\n    - name: public-alb-gw\n      namespace: default\n      sectionName: https\n  hostnames:\n    - app.$DOMAIN_NAME\n  rules:\n    - backendRefs:\n        - name: example-web-svc\n          port: 80\n"})}),"\n",(0,a.jsx)(n.h2,{id:"deployment",children:"Deployment"}),"\n",(0,a.jsx)(n.h3,{id:"1-set-convenience-variables",children:"1. Set Convenience Variables"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"AWS_PROFILE=dev\nAWS_REGION=$AWS_REGION\n"})}),"\n",(0,a.jsx)(n.h3,{id:"2-install-gateway-api-crds-and-aws-lbc-gateway-crds",children:"2. Install Gateway API CRDs and AWS LBC Gateway CRDs"}),"\n",(0,a.jsx)(n.p,{children:"Apply the CRDs from this directory:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f standard_crds_1.3.0.yaml\nkubectl apply -f experimental_crds_1.3.0.yaml\nkubectl apply -f aws_lbc_gateway-crds_3.0.yaml\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Verify the ",(0,a.jsx)(n.code,{children:"TCPRoute"})," CRD is present and served:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl get crd tcproutes.gateway.networking.k8s.io\nkubectl get crd tcproutes.gateway.networking.k8s.io -o jsonpath='{.spec.versions[*].name}{\"\\n\"}'\n"})}),"\n",(0,a.jsx)(n.h3,{id:"3-install--upgrade-aws-load-balancer-controller-helm",children:"3. Install / upgrade AWS Load Balancer Controller (Helm)"}),"\n",(0,a.jsxs)(n.p,{children:["This repo uses the EKS chart with explicit values in ",(0,a.jsx)(n.code,{children:"aws-lbc.yaml"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"helm repo add eks https://aws.github.io/eks-charts\nhelm repo update\n\nhelm upgrade --install aws-lbc eks/aws-load-balancer-controller \\\n  -n kube-system \\\n  -f aws-lbc.yaml \\\n  --version 3.0.0\n"})}),"\n",(0,a.jsx)(n.p,{children:"Confirm the controller flags include the Gateway API feature gates:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl  -n kube-system get deploy aws-lbc-aws-load-balancer-controller \\\n  -o jsonpath='{.spec.template.spec.containers[0].args}{\"\\n\"}'\n"})}),"\n",(0,a.jsx)(n.p,{children:"You should see:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"--feature-gates=ALBGatewayAPI=true,NLBGatewayAPI=true"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"For k3s/flannel + NLB instance targets, it\u2019s helpful to also run:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"--enable-manage-backend-security-group-rules=true"})}),"\n"]}),"\n",(0,a.jsxs)(n.h3,{id:"4-apply-lbc-loadbalancerconfiguration-gatewayclass-and-gateway",children:["4. Apply LBC ",(0,a.jsx)(n.code,{children:"LoadBalancerConfiguration"}),", ",(0,a.jsx)(n.code,{children:"GatewayClass"}),", and ",(0,a.jsx)(n.code,{children:"Gateway"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f 12-lb-public-lbc.yaml\nkubectl apply -f 00-gatewayclasses.yaml\nkubectl apply -f 11-gateway-nlb.yaml\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Important bits from ",(0,a.jsx)(n.code,{children:"11-gateway-nlb.yaml"})," (listeners define the NLB ports):"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"spec:\n  gatewayClassName: aws-lbc-nlb\n  listeners:\n    - name: ldaps\n      protocol: TCP\n      port: 636\n    - name: ssh\n      protocol: TCP\n      port: 2222\n"})}),"\n",(0,a.jsx)(n.p,{children:"Verify the NLB Gateway gets an address:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'kubectl  -n default get gateway public-nlb-gw -o wide\nkubectl  -n default get gateway public-nlb-gw -o yaml | rg -n "addresses:|value:|listeners:|attachedRoutes" -n\n'})}),"\n",(0,a.jsxs)(n.h3,{id:"5-deploy-ldap--ssh-workloads-and-nodeport-services",children:["5. Deploy LDAP + SSH Workloads and ",(0,a.jsx)(n.code,{children:"NodePort"})," Services"]}),"\n",(0,a.jsxs)(n.p,{children:["For L4 NLB on k3s/flannel, ",(0,a.jsxs)(n.strong,{children:["Services must be ",(0,a.jsx)(n.code,{children:"NodePort"})]}),", because the controller will create ",(0,a.jsx)(n.strong,{children:"instance"})," target groups that point to the node\u2019s NodePorts."]}),"\n",(0,a.jsxs)(n.p,{children:["Important snippets (from ",(0,a.jsx)(n.code,{children:"../ldap/service.yaml"})," and ",(0,a.jsx)(n.code,{children:"../ssh/service.yaml"})," in this repo):"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"spec:\n  type: NodePort\n  ports:\n  - name: ldaps\n    port: 636\n    targetPort: 636\n    nodePort: 30636\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"spec:\n  type: NodePort\n  ports:\n  - name: ssh\n    port: 2222\n    targetPort: 2222\n    nodePort: 32222\n"})}),"\n",(0,a.jsx)(n.p,{children:"Apply your workloads/services (paths in this repo):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl  apply -f ../ldap/deployment.yaml\nkubectl  apply -f ../ldap/service.yaml\n\nkubectl  apply -f ../ssh/namespace.yaml\nkubectl  apply -f ../ssh/configmap.yaml\nkubectl  apply -f ../ssh/deployment.yaml\nkubectl  apply -f ../ssh/service.yaml\n"})}),"\n",(0,a.jsx)(n.p,{children:"Verify endpoints exist:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl  -n ldap get endpointslices -l kubernetes.io/service-name=ldap\nkubectl  -n ssh  get endpointslices -l kubernetes.io/service-name=ssh\n"})}),"\n",(0,a.jsxs)(n.h3,{id:"6-create-tcproutes-to-attach-services-to-gateway-listeners",children:["6. Create ",(0,a.jsx)(n.code,{children:"TCPRoute"}),"s to attach Services to Gateway listeners"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl  apply -f 20-route-ldap-tcp.yaml\nkubectl  apply -f 21-route-ssh-tcp.yaml\n"})}),"\n",(0,a.jsx)(n.p,{children:"Important route bits:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"spec:\n  parentRefs:\n    - name: public-nlb-gw\n      namespace: default\n      sectionName: ldaps   # matches listener name\n  rules:\n    - backendRefs:\n      - name: ldap\n        port: 636\n"})}),"\n",(0,a.jsx)(n.p,{children:"Check route status:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl  -n ldap get tcproute ldap-ldaps-route -o yaml\nkubectl  -n ssh  get tcproute ssh-tcp-route -o yaml\n"})}),"\n",(0,a.jsxs)(n.p,{children:["You want ",(0,a.jsx)(n.code,{children:"status.parents[*].conditions"})," to include ",(0,a.jsx)(n.code,{children:"Accepted=True"})," and ",(0,a.jsx)(n.code,{children:"ResolvedRefs=True"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"7-verify-aws-resources-listeners--target-groups--health",children:"7. Verify AWS Resources (listeners + target groups + health)"}),"\n",(0,a.jsx)(n.p,{children:"Get the NLB hostname from the Gateway:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl  -n default get gateway public-nlb-gw -o jsonpath='{.status.addresses[0].value}{\"\\n\"}'\n"})}),"\n",(0,a.jsx)(n.p,{children:"Resolve and test from your machine:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'NLB_HOST=$(kubectl -n default get gateway public-nlb-gw -o jsonpath=\'{.status.addresses[0].value}\')\ndig +short "$NLB_HOST"\nnc -G 2 -vz "$NLB_HOST" 636\nnc -G 2 -vz "$NLB_HOST" 2222\n'})}),"\n",(0,a.jsx)(n.p,{children:"Confirm listeners exist in AWS:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'aws elbv2 describe-listeners \\\n  --load-balancer-arn "arn:aws:elasticloadbalancing:$AWS_REGION:$AWS_ACCOUNT_ID:loadbalancer/net/<name>/<id>" \\\n  --profile "$AWS_PROFILE" --region "$AWS_REGION" --no-cli-pager\n'})}),"\n",(0,a.jsx)(n.p,{children:"List target groups and check target health:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'aws elbv2 describe-target-groups \\\n  --load-balancer-arn "arn:aws:elasticloadbalancing:$AWS_REGION:$AWS_ACCOUNT_ID:loadbalancer/net/<name>/<id>" \\\n  --profile "$AWS_PROFILE" --region "$AWS_REGION" --no-cli-pager\n\naws elbv2 describe-target-health \\\n  --target-group-arn "<target-group-arn>" \\\n  --profile "$AWS_PROFILE" --region "$AWS_REGION" --no-cli-pager\n'})}),"\n",(0,a.jsxs)(n.h3,{id:"8-validate-nodeports-locally-on-the-ec2-node-via-ssh",children:["8. Validate ",(0,a.jsx)(n.code,{children:"NodePorts"})," locally on the EC2 node (via SSH)"]}),"\n",(0,a.jsx)(n.p,{children:"This is a fast way to separate \u201cKubernetes service routing\u201d from \u201cAWS/NLB connectivity\u201d."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ssh $DOMAIN_NAME 'nc -vz -w 2 127.0.0.1 30636; nc -vz -w 2 127.0.0.1 32222'\n"})}),"\n",(0,a.jsx)(n.h3,{id:"9-recommended-nlb-cross-zone--subnetaz-notes-for-single-node-clusters",children:"9. (Recommended) NLB cross-zone + subnet/AZ notes for single-node clusters"}),"\n",(0,a.jsxs)(n.p,{children:["For a ",(0,a.jsx)(n.strong,{children:"single node in one AZ"}),", an internet-facing NLB in multiple AZs can resolve to IPs in AZs that have ",(0,a.jsx)(n.strong,{children:"no healthy targets"}),". You have two options:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Enable cross-zone load balancing"})," (recommended)"]}),"\n",(0,a.jsx)(n.li,{children:"Or constrain the NLB to only the node\u2019s subnet/AZ"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["This repo enables cross-zone in ",(0,a.jsx)(n.code,{children:"12-lb-public-lbc.yaml"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'spec:\n  loadBalancerAttributes:\n    - key: load_balancing.cross_zone.enabled\n      value: "true"\n'})}),"\n",(0,a.jsx)(n.p,{children:"Verify in AWS:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'aws elbv2 describe-load-balancer-attributes \\\n  --load-balancer-arn "<nlb-arn>" \\\n  --profile "$AWS_PROFILE" --region "$AWS_REGION" --no-cli-pager \\\n  --query \'Attributes[?Key==`load_balancing.cross_zone.enabled`]\'\n'})}),"\n",(0,a.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,a.jsx)(n.p,{children:"During the deployment, I found the following commands helpful to use troubleshoot what was wrong with the deployment:"}),"\n",(0,a.jsxs)(n.h3,{id:"a-gateway-has-an-address-but-nlb-has-no-listeners",children:["A) Gateway has an address, but NLB has ",(0,a.jsx)(n.strong,{children:"no listeners"})]}),"\n",(0,a.jsx)(n.p,{children:"Check controller logs; the exact message that pointed to the root cause was:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'kubectl  -n kube-system logs deploy/aws-lbc-aws-load-balancer-controller --since=2h | rg -n "Skipping listener creation|public-nlb-gw"\n'})}),"\n",(0,a.jsx)(n.p,{children:"If you see:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"Skipping listener creation due to no backend references"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"\u2026it usually means the controller couldn\u2019t materialize a usable backend (commonly: ClusterIP-only backends on overlay networking)."}),"\n",(0,a.jsxs)(n.h3,{id:"b-confirm-tcproute-attachment-and-backend-resolution",children:["B) Confirm ",(0,a.jsx)(n.code,{children:"TCPRoute"})," attachment and backend resolution"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl  -n ldap get tcproute ldap-ldaps-route -o yaml\nkubectl  -n ssh  get tcproute ssh-tcp-route -o yaml\nkubectl  -n default describe gateway public-nlb-gw\n"})}),"\n",(0,a.jsx)(n.h3,{id:"c-verify-servicesendpointslices",children:"C) Verify Services/EndpointSlices"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl  -n ldap get svc ldap -o yaml\nkubectl  -n ssh  get svc ssh  -o yaml\nkubectl  -n ldap get endpointslices -l kubernetes.io/service-name=ldap -o yaml\nkubectl  -n ssh  get endpointslices -l kubernetes.io/service-name=ssh  -o yaml\n"})}),"\n",(0,a.jsx)(n.h3,{id:"d-inspect-aws-listeners--target-groups--target-health",children:"D) Inspect AWS listeners / target groups / target health"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'aws elbv2 describe-listeners --load-balancer-arn "<nlb-arn>" --profile "$AWS_PROFILE" --region "$AWS_REGION" --no-cli-pager\naws elbv2 describe-target-groups --load-balancer-arn "<nlb-arn>" --profile "$AWS_PROFILE" --region "$AWS_REGION" --no-cli-pager\naws elbv2 describe-target-health --target-group-arn "<tg-arn>" --profile "$AWS_PROFILE" --region "$AWS_REGION" --no-cli-pager\n'})}),"\n",(0,a.jsx)(n.h3,{id:"e-security-groups-nodeportinstance-targets",children:"E) Security groups (NodePort/instance targets)"}),"\n",(0,a.jsxs)(n.p,{children:["For ",(0,a.jsx)(n.code,{children:"instance"})," targets, NLB health checks hit the ",(0,a.jsx)(n.strong,{children:"node\u2019s NodePort"}),". If the node SG blocks that port, targets become unhealthy and connections time out."]}),"\n",(0,a.jsx)(n.p,{children:"Commands to inspect SG rules:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'aws ec2 describe-security-groups --group-ids "<node-sg>" --profile "$AWS_PROFILE" --region "$AWS_REGION" --no-cli-pager\n'})}),"\n",(0,a.jsx)(n.p,{children:"To allow the NLB/backend SG to reach NodePorts (example):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'aws ec2 authorize-security-group-ingress \\\n  --group-id "<node-sg>" \\\n  --ip-permissions \\\n    \'IpProtocol=tcp,FromPort=30636,ToPort=30636,UserIdGroupPairs=[{GroupId=<backend-sg>}]\' \\\n    \'IpProtocol=tcp,FromPort=32222,ToPort=32222,UserIdGroupPairs=[{GroupId=<backend-sg>}]\' \\\n  --profile "$AWS_PROFILE" --region "$AWS_REGION" --no-cli-pager\n'})}),"\n",(0,a.jsx)(n.p,{children:"Also, the controller\u2019s worker-node SG selection expects a SG tagged like:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"kubernetes.io/cluster/<cluster-name> = owned|shared"})}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"f-subnets--az-mismatch",children:"F) Subnets / AZ mismatch"}),"\n",(0,a.jsxs)(n.p,{children:["If the node is in ",(0,a.jsx)(n.code,{children:"$AWS_REGIONd"})," but the NLB only has subnets in ",(0,a.jsx)(n.code,{children:"1b/1c"}),", targets can\u2019t be registered/used correctly."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'kubectl  get nodes -o wide\nkubectl  get nodes -o jsonpath=\'{range .items[*]}{.metadata.name}{"\\t"}{.spec.providerID}{"\\n"}{end}\'\n\naws ec2 describe-instances --instance-ids "<i-...>" --profile "$AWS_PROFILE" --region "$AWS_REGION" --no-cli-pager\naws ec2 describe-subnets --subnet-ids "<subnet-1>" "<subnet-2>" --profile "$AWS_PROFILE" --region "$AWS_REGION" --no-cli-pager\n\naws elbv2 describe-load-balancers --load-balancer-arns "<nlb-arn>" --profile "$AWS_PROFILE" --region "$AWS_REGION" --no-cli-pager \\\n  --query \'LoadBalancers[].AvailabilityZones[].{Zone:ZoneName,SubnetId:SubnetId}\'\n'})}),"\n",(0,a.jsx)(n.h3,{id:"g-multi-az-nlb-resolves-to-multiple-ips-some-work-some-time-out",children:"G) Multi-AZ NLB resolves to multiple IPs (some work, some time out)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'dig +short "$NLB_HOST"\nfor ip in $(dig +short "$NLB_HOST"); do\n  nc -G 2 -vz "$ip" 2222 || true\ndone\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Fix: enable cross-zone (",(0,a.jsx)(n.code,{children:"load_balancing.cross_zone.enabled=true"}),") or restrict subnets."]}),"\n",(0,a.jsx)(n.h3,{id:"notes--gotchas",children:"Notes / gotchas"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"ClusterIP services + overlay pod IPs"}),": You\u2019ll often get ",(0,a.jsx)(n.code,{children:"Accepted=True"})," on routes, but the controller still can\u2019t create listeners/targets (or will skip them) because it can\u2019t reach pod IPs from the NLB."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"kubectl version skew"}),": in this environment, client is newer than server by >1 minor. It still works for these resources, but keep it in mind if you hit strange client-side issues."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>o});var a=s(96540);const l={},t=a.createContext(l);function r(e){const n=a.useContext(t);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:r(e.components),a.createElement(t.Provider,{value:n},e.children)}}}]);