"use strict";(globalThis.webpackChunkkgkb=globalThis.webpackChunkkgkb||[]).push([[74912],{86112:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>p,frontMatter:()=>a,metadata:()=>d,toc:()=>i});var t=s(74848),o=s(28453);const a={slug:"add-flaky-network",title:"How to Add Network Flakiness",description:"How to add network flakiness for testing applications.",authors:["kgal-akl"],tags:["network","testing","development","vm","linux","kernel","traffic","latency","performance","kubernetes","k8s","chaos"]},l=void 0,d={id:"software/chaos/jitter",title:"How to Add Network Flakiness",description:"How to add network flakiness for testing applications.",source:"@site/docs/software/chaos/jitter.md",sourceDirName:"software/chaos",slug:"/software/chaos/add-flaky-network",permalink:"/docs/software/chaos/add-flaky-network",draft:!1,unlisted:!1,tags:[{inline:!0,label:"network",permalink:"/docs/tags/network"},{inline:!0,label:"testing",permalink:"/docs/tags/testing"},{inline:!0,label:"development",permalink:"/docs/tags/development"},{inline:!0,label:"vm",permalink:"/docs/tags/vm"},{inline:!0,label:"linux",permalink:"/docs/tags/linux"},{inline:!0,label:"kernel",permalink:"/docs/tags/kernel"},{inline:!0,label:"traffic",permalink:"/docs/tags/traffic"},{inline:!0,label:"latency",permalink:"/docs/tags/latency"},{inline:!0,label:"performance",permalink:"/docs/tags/performance"},{inline:!0,label:"kubernetes",permalink:"/docs/tags/kubernetes"},{inline:!0,label:"k8s",permalink:"/docs/tags/k-8-s"},{inline:!0,label:"chaos",permalink:"/docs/tags/chaos"}],version:"current",frontMatter:{slug:"add-flaky-network",title:"How to Add Network Flakiness",description:"How to add network flakiness for testing applications.",authors:["kgal-akl"],tags:["network","testing","development","vm","linux","kernel","traffic","latency","performance","kubernetes","k8s","chaos"]},sidebar:"docsSidebar",previous:{title:"Introduction",permalink:"/docs/"},next:{title:"How to Set Up Chaos Mesh on Kubernetes using Helm",permalink:"/docs/software/chaos/how-to-setup-chaos-mesh-k8s-helm"}},r={},i=[{value:"Example: Squid Proxy running on an Ubuntu VM",id:"example-squid-proxy-running-on-an-ubuntu-vm",level:2},{value:"Example: Degraded + Blackhole",id:"example-degraded--blackhole",level:2},{value:"Modify Rules",id:"modify-rules",level:2},{value:"Remove Rules",id:"remove-rules",level:2},{value:"See Applied Rules",id:"see-applied-rules",level:2}];function c(e){const n={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["On a VM, we can use the ",(0,t.jsx)(n.code,{children:"tc"})," tool to manipulate outbound traffic control."]}),"\n",(0,t.jsxs)(n.p,{children:["On an Azure VM that has a ",(0,t.jsx)(n.code,{children:"k3s"})," cluster deployed, the traffic path from an application running in a Pod to SaaS service would go like this:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Gateway Pod -> ",(0,t.jsx)(n.code,{children:"cni0"})," (bridge)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"cni0"})," -> host routing"]}),"\n",(0,t.jsxs)(n.li,{children:["Host -> physical interface (",(0,t.jsx)(n.code,{children:"eth0"}),") -> internet"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["So we will apply ",(0,t.jsx)(n.code,{children:"tc"})," rules to the ",(0,t.jsx)(n.code,{children:"eth0"})," interface. We can display information about the interface:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kgal@kgal-azure-dev:~$ ip a show eth0\n\n6: cni0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc prio state UP group default qlen 1000\n    link/ether da:01:a4:37:22:4e brd ff:ff:ff:ff:ff:ff\n    inet 10.42.0.1/24 brd 10.42.0.255 scope global cni0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::5884:dfff:fe48:9a1/64 scope link\n       valid_lft forever preferred_lft forever\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The first step is to create a root queueing discipline (A.K.A. ",(0,t.jsx)(n.code,{children:"qdisc"}),"). Whenever the kernel needs to send a packet to an interface, it is enqueued to the ",(0,t.jsx)(n.code,{children:"qdisc"})," configured for that interface. Immediately afterwards, the kernel tries to get as many packets as possible from the ",(0,t.jsx)(n.code,{children:"qdisc"}),", for giving them to the network adaptor driver."]}),"\n",(0,t.jsxs)(n.p,{children:["To create a root ",(0,t.jsx)(n.code,{children:"qdisc"})," on ",(0,t.jsx)(n.code,{children:"en0"})," interface with 500ms delay, 50ms jitter and 10% packet loss:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'SAAS_IPS=("123.123.123.123" "122.122.122.122")\nPODS_IPS=($(kubectl get pod -n  -l "app.kubernetes.io/name=myapp" -o jsonpath=\'{.items[*].status.podIP}\'))\necho $POD_IPS\n("10.42.0.73" "10.42.0.74" "10.42.0.75")\n\nDELAY_MS=500\nJITTER_MS=50\nCONNECTION_LOSS_PERCENTAGE=10\n\n# 1. Clear any existing config on the physical interface\nsudo tc qdisc del dev eth0 root 2>/dev/null\n\n# 2. Add the root priority qdisc\nsudo tc qdisc add dev eth0 root handle 1: prio\n\n# 3. Create the netem "Chaos Lane" (Handle 10: attached to Band 1:1)\nsudo tc qdisc add dev eth0 parent 1:1 handle 10: netem delay "${DELAY_MS}ms" "${JITTER_MS}ms" loss "${CONNECTION_LOSS_PERCENTAGE}"\n\nfor s_ip in "${SAAS_IPS[@]}"; do\n  for p_ip in "${POD_IPS[@]}"; do\n    sudo iptables -t mangle -A POSTROUTING -s "$p_ip" -d "$s_ip" -j MARK --set-mark 1\n  done\ndone\n\n# 5. Direct marked traffic into the Chaos Lane\nsudo tc filter add dev eth0 protocol ip parent 1:0 prio 1 handle 1 fw flowid 1:1\n'})}),"\n",(0,t.jsx)(n.h2,{id:"example-squid-proxy-running-on-an-ubuntu-vm",children:"Example: Squid Proxy running on an Ubuntu VM"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Tune these\nDELAY_MS=500\nJITTER_MS=50\nLOSS_PERCENT=10\nSQUID_USER=proxy\nIFACE=eth0\n\n# 1) clean slate\nsudo tc qdisc del dev $IFACE root 2>/dev/null || true\n\n# 2) root prio\nsudo tc qdisc add dev $IFACE root handle 1: prio\n\n# 3) chaos lane on band 1:1\nsudo tc qdisc add dev $IFACE parent 1:1 handle 10: netem \\\ndelay ${DELAY_MS}ms ${JITTER_MS}ms loss ${LOSS_PERCENT}%\n\n# 4) normal lane on band 1:2\nsudo tc qdisc add dev $IFACE parent 1:2 handle 20: fq_codel\n\n# 5) marked packets -> chaos lane\nsudo tc filter add dev $IFACE protocol ip parent 1:0 prio 1 handle 1 fw flowid 1:1\n\n# 6) everything else -> normal lane (important to avoid surprises)\nsudo tc filter add dev $IFACE protocol all parent 1:0 prio 10 matchall flowid 1:2\n\n# 7) mark ONLY squid-owned outbound packets (so SSH etc stays clean)\n# (Squid user is usually 'proxy')\nsudo iptables -t mangle -A OUTPUT -o $IFACE -m owner --uid-owner $SQUID_USER -j MARK --set-mark 1\n"})}),"\n",(0,t.jsx)(n.p,{children:"We can also reject requests completely:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo iptables -I OUTPUT 1 -o $IFACE -m owner --uid-owner $SQUID_USER -p tcp --dport 443 -j REJECT\n"})}),"\n",(0,t.jsx)(n.h2,{id:"example-degraded--blackhole",children:"Example: Degraded + Blackhole"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'#!/usr/bin/env bash\n\n# This script is used to simulate an unstable network environment and is meant to be run on a VM with a \n# Squid proxy running. It was run on EC2 instance therefore the interface is enX0.\n\n#!/usr/bin/env bash\nset -euo pipefail\n\nIFACE="${IFACE:-enX0}"\nSQUID_USER="${SQUID_USER:-proxy}"\n\nGOOD_SECONDS="${GOOD_SECONDS:-20}"\nBLACKHOLE_SECONDS="${BLACKHOLE_SECONDS:-10}"\n\nGOOD_DELAY_MEAN_MS="${GOOD_DELAY_MEAN_MS:-300}"\nGOOD_DELAY_JITTER_MS="${GOOD_DELAY_JITTER_MS:-200}"\nGOOD_LOSS_PCT="${GOOD_LOSS_PCT:-1}"\nGOOD_LOSS_CORR_PCT="${GOOD_LOSS_CORR_PCT:-25}"\n\ncleanup() {\n  echo "[INFO] cleaning up..."\n  sudo iptables -t mangle -D OUTPUT -o "$IFACE" -m owner --uid-owner "$SQUID_USER" -j MARK --set-mark 1 2>/dev/null || true\n  sudo tc qdisc del dev "$IFACE" root 2>/dev/null || true\n}\ntrap cleanup EXIT\n\necho "[INFO] using IFACE=$IFACE SQUID_USER=$SQUID_USER"\n\n# Root + lanes\nsudo tc qdisc del dev "$IFACE" root 2>/dev/null || true\nsudo tc qdisc add dev "$IFACE" root handle 1: prio\nsudo tc qdisc add dev "$IFACE" parent 1:1 handle 10: netem delay 1ms 1ms loss 0%\nsudo tc qdisc add dev "$IFACE" parent 1:2 handle 20: fq_codel\n\n# Filters\nsudo tc filter add dev "$IFACE" protocol ip parent 1:0 prio 1 handle 1 fw flowid 1:1\nsudo tc filter add dev "$IFACE" protocol all parent 1:0 prio 10 matchall flowid 1:2\n\n# Mark only Squid-owned egress\nsudo iptables -t mangle -A OUTPUT -o "$IFACE" -m owner --uid-owner "$SQUID_USER" -j MARK --set-mark 1\n\necho "[INFO] starting volatility loop: ${GOOD_SECONDS}s degraded + ${BLACKHOLE_SECONDS}s blackhole..."\nwhile true; do\n  echo "[INFO] degraded window (${GOOD_SECONDS}s)"\n  sudo tc qdisc change dev "$IFACE" parent 1:1 handle 10: netem \\\n    delay "${GOOD_DELAY_MEAN_MS}ms" "${GOOD_DELAY_JITTER_MS}ms" \\\n    loss "${GOOD_LOSS_PCT}%" "${GOOD_LOSS_CORR_PCT}%"\n  sleep "$GOOD_SECONDS"\n\n  echo "[INFO] blackhole window (${BLACKHOLE_SECONDS}s)"\n  sudo tc qdisc change dev "$IFACE" parent 1:1 handle 10: netem loss 100%\n  sleep "$BLACKHOLE_SECONDS"\ndone\n'})}),"\n",(0,t.jsx)(n.h2,{id:"modify-rules",children:"Modify Rules"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo tc qdisc change dev enX0 parent 1:1 handle 10: netem delay 500ms 50ms loss 10%\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note:"})," Adding this will destabilize the VM where this is run from."]}),"\n",(0,t.jsx)(n.h2,{id:"remove-rules",children:"Remove Rules"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo tc qdisc del dev $IFACE root\nsudo iptables -t mangle -F POSTROUTING\nsudo iptables -t mangle -D OUTPUT -o $IFACE -m owner --uid-owner proxy -j MARK --set-mark 1\nsudo iptables -D OUTPUT -o $IFACE -m owner --uid-owner proxy -p tcp --dport 443 -j REJECT\nsudo tc qdisc del dev $IFACE root 2>/dev/null || true\n"})}),"\n",(0,t.jsx)(n.h2,{id:"see-applied-rules",children:"See Applied Rules"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo tc -s qdisc show dev $IFACE\nsudo tc -s class show dev $IFACE 2>/dev/null || true\nsudo iptables -t mangle -S OUTPUT | grep MARK\n"})})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>d});var t=s(96540);const o={},a=t.createContext(o);function l(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:l(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);