"use strict";(globalThis.webpackChunkkgkb=globalThis.webpackChunkkgkb||[]).push([[87032],{28744:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>c,toc:()=>o});var t=n(74848),r=n(28453);const a={title:"Azure Identity",slug:"azure-identity",app2or:"kgal-akl",tags:["devops","azure","aks","az","imds","metadata","identity"]},s=void 0,c={id:"cloud_services/azure/identity",title:"Azure Identity",description:"There are 2 authentication mechanisms available in Azure: Azure IMDS (e.g. Managed Identity) and Azure Workload Identity.",source:"@site/docs/cloud_services/azure/identity.md",sourceDirName:"cloud_services/azure",slug:"/cloud_services/azure/azure-identity",permalink:"/docs/cloud_services/azure/azure-identity",draft:!1,unlisted:!1,tags:[{inline:!0,label:"devops",permalink:"/docs/tags/devops"},{inline:!0,label:"azure",permalink:"/docs/tags/azure"},{inline:!0,label:"aks",permalink:"/docs/tags/aks"},{inline:!0,label:"az",permalink:"/docs/tags/az"},{inline:!0,label:"imds",permalink:"/docs/tags/imds"},{inline:!0,label:"metadata",permalink:"/docs/tags/metadata"},{inline:!0,label:"identity",permalink:"/docs/tags/identity"}],version:"current",frontMatter:{title:"Azure Identity",slug:"azure-identity",app2or:"kgal-akl",tags:["devops","azure","aks","az","imds","metadata","identity"]},sidebar:"docsSidebar",previous:{title:"Managing Azure Container Apps using in Azure CLI",permalink:"/docs/cloud_services/azure/managing-azure-container-app"},next:{title:"Managing VM in Azure",permalink:"/docs/cloud_services/azure/managing-azure-vm"}},l={},o=[{value:"IMDS",id:"imds",level:2},{value:"Workload Identity",id:"workload-identity",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Environmental Variables",id:"environmental-variables",level:3},{value:"Service principal with secret:",id:"service-principal-with-secret",level:4},{value:"Service principal with certificate:",id:"service-principal-with-certificate",level:4},{value:"Authenticating using Azure Go SDK",id:"authenticating-using-azure-go-sdk",level:2},{value:"Sources",id:"sources",level:3}];function d(e){const i={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.p,{children:"There are 2 authentication mechanisms available in Azure: Azure IMDS (e.g. Managed Identity) and Azure Workload Identity."}),"\n",(0,t.jsx)(i.p,{children:"The fundamental difference is where the trust originates. IMDS trusts the physical/virtual network of the Azure host, while Workload Identity trusts the Kubernetes identity provider."}),"\n",(0,t.jsx)(i.h2,{id:"imds",children:"IMDS"}),"\n",(0,t.jsx)(i.p,{children:"IMDS primary use case is using virtual machines, app services and functions."}),"\n",(0,t.jsx)(i.p,{children:"The trust source is the host network which is only accessible within the resource's network stack."}),"\n",(0,t.jsx)(i.p,{children:"The flow is: Your code -> Local IP -> Azure Fabric -> Entra ID"}),"\n",(0,t.jsxs)(i.p,{children:["The protocol is HTTP with a call to the IMDS endpoint available in the Azure resource, ",(0,t.jsx)(i.code,{children:"169.254.169.254"}),":"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:'curl -H "Metadata: true" \\\n"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"\n'})}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-powershell",children:'Invoke-RestMethod -Headers @{"Metadata"="true"} -Method GET -Uri "http://169.254.169.254/metadata/instance?api-version=2025-04-07" | ConvertTo-Json -Depth 64\n'})}),"\n",(0,t.jsx)(i.h2,{id:"workload-identity",children:"Workload Identity"}),"\n",(0,t.jsx)(i.p,{children:"Workload Identity's primary use case is Kubernetes (AKS)."}),"\n",(0,t.jsx)(i.p,{children:"The trust source is OIDC federation, a relationship between Kubernetes and Entra ID."}),"\n",(0,t.jsx)(i.p,{children:"The flow is, workload/app -> K8s Service Account Token -> Entra ID (verifies via OIDC) -> Access Token."}),"\n",(0,t.jsxs)(i.p,{children:["The protocol is an OIDC token exchange, specifically a Kubernetes ",(0,t.jsx)(i.code,{children:"ServiceAccount"})," token for the Entra token. Therefore, to enable Azure Workload Identity, the infrastructure requires an OIDC issuer and a ",(0,t.jsx)(i.code,{children:"MutatingWebhook"})," on Kubernetes."]}),"\n",(0,t.jsxs)(i.p,{children:["To retrieve a token, the application (workload) must first have a signed Kubernetes token (projected into the ",(0,t.jsx)(i.code,{children:"Pod"}),", usually placed in ",(0,t.jsx)(i.code,{children:"/var/run/secrets/azure/tokens/azure-identity"}),"). We can then call this endpoint to retrieve an Azure token:"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:'curl -X POST https://login.microsoftonline.com/$AZURE_TENANT_ID/oauth2/v2.0/token \\\n-d "client_id=$AZURE_CLIENT_ID" \\\n-d "scope=https://management.azure.com/.default" \\\n-d "client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer" \\\n-d "client_assertion=$(cat /var/run/secrets/azure/tokens/azure-identity)" \\\n-d "grant_type=client_credentials"\n'})}),"\n",(0,t.jsxs)(i.p,{children:["To check if the OIDC provider is enabled, see ",(0,t.jsx)(i.a,{href:"/docs/cloud_services/azure/managing-aks-azure#check-workload-identity",children:"Check Workload Identity"}),".\nTo enable Workload Identity using the Azure CLI, see ",(0,t.jsx)(i.a,{href:"/docs/cloud_services/azure/managing-aks-azure#enable-workload-identity",children:"Enable Workload Identity"}),"."]}),"\n",(0,t.jsx)(i.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsx)(i.h3,{id:"environmental-variables",children:"Environmental Variables"}),"\n",(0,t.jsx)(i.p,{children:"Azure credentials can be configured by environment variables. This credential is capable of authenticating as a service principal using a client secret or a certificate. Configuration is attempted in this order, using these environment variables:"}),"\n",(0,t.jsx)(i.h4,{id:"service-principal-with-secret",children:"Service principal with secret:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"AZURE_TENANT_ID"}),": ID of the service principal's tenant. Also called its 'directory' ID."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"AZURE_CLIENT_ID"}),": the service principal's client ID"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"AZURE_CLIENT_SECRET"}),": one of the service principal's client secrets"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"AZURE_AUTHORITY_HOST"}),': authority of a Microsoft Entra endpoint, for example "login.microsoftonline.com", the authority for Azure Public Cloud, which is the default when no value is given.']}),"\n"]}),"\n",(0,t.jsx)(i.h4,{id:"service-principal-with-certificate",children:"Service principal with certificate:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"AZURE_TENANT_ID"}),": ID of the service principal's tenant. Also called its 'directory' ID."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"AZURE_CLIENT_ID"}),": the service principal's client ID"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"AZURE_CLIENT_CERTIFICATE_PATH"}),": path to a PEM or PKCS12 certificate file including the private key."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"AZURE_CLIENT_CERTIFICATE_PASSWORD"}),": (optional) password of the certificate file, if any."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"AZURE_CLIENT_SEND_CERTIFICATE_CHAIN"}),": (optional) If True, the credential will send the public certificate chain in the x5c header of each token request's JWT. This is required for Subject Name/Issuer (SNI) authentication. Defaults to False."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"AZURE_AUTHORITY_HOST"}),': authority of a Microsoft Entra endpoint, for example "login.microsoftonline.com", the authority for Azure Public Cloud, which is the default when no value is given.']}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"authenticating-using-azure-go-sdk",children:"Authenticating using Azure Go SDK"}),"\n",(0,t.jsxs)(i.p,{children:["To authenticate using the ",(0,t.jsx)(i.a,{href:"https://pkg.go.dev/github.com/Azure/azure-sdk-for-go#section-readme",children:"Azure Go SDK"}),", ",(0,t.jsx)(i.code,{children:"azureidentity"}),", we can use the ",(0,t.jsx)(i.code,{children:"DefaultAzureCredential"})," which automatically tries Workload Identity before falling back to IMDS."]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-go",children:'import (\n    "github.com/Azure/azure-sdk-for-go/sdk/azidentity"\n    "github.com/Azure/azure-sdk-for-go/sdk/resourcemanager/resources/armresources"\n)\n\nfunc main() {\n    // This will check Workload Identity first, then IMDS (Managed Identity)\n    cred, err := azidentity.NewDefaultAzureCredential(nil)\n    if err != nil {\n        panic(err)\n    }\n\n    // Use the credential with any Azure client\n    client, _ := armresources.NewResourceGroupsClient("<subscription-id>", cred, nil)\n}\n'})}),"\n",(0,t.jsx)(i.p,{children:"If we want to explicitly target IMDS/Managed Identity:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-go",children:"managedCred, err := azidentity.NewManagedIdentityCredential(nil)\n"})}),"\n",(0,t.jsx)(i.p,{children:"Otherwise, if we want to explicitly target Workload Identity:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-go",children:"// It reads AZURE_TENANT_ID, AZURE_CLIENT_ID, and AZURE_FEDERATED_TOKEN_FILE from environment\nworkloadCred, err := azidentity.NewWorkloadIdentityCredential(nil)\n"})}),"\n",(0,t.jsx)(i.h3,{id:"sources",children:"Sources"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:(0,t.jsx)(i.a,{href:"https://learn.microsoft.com/en-us/python/api/azure-identity/azure.identity.environmentcredential?view=azure-python",children:"https://learn.microsoft.com/en-us/python/api/azure-identity/azure.identity.environmentcredential?view=azure-python"})}),"\n"]})]})}function u(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,i,n)=>{n.d(i,{R:()=>s,x:()=>c});var t=n(96540);const r={},a=t.createContext(r);function s(e){const i=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function c(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),t.createElement(a.Provider,{value:i},e.children)}}}]);