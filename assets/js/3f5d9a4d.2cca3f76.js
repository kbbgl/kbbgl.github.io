"use strict";(globalThis.webpackChunkkgkb=globalThis.webpackChunkkgkb||[]).push([[91429],{31956:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>l});var i=t(74848),o=t(28453);const s={slug:"catch-ebusy-on-nodejs",title:"How To Catch EBUSY Event on Windows using NodeJS",authors:["kbbgl"],tags:["nodejs","windows","web-dev","debugging"]},r=void 0,a={permalink:"/blog/catch-ebusy-on-nodejs",source:"@site/blog/catch-ebusy-on-nodejs.md",title:"How To Catch EBUSY Event on Windows using NodeJS",description:"Introduction",date:"2026-02-02T19:06:12.000Z",tags:[{inline:!1,label:"Nodejs",permalink:"/blog/tags/nodejs"},{inline:!1,label:"Windows",permalink:"/blog/tags/windows"},{inline:!1,label:"Web-dev",permalink:"/blog/tags/web-dev"},{inline:!1,label:"Debugging",permalink:"/blog/tags/debugging"}],readingTime:5.885,hasTruncateMarker:!0,authors:[{name:"Kobbi Gal",title:"I like to pick things apart and see how they work inside",url:"https://github.com/kbbgl",imageURL:"https://avatars.githubusercontent.com/u/14372649",key:"kbbgl",page:null}],frontMatter:{slug:"catch-ebusy-on-nodejs",title:"How To Catch EBUSY Event on Windows using NodeJS",authors:["kbbgl"],tags:["nodejs","windows","web-dev","debugging"]},unlisted:!1,prevItem:{title:"Angstrom CTF2021 | Exploiting Python Pickle in Flask Web\xa0App",permalink:"/blog/angstrom-ctf2021-exploiting-python-pickle-in-flask"},nextItem:{title:"Debugging NodeJS Microservice with Shared Storage on\xa0Kubernetes",permalink:"/blog/debugging-nodejs-microservice-with-shared-storage-on-kubernetes"}},c={authorsImageUrls:[void 0]},l=[{value:"Introduction",id:"introduction",level:2},{value:"Microservice High Availability",id:"microservice-high-availability",level:2},{value:"Investigating <code>EBUSY</code> Event",id:"investigating-ebusy-event",level:2},{value:"Using Handle Binary in Microservice",id:"using-handle-binary-in-microservice",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(n.p,{children:"During a debugging session of one of our NodeJS microservices misbehaving on a Windows Server 2019 instances, I opened the microservice log to begin investigating the faulty behavior."}),"\n",(0,i.jsx)(n.p,{children:"But when I scrolled down to the timestamp where I was supposed to start investigating, I found out that the log was full of the following errors thrown by an attempt to read the microservice log file:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:"Error: EBUSY: resource busy or locked, lstat %PROGRAMDATA%/microservice_b/mb.log\n"})}),"\n",(0,i.jsx)(n.p,{children:"Followed by a termination of the microservice logging. It was visible also that the microservice was in some unstable state as it's CPU was on 0% and it's memory working set was fixed and not changing."}),"\n",(0,i.jsx)(n.p,{children:"After restarting the microservice (a NodeJS process wrapped in a Windows Service), the serverside functionality of the microservice resumed."}),"\n",(0,i.jsx)(n.p,{children:"Since this microservice was critical to the functionality of the application, I needed to do 2 things, in this order:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Ensure that there's no downtime for the microservice."}),"\n",(0,i.jsxs)(n.li,{children:["Investigate the root cause of the ",(0,i.jsx)(n.code,{children:"EBUSY"})," error."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"microservice-high-availability",children:"Microservice High Availability"}),"\n",(0,i.jsx)(n.p,{children:"High Availability is a concept that is synonymous with the microservice architecture. In a production-grade, enterprise environment, you want to have fault tolerance in case one of the microservices stops serving it's requests' path (as in the case I investigated here)."}),"\n",(0,i.jsx)(n.p,{children:"There are different approaches to fault tolerance, the most popular one is using replicas of the same microservices to listen on the same requests. For example, in the architecture I was working with, the Angular frontend application was sending requests to the NodeJS/Express servers who were talking between them in Produces/Consumer fashion using a RabbitMQ message broker. Each microservice (and its instances) was bound to one queue in an exchange."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"arch",src:t(7019).A+"",width:"781",height:"421"})}),"\n",(0,i.jsx)(n.p,{children:"The specific microservice that was malfunctioning had only one instance configured (Instance 1 of Microservice B in the diagram above). In order to provide High Availability in this case, all I needed to do was to find out how to increase the number of instances of a microservice."}),"\n",(0,i.jsxs)(n.p,{children:["Since the NodeJS microservices were deployed on a Windows instance and not in the newer generation Linux-cloud native instance which runs atop a Kubernetes cluster (where I could just run ",(0,i.jsx)(n.code,{children:"kubectl scale deployment microservice_b --replicas=3"}),"), I needed to check the configuration database (hosted as a Zookeeper instance) and find where we can configure the number of instance per microservice."]}),"\n",(0,i.jsx)(n.p,{children:"After a while of searching our knowledgebase (why are they always so messy and it's so hard to find anything in them?!?!), I found the z-node path where this configuation was held. I sent the following command to set the number of replicas to 3:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"bin/zkCli.bat -server 127.0.0.1:2181 set /config/microservice_b/clusterNodes 3\n"})}),"\n",(0,i.jsx)(n.p,{children:"First task was done. We now had 3 microservices and had High Availability for this critical service path. As you may recall, the next step was the investigation of the EBUSY event and mitigation of it."}),"\n",(0,i.jsxs)(n.h2,{id:"investigating-ebusy-event",children:["Investigating ",(0,i.jsx)(n.code,{children:"EBUSY"})," Event"]}),"\n",(0,i.jsxs)(n.p,{children:["Until this point, I've been working on debugging NodeJS for about 1 year and mostly in a Windows environment. I have seen and debugged different NodeJS errors, such as filesystem-related ",(0,i.jsx)(n.code,{children:"EACCES"}),", ",(0,i.jsx)(n.code,{children:"ENOENT"}),", ",(0,i.jsx)(n.code,{children:"EMFILE"})," and network-related errors ",(0,i.jsx)(n.code,{children:"EADDRINUSE"}),", ",(0,i.jsx)(n.code,{children:"ECONNRESET"}),", ",(0,i.jsx)(n.code,{children:"ECONNREFUSED"}),", ",(0,i.jsx)(n.code,{children:"ECONNABORTED"})," . But I've never seen ",(0,i.jsx)(n.code,{children:"EBUSY"})," before."]}),"\n",(0,i.jsxs)(n.p,{children:["First step was to see what the ",(0,i.jsx)(n.a,{href:"https://nodejs.org/dist./v6.3.0/docs/api/all.html",children:"official NodeJS documentation for error messages"})," provided. Not much elaboration from the site unfortunately:"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"EBUSY | Indicates that a device or resource is busy."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Per my understanding, this issue was related to the filesystem mutex/lock."}),"\n",(0,i.jsx)(n.p,{children:"I decided that the most efficient way to understand this error code was to review the NodeJS source code since, conveniently enough, is open-source."}),"\n",(0,i.jsx)(n.p,{children:"I cloned the Node JS repo:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"git clone https://github.com/nodejs/node.git\n"})}),"\n",(0,i.jsx)(n.p,{children:"Took some time download and extract all of it."}),"\n",(0,i.jsx)(n.p,{children:"I then searched through the source code and found the error code in 21 different files (filtering out all the test-related code):"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'grep -rnw "EBUSY" node | cut -d":" -f1 | grep -v test | uniq | wc -l\n      21\n'})}),"\n",(0,i.jsxs)(n.p,{children:["After reviewing some files, I landed on ",(0,i.jsx)(n.code,{children:"deps/uv/docs/src/loop.rst"})," where I found some document string of the method ",(0,i.jsx)(n.code,{children:"Loop::uv_loop_close"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rst",children:".. c:function:: int uv_loop_close(uv_loop_t* loop)\n\n    Releases all internal loop resources. Call this function only when the loop\n    has finished executing and all open handles and requests have been closed,\n    or it will return UV_EBUSY. After this function returns, the user can free\n    the memory allocated for the loop.\n"})}),"\n",(0,i.jsx)(n.p,{children:"I found it ironic how the source code is so much more elaborate than the official/external NodeJS documentation."}),"\n",(0,i.jsxs)(n.p,{children:["Also, I learned that .rst extension is a markup language format called ",(0,i.jsxs)(n.a,{href:"https://en.wikipedia.org/wiki/ReStructuredText",children:[(0,i.jsx)(n.code,{children:"reStructuredText"})," that is both human-readable and processable by Python ",(0,i.jsx)(n.code,{children:"docutils"})]}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Going back to the task at hand, the method docstring was helpful in strengthening my educated guess that this issue is filesystem-related. It also provided information about the scenario when this error might occur: after a ",(0,i.jsx)(n.a,{href:"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#:~:text=What%20is%20the%20Event%20Loop,the%20system%20kernel%20whenever%20possible.&text=js%20so%20that%20the%20appropriate,queue%20to%20eventually%20be%20executed.",children:"NodeJS Event Loop"})," has terminated and all open file handles I/O finished."]}),"\n",(0,i.jsxs)(n.p,{children:["I decided to focus on the latter detail (file handle state) as I have some familiarity with the ",(0,i.jsxs)(n.a,{href:"https://docs.microsoft.com/en-us/sysinternals/downloads/handle",children:["Windows SysInternals binary called ",(0,i.jsx)(n.code,{children:"handle.exe"})]}),". It gives us access to information about which process has open file handlers to a specific file."]}),"\n",(0,i.jsxs)(n.p,{children:["I need a way to fuse this Windows executable with the NodeJS code to catch the ",(0,i.jsx)(n.code,{children:"EBUSY"})," event."]}),"\n",(0,i.jsx)(n.h2,{id:"using-handle-binary-in-microservice",children:"Using Handle Binary in Microservice"}),"\n",(0,i.jsxs)(n.p,{children:["I wrote a module called ",(0,i.jsx)(n.code,{children:"checkFileHandler.js"})," which has two functions:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"executeHandle"})," will execute the ",(0,i.jsx)(n.code,{children:"handle.exe"})," binary."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"getCmdArguments"})," will get the command-line arguments of the processes that handle captured using PowerShell."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'var exec = require(\'child_process\').execFile;\nconst handleExecutablePath = "./handle64.exe"\nconst PID_REGEX = /pid: (\\d{1,5})/mg;\n\nexecuteHandle = (filename) => {\n\n exec(handleExecutablePath, [filename], (err, data) => {\n \n  if(err && err.signal == null){\n   logger.info(`No matching handles for \'${filename}\'`);\n  } else {\n   logger.error(`Couldn\'t run handler: ${JSON.stringify(err, null, 3)}`);\n  }\n  \n  var output = data.toString();\n  console.log(output);\n  var matches = output.match(PID_REGEX);\n  \n  if (matches){\n   \n   logger.info(`Found ${matches.length} processes`);\n   matches.forEach(match => {\n    var pid = match.split(":")[1].trimLeft();\n    getCmdArguments(pid); \n   })\n  }\n  \n  \n })\n}\n\ngetCmdArguments = (pid) => {\n \n var psCommand = `Get-WmiObject -Query \\"SELECT CommandLine FROM Win32_Process WHERE ProcessID = ${pid}\\" | Select-Object -ExpandProperty CommandLine`;\n  \n exec("powershell.exe ", psCommand.split(" "), (err, data) => {\n  \n  if(err) throw err;\n  \n  if (data) {\n   logger.info(`PID ${pid} command line arguments: ${data.toString()}`)\n   // return data.toString();\n  }\n    \n })\n \n}\n\nmodule.exports = {\n\n executeHandle: executeHandle\n\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"I then loaded the module within the microservice application code (don't forget to backup the original code in a production environment!):"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"var handler = require('checkFileHandler');\nvar logfile = \"%PROGRAMDATA%/microservice_b/mb.log\";\n\n\n# ...\ngetData()\n    .then(changeDataFormat)\n    .then(storeData)\n    .catch((e) => {\n        if (e.code == 'EBUSY') {\n            handler.executeHandle(logfile);\n            process.exit(1)\n        }\n    })\n"})}),"\n",(0,i.jsx)(n.p,{children:"So now, whenever getData function calls finish and the NodeJS Event Loop is terminated but the log file is still unaccessible, we're going to receive detailed information about which process and its commands are keeping the log file open. Since the process is now stuck, it would be best to just terminate it so that the microservice scheduler can create another clean instance of the NodeJS server."}),"\n",(0,i.jsx)(n.p,{children:"I restarted the microservice for my code to be applied and patiently waited for the situation to arise again."})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},7019:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/arch-183593580566541db22696f624deb970.jpeg"},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var i=t(96540);const o={},s=i.createContext(o);function r(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);