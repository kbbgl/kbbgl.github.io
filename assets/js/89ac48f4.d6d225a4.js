"use strict";(self.webpackChunkkgkb=self.webpackChunkkgkb||[]).push([[65856],{77472:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>l,toc:()=>o});var i=r(74848),s=r(28453);const t={title:"Getting Started with the Kernel",slug:"getting-started-kernel",authors:"kbbgl",tags:["linux","os_dev"]},d=void 0,l={id:"os/development/linux_kernel_development/getting_started",title:"Getting Started with the Kernel",description:"Source",source:"@site/docs/os/development/linux_kernel_development/2_getting_started.md",sourceDirName:"os/development/linux_kernel_development",slug:"/os/development/linux_kernel_development/getting-started-kernel",permalink:"/docs/os/development/linux_kernel_development/getting-started-kernel",draft:!1,unlisted:!1,tags:[{inline:!0,label:"linux",permalink:"/docs/tags/linux"},{inline:!0,label:"os_dev",permalink:"/docs/tags/os-dev"}],version:"current",sidebarPosition:2,frontMatter:{title:"Getting Started with the Kernel",slug:"getting-started-kernel",authors:"kbbgl",tags:["linux","os_dev"]},sidebar:"docsSidebar",previous:{title:"Linux Kernel Development",permalink:"/docs/os/development/linux_kernel_development/"},next:{title:"Get Container Resource Usage",permalink:"/docs/software/containerization/docker/admin/get-list-containers-resource-usage"}},c={},o=[{value:"Source",id:"source",level:2},{value:"Kernel Source Tree",id:"kernel-source-tree",level:2},{value:"Building the Kernel",id:"building-the-kernel",level:2},{value:"Configuring the Kernel",id:"configuring-the-kernel",level:3},{value:"Installing the Kernel",id:"installing-the-kernel",level:2},{value:"Linux Kernel Attributes",id:"linux-kernel-attributes",level:2},{value:"No <code>libc</code> or Standard Headers",id:"no-libc-or-standard-headers",level:3},{value:"No Memory Protection",id:"no-memory-protection",level:3},{value:"No Floating Point",id:"no-floating-point",level:3},{value:"Stack",id:"stack",level:3},{value:"Sync and Concurrency",id:"sync-and-concurrency",level:3}];function a(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"source",children:"Source"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"gh repo clone torvalds/linux\n"})}),"\n",(0,i.jsx)(n.h2,{id:"kernel-source-tree",children:"Kernel Source Tree"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Directory"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"arch"})}),(0,i.jsx)(n.td,{children:"Architecture-specific source"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"block"})}),(0,i.jsx)(n.td,{children:"Block I/O Layer"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"crypto"})}),(0,i.jsx)(n.td,{children:"Crypto API"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Documentation"})}),(0,i.jsx)(n.td,{children:"Kernel source documentation"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"drivers"})}),(0,i.jsx)(n.td,{children:"Device drivers"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"firmware"})}),(0,i.jsx)(n.td,{children:"Device firmware needed to use certain drivers"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"fs"})}),(0,i.jsx)(n.td,{children:"the VFS and the individual filesystems"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"include"})}),(0,i.jsx)(n.td,{children:"Kernel headers"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"init"})}),(0,i.jsx)(n.td,{children:"Kernel boot and initialization"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ipc"})}),(0,i.jsx)(n.td,{children:"Interprocess communication code"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"kernel"})}),(0,i.jsx)(n.td,{children:"Core subsystems, such as the scheduler"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"lib"})}),(0,i.jsx)(n.td,{children:"Helper routines"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mm"})}),(0,i.jsx)(n.td,{children:"Memory management subsystem and the VM"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"net"})}),(0,i.jsx)(n.td,{children:"Networking subsystem"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"samples"})}),(0,i.jsx)(n.td,{children:"Sample, demonstrative code"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"scripts"})}),(0,i.jsx)(n.td,{children:"Scripts used to build the kernel"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"security"})}),(0,i.jsx)(n.td,{children:"Linux Security Module"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sound"})}),(0,i.jsx)(n.td,{children:"Sound subsystem"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"usr"})}),(0,i.jsxs)(n.td,{children:["Early user-space code (called ",(0,i.jsx)(n.code,{children:"initramfs"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"tools"})}),(0,i.jsx)(n.td,{children:"Tools helpful for developing Linux"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"virt"})}),(0,i.jsx)(n.td,{children:"Virtualization infrastructure"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"building-the-kernel",children:"Building the Kernel"}),"\n",(0,i.jsx)(n.h3,{id:"configuring-the-kernel",children:"Configuring the Kernel"}),"\n",(0,i.jsxs)(n.p,{children:["Kernel configuration is controlled by ",(0,i.jsx)(n.code,{children:"CONFIG_$FEATURE"}),". For example, symmetrical multiprocessing (SMP) is controlled by ",(0,i.jsx)(n.code,{children:"CONFIG_SMP"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Configuration options values can be ",(0,i.jsx)(n.code,{children:"yes,no,module"}),". Kernel features are usually ",(0,i.jsx)(n.code,{children:"yes"})," or ",(0,i.jsx)(n.code,{children:"no"})," whereas drivers are can be either ",(0,i.jsx)(n.code,{children:"yes,no,module"}),".\nConfiguration options can also be strings or integers."]}),"\n",(0,i.jsx)(n.p,{children:"We can use:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Asks for options 1-by-1\nmake config\n\n# Better tools\nmake menuconfig\nmake gconfig\n\n# Creates configuration based on your architecture\nmake defconfig\n"})}),"\n",(0,i.jsx)(n.p,{children:"to facilitate configuration."}),"\n",(0,i.jsxs)(n.p,{children:["Once the configuration is done, the selected options will be stored in ",(0,i.jsx)(n.code,{children:".config"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["After making changes in ",(0,i.jsx)(n.code,{children:".config"}),", you can validate and update the configuration using:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"make oldconfig\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Another helpful option is ",(0,i.jsx)(n.code,{children:"CONFIG_IKCONFIG_PROC"})," which places the complete, compressed kernel configuration file at ",(0,i.jsx)(n.code,{children:"/proc/config.gz"}),". You can then run the following command to compy the config:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"zcat /proc/config.gz > .config\nmake oldconfig\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To ",(0,i.jsx)(n.em,{children:"build"})," the kernel using:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"\n# No need for all the noise, just print errors/warnings if encountered\nmake > /dev/null\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We can speed up the build process by running ",(0,i.jsx)(n.code,{children:"n"})," concurrent jobs;"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"make -jn\n\n# For 16 concurrent jobs\nmake -j16 > /dev/null\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://ccache.dev/",children:(0,i.jsx)(n.code,{children:"ccache"})})," and ",(0,i.jsx)(n.a,{href:"https://www.distcc.org/",children:(0,i.jsx)(n.code,{children:"distcc"})})," can improve kernel build time as well."]}),"\n",(0,i.jsx)(n.h2,{id:"installing-the-kernel",children:"Installing the Kernel"}),"\n",(0,i.jsx)(n.p,{children:"The installation is architecture and bootloader dependent. We need to find the directions for the bootloader on where it's expecting the kernel image and how to set it up to boot."}),"\n",(0,i.jsxs)(n.p,{children:["On x86 system using ",(0,i.jsx)(n.code,{children:"grub"}),", you would:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cp arch/i386/boot/bzImage /boot\nmv /boot/vmlinuz-version\n"})}),"\n",(0,i.jsxs)(n.p,{children:["And then edit ",(0,i.jsx)(n.code,{children:"/boot/grub/grub.conf"})," and adding a new entry for the new kernel."]}),"\n",(0,i.jsx)(n.h2,{id:"linux-kernel-attributes",children:"Linux Kernel Attributes"}),"\n",(0,i.jsxs)(n.h3,{id:"no-libc-or-standard-headers",children:["No ",(0,i.jsx)(n.code,{children:"libc"})," or Standard Headers"]}),"\n",(0,i.jsx)(n.p,{children:"This means that the kernel is not linked to any library because of speed and size. The full C library is too large and inefficient for the kernel."}),"\n",(0,i.jsxs)(n.p,{children:["Many usual ",(0,i.jsx)(n.code,{children:"libc"})," functions are implemented inside the kernel such as ",(0,i.jsx)(n.code,{children:"lib/string.c"}),". All we need to do is to include ",(0,i.jsx)(n.code,{children:"<linux/string.h>"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"no-memory-protection",children:"No Memory Protection"}),"\n",(0,i.jsxs)(n.p,{children:["Make sure to not dereference a ",(0,i.jsx)(n.code,{children:"NULL"})," pointer which will cause a major kernel error (",(0,i.jsx)(n.code,{children:"oops"}),").\nThe kernel memory is not pageable so every byte consumed in memory is one less available physical memory."]}),"\n",(0,i.jsx)(n.h3,{id:"no-floating-point",children:"No Floating Point"}),"\n",(0,i.jsx)(n.p,{children:"Using a floating point inside the kernel requires manually saving and restoring the floating point registers. Don't do this!"}),"\n",(0,i.jsx)(n.h3,{id:"stack",children:"Stack"}),"\n",(0,i.jsx)(n.p,{children:"The user-space has a large stack that can grow dynamically. The kernel stack is small and fixed-size depending on architecture. On x86, the stack is configurable at compile-time and can be either 4KB or 8KB. Each process receives its own stack."}),"\n",(0,i.jsx)(n.h3,{id:"sync-and-concurrency",children:"Sync and Concurrency"}),"\n",(0,i.jsx)(n.p,{children:"The kernel is susceptible to race conditions since it's a multitasking operating system, supports SMP, interrupts occur asynchronously with respect to the currently executing code."})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>d,x:()=>l});var i=r(96540);const s={},t=i.createContext(s);function d(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:d(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);