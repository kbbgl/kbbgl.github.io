"use strict";(globalThis.webpackChunkkgkb=globalThis.webpackChunkkgkb||[]).push([[61370],{31213:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var r=s(74848),i=s(28453);const a={slug:"managing-aks-azure",title:"Managing AKS in Azure",authors:["kgal-akl"],tags:["microsoft","azure","cloud","aks","kubernetes","az","cli","k8s"]},t=void 0,o={id:"cloud_services/azure/aks",title:"Managing AKS in Azure",description:"Workload Identity",source:"@site/docs/cloud_services/azure/aks.md",sourceDirName:"cloud_services/azure",slug:"/cloud_services/azure/managing-aks-azure",permalink:"/docs/cloud_services/azure/managing-aks-azure",draft:!1,unlisted:!1,tags:[{inline:!0,label:"microsoft",permalink:"/docs/tags/microsoft"},{inline:!0,label:"azure",permalink:"/docs/tags/azure"},{inline:!0,label:"cloud",permalink:"/docs/tags/cloud"},{inline:!0,label:"aks",permalink:"/docs/tags/aks"},{inline:!0,label:"kubernetes",permalink:"/docs/tags/kubernetes"},{inline:!0,label:"az",permalink:"/docs/tags/az"},{inline:!0,label:"cli",permalink:"/docs/tags/cli"},{inline:!0,label:"k8s",permalink:"/docs/tags/k-8-s"}],version:"current",frontMatter:{slug:"managing-aks-azure",title:"Managing AKS in Azure",authors:["kgal-akl"],tags:["microsoft","azure","cloud","aks","kubernetes","az","cli","k8s"]},sidebar:"docsSidebar",previous:{title:"Managing Users in Azure Entra ID",permalink:"/docs/cloud_services/azure/managing-users-azure-entra-id"},next:{title:"Managing Azure Container Apps using in Azure CLI",permalink:"/docs/cloud_services/azure/managing-azure-container-app"}},c={},l=[{value:"Workload Identity",id:"workload-identity",level:2},{value:"Check Workload Identity",id:"check-workload-identity",level:3},{value:"Enable Workload Identity",id:"enable-workload-identity",level:3},{value:"Create Workload Identity",id:"create-workload-identity",level:3},{value:"Link Kubernetes Service Account to AKS Managed Account",id:"link-kubernetes-service-account-to-aks-managed-account",level:3},{value:"Grant Permissions to Azure Key Vault",id:"grant-permissions-to-azure-key-vault",level:3}];function d(e){const n={code:"code",h2:"h2",h3:"h3",pre:"pre",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"workload-identity",children:"Workload Identity"}),"\n",(0,r.jsx)(n.h3,{id:"check-workload-identity",children:"Check Workload Identity"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'az aks show \\\n--resource-group $AZURE_RESOURCE_GROUP \\\n--name $AKS_CLUSTER_NAME \\\n--query "oidcIssuerProfile" -o json\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "enabled": false,\n  "issuerUrl": null\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"enable-workload-identity",children:"Enable Workload Identity"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"az aks update \\\n--resource-group $AZURE_RESOURCE_GROUP \\\n--name $AKS_CLUSTER_NAME \\\n--enable-oidc-issuer \\\n--enable-workload-identity\n"})}),"\n",(0,r.jsx)(n.h3,{id:"create-workload-identity",children:"Create Workload Identity"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'AZURE_IDENTITY_NAME="kbbgl-azure-test-wid"\naz identity create \\\n--name $AZURE_IDENTITY_NAME \\\n--resource-group $AZURE_RESOURCE_GROUP\n{\n  "clientId": "$AZURE_CLIENT_ID",\n  "id": "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourcegroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.ManagedIdentity/userAssignedIdentities/$AZURE_MANAGED_IDENTITY",\n  "location": "$AZURE_LOCATION",\n  "name": "$AZURE_MANAGED_IDENTITY",\n  "principalId": "$AZURE_MANAGED_IDENTITY_SP_ID",\n  "resourceGroup": "$AZURE_RESOURCE_GROUP",\n  "systemData": null,\n  "tags": {},\n  "tenantId": "$AZURE_TENANT_ID",\n  "type": "Microsoft.ManagedIdentity/userAssignedIdentities"\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"link-kubernetes-service-account-to-aks-managed-account",children:"Link Kubernetes Service Account to AKS Managed Account"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'AZURE_FEDERATED_CRED_NAME="kbbgl-aks-fed-cred-test"\naz identity federated-credential create \\\n--name "$AZURE_FEDERATED_CRED_NAME" \\\n--identity-name $AZURE_IDENTITY_NAME \\\n--resource-group $AZURE_RESOURCE_GROUP \\\n--issuer $OIDC_ISSUER_URL \\\n--subject "system:serviceaccount:${APP_K8S_GATEWAY_SERVICE_ACCOUNT_NAMESPACE}:${APP_K8S_GATEWAY_SERVICE_ACCOUNT_NAME}" \\\n--audiences api://AzureADTokenExchange\n{\n  "audiences": [\n    "api://AzureADTokenExchange"\n  ],\n  "id": "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourcegroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.ManagedIdentity/userAssignedIdentities/$AZURE_MANAGED_IDENTITY/federatedIdentityCredentials/$AZURE_FEDERATED_CRED_NAME",\n  "issuer": "https://$AZURE_LOCATION.oic.prod-aks.azure.com/$AZURE_TENANT_ID/$AZURE_SUBSCRIPTION_ID/",\n  "name": "$AZURE_FEDERATED_CRED_NAME",\n  "resourceGroup": "$AZURE_RESOURCE_GROUP",\n  "subject": "system:serviceaccount:$AKS_NAMESPACE:$AKS_SERVICE_ACCOUNT_NAME$",\n  "type": "Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials"\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"grant-permissions-to-azure-key-vault",children:"Grant Permissions to Azure Key Vault"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'AZURE_KEYVAULT_NAME="kbbgl-azure-kv-test"\naz role assignment create \\\n--role "Key Vault Secrets Officer" \\\n--assignee $AZURE_MANAGED_IDENTITY_SP_ID \\\n--scope "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.KeyVault/vaults/$AZURE_KEYVAULT_NAME"\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "condition": null,\n  "conditionVersion": null,\n  "createdBy": null,\n  "createdOn": "1970-01-01T00:00:00.00000+00:00",\n  "delegatedManagedIdentityResourceId": null,\n  "description": null,\n  "id": "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.KeyVault/vaults/$AZURE_KEYVAULT_NAME/providers/Microsoft.Authorization/roleAssignments/$AZURE_ASSIGNMENT_UUID",\n  "name": "$AZURE_ASSIGNMENT_UUID",\n  "principalId": "$AZURE_MANAGED_IDENTITY_SP_ID",\n  "principalType": "ServicePrincipal",\n  "resourceGroup": "$AZURE_RESOURCE_GROUP",\n  "roleDefinitionId": "/subscriptions/$AZURE_SUBSCRIPTION_ID/providers/Microsoft.Authorization/roleDefinitions/$UUID",\n  "scope": "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.KeyVault/vaults/$AZURE_KEYVAULT_NAME",\n  "type": "Microsoft.Authorization/roleAssignments",\n  "updatedOn": "1970-01-01T00:00:00.00000+00:00"\n}\n\naz role assignment create \\\n--role "Key Vault Certificates Officer" \\\n--assignee $AZURE_MANAGED_IDENTITY_SP_ID \\\n--scope "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.KeyVault/vaults/$AZURE_KEYVAULT_NAME"\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "condition": null,\n  "conditionVersion": null,\n  "createdBy": null,\n  "createdOn": "1970-01-01T00:00:00.00000+00:00",\n  "delegatedManagedIdentityResourceId": null,\n  "description": null,\n  "id": "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.KeyVault/vaults/$AZURE_KEYVAULT_NAME/providers/Microsoft.Authorization/roleAssignments/$UUID",\n  "name": "$UUID",\n  "principalId": "$AZURE_MANAGED_IDENTITY_SP_ID",\n  "principalType": "ServicePrincipal",\n  "resourceGroup": "$AZURE_RESOURCE_GROUP",\n  "roleDefinitionId": "/subscriptions/$AZURE_SUBSCRIPTION_ID/providers/Microsoft.Authorization/roleDefinitions/a4417e6f-fecd-4de8-b567-7b0420556985",\n  "scope": "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.KeyVault/vaults/$AZURE_KEYVAULT_NAME",\n  "type": "Microsoft.Authorization/roleAssignments",\n  "createdOn": "1970-01-01T00:00:00.00000+00:00"\n}\n'})})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>o});var r=s(96540);const i={},a=r.createContext(i);function t(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);