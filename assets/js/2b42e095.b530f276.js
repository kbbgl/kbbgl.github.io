"use strict";(globalThis.webpackChunkkgkb=globalThis.webpackChunkkgkb||[]).push([[13016],{30391:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>l,metadata:()=>r,toc:()=>i});var t=s(74848),a=s(28453);const l={title:"How to Create an EKS Cluster using eksctl",slug:"how-to-create-eks-cluster-ekctl",app2or:"kgal-akl",tags:["devops","k8s","kubernetes","kubectl","eksctl","eks","iam","aws"]},o=void 0,r={id:"cloud_services/aws/eks",title:"How to Create an EKS Cluster using eksctl",description:"Log Into AWS Using CLI",source:"@site/docs/cloud_services/aws/eks.md",sourceDirName:"cloud_services/aws",slug:"/cloud_services/aws/how-to-create-eks-cluster-ekctl",permalink:"/docs/cloud_services/aws/how-to-create-eks-cluster-ekctl",draft:!1,unlisted:!1,tags:[{inline:!0,label:"devops",permalink:"/docs/tags/devops"},{inline:!0,label:"k8s",permalink:"/docs/tags/k-8-s"},{inline:!0,label:"kubernetes",permalink:"/docs/tags/kubernetes"},{inline:!0,label:"kubectl",permalink:"/docs/tags/kubectl"},{inline:!0,label:"eksctl",permalink:"/docs/tags/eksctl"},{inline:!0,label:"eks",permalink:"/docs/tags/eks"},{inline:!0,label:"iam",permalink:"/docs/tags/iam"},{inline:!0,label:"aws",permalink:"/docs/tags/aws"}],version:"current",frontMatter:{title:"How to Create an EKS Cluster using eksctl",slug:"how-to-create-eks-cluster-ekctl",app2or:"kgal-akl",tags:["devops","k8s","kubernetes","kubectl","eksctl","eks","iam","aws"]},sidebar:"docsSidebar",previous:{title:"Manage Elastic Container Registry",permalink:"/docs/cloud_services/aws/aws-ecr"},next:{title:"AWS IAM",permalink:"/docs/cloud_services/aws/aws-iam"}},c={},i=[{value:"Log Into AWS Using CLI",id:"log-into-aws-using-cli",level:2},{value:"Create Cluster",id:"create-cluster",level:2},{value:"Enable CloudWatch Logging on the EKS for authentication events",id:"enable-cloudwatch-logging-on-the-eks-for-authentication-events",level:2},{value:"Interacting With Cluster",id:"interacting-with-cluster",level:2},{value:"Deploying AWS Load Balancer in EKS",id:"deploying-aws-load-balancer-in-eks",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"log-into-aws-using-cli",children:"Log Into AWS Using CLI"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"aws sso login --profile $AWS_PROFILE\n"})}),"\n",(0,t.jsx)(n.h2,{id:"create-cluster",children:"Create Cluster"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'eksctl create cluster \\\n--name $EKS_CLUSTER_NAME \\\n--region $AWS_REGION \\\n--nodegroup-name "kbbgl-nodegroup" \\\n--node-type "t3.medium" \\\n--nodes 1 \\\n--managed\n'})}),"\n",(0,t.jsx)(n.h2,{id:"enable-cloudwatch-logging-on-the-eks-for-authentication-events",children:"Enable CloudWatch Logging on the EKS for authentication events"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'aws eks update-cluster-config \\\n--name $EKS_CLUSTER_NAME \\\n--region $AWS_REGION \\\n--logging \'{"clusterLogging":[{"types":["authenticator"],"enabled":true}]}\'\n'})}),"\n",(0,t.jsx)(n.h2,{id:"interacting-with-cluster",children:"Interacting With Cluster"}),"\n",(0,t.jsx)(n.p,{children:"In cases when we have an existing EKS cluster that we want to interact with once the AWS access token has expired, we need to first reauthenticate with AWS:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"aws sso login --profile $AWS_PROFILE\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Once we're authenticated, we can run the following command to let ",(0,t.jsx)(n.code,{children:"kubectl"})," know that it needs to retrieve the cluster access token using the AWS CLI:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME --profile $AWS_PROFILE\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This will update the ",(0,t.jsx)(n.code,{children:".kubeconfig"})," file to include the necessary AWS command to retrieve the secret and allow interaction with the EKS cluster:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nclusters:\n- cluster:\n    certificate-authority-data: LS0tLS[redacted]\n    server: https://abcdefg.hi2.$AWS_REGION.eks.amazonaws.com\n  name: arn:aws:eks:$AWS_REGION:$AWS_ACCOUNT_ID:cluster/$EKS_CLUSTER_NAME\ncontexts:\n- context:\n    cluster: arn:aws:eks:$AWS_REGION:$AWS_ACCOUNT_ID:cluster/$EKS_CLUSTER_NAME\n    user: arn:aws:eks:$AWS_REGION:$AWS_ACCOUNT_ID:cluster/$EKS_CLUSTER_NAME\n  name: arn:aws:eks:$AWS_REGION:$AWS_ACCOUNT_ID:cluster/$EKS_CLUSTER_NAME\ncurrent-context: arn:aws:eks:$AWS_REGION:$AWS_ACCOUNT_ID:cluster/$EKS_CLUSTER_NAME\nkind: Config\nusers:\n- name: arn:aws:eks:$AWS_REGION:$AWS_ACCOUNT_ID:cluster/$EKS_CLUSTER_NAME\n  user:\n    exec:\n      apiVersion: client.authentication.k8s.io/v1beta1\n      args:\n      - --region\n      - $AWS_REGION\n      - eks\n      - get-token\n      - --cluster-name\n      - $EKS_CLUSTER_NAME\n      - --profile\n      - $AWS_PROFILE\n      command: aws\n"})}),"\n",(0,t.jsxs)(n.p,{children:["We can then run ",(0,t.jsx)(n.code,{children:"kubectl"})," commands."]}),"\n",(0,t.jsx)(n.h2,{id:"deploying-aws-load-balancer-in-eks",children:"Deploying AWS Load Balancer in EKS"}),"\n",(0,t.jsx)(n.p,{children:"First thing we need to do is to install the AWS Load Balancer Controller in the cluster:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"helm repo add eks https://aws.github.io/eks-charts\nhelm repo update\nhelm install aws-load-balancer-controller eks/aws-load-balancer-controller \\\n-n kube-system \\\n-f values.yaml\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The helm chart will deploy a ",(0,t.jsx)(n.code,{children:"Pod"})," and a ",(0,t.jsx)(n.code,{children:"ServiceAccount"})," named ",(0,t.jsx)(n.code,{children:"aws-lb-controller"})," in the ",(0,t.jsx)(n.code,{children:"kube-system"})," namespace (among other things). Per the ",(0,t.jsx)(n.a,{href:"https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/deploy/installation/#configure-iam",children:"AWS documentation"}),":"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"The controller runs on the worker nodes, so it needs access to the AWS ALB/NLB APIs with IAM permissions.\nThe IAM permissions can either be setup using IAM roles for service accounts (IRSA), Pod Identity, or can be attached directly to the worker node IAM roles. The best practice is using IRSA if you're using Amazon EKS."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["To create the AWS Load Balancer Controller IAM policy, we need to download the official policy from ",(0,t.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/aws-load-balancer-controller",children:"GitHub"})," and apply it:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl -o /tmp/iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v3.0.0/docs/install/iam_policy.json\n\naws iam create-policy \\\n--policy-name AWSLoadBalancerControllerIAMPolicy \\\n--policy-document file:///tmp/iam_policy.json \\\n--profile $AWS_PROFILE\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The response will contain the ",(0,t.jsx)(n.code,{children:"PolicyArn"})," that we will need later."]}),"\n",(0,t.jsx)(n.p,{children:"Now that we have the AWS Load Balancer Controller IAM policy, we can create the IAM role and trust policy."}),"\n",(0,t.jsxs)(n.p,{children:["We first need to retrieve the cluster OIDC issuer, AWS account ID an set the AWS Load Balancer Kubernetes ",(0,t.jsx)(n.code,{children:"ServiceAccount"})," and namespace:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'OIDC_ISSUER=$(aws eks describe-cluster --name $EKS_CLUSTER_NAME --query "cluster.identity.oidc.issuer" --output text --profile $AWS_PROFILE)\n# e.g. https://oidc.eks.us-east-1.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E\n\nACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text --profile $AWS_PROFILE)\nOIDC_ID=$(echo $OIDC_ISSUER | sed -e \'s|https://oidc.eks.\'"$AWS_REGION"\'.amazonaws.com/id/||\')\n# EXAMPLED539D4633E53DE1B716D3041E\nSA_NAME=aws-lb-controller\nNAMESPACE=kube-system\n\ncat > /tmp/trust-policy.json << EOF\n{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Principal": {\n        "Federated": "arn:aws:iam::${ACCOUNT_ID}:oidc-provider/oidc.eks.${AWS_REGION}.amazonaws.com/id/${OIDC_ID}"\n      },\n      "Action": "sts:AssumeRoleWithWebIdentity",\n      "Condition": {\n        "StringEquals": {\n          "oidc.eks.${AWS_REGION}.amazonaws.com/id/${OIDC_ID}:sub": "system:serviceaccount:${NAMESPACE}:${SA_NAME}",\n          "oidc.eks.${AWS_REGION}.amazonaws.com/id/${OIDC_ID}:aud": "sts.amazonaws.com"\n        }\n      }\n    }\n  ]\n}\nEOF\n'})}),"\n",(0,t.jsx)(n.p,{children:"And we create the role:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'aws iam create-role \\\n--role-name eks-${EKS_CLUSTER_NAME}-aws-lb-controller \\\n--assume-role-policy-document file:///tmp/trust-policy.json \\\n--description "IRSA for AWS Load Balancer Controller on $EKS_CLUSTER_NAME" \\\n--profile $AWS_PROFILE\n'})}),"\n",(0,t.jsx)(n.p,{children:"And attach the policy to the role:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"aws iam attach-role-policy \\\n--role-name eks-${EKS_CLUSTER_NAME}-aws-lb-controller \\\n--policy-arn arn:aws:iam::${ACCOUNT_ID}:policy/AWSLoadBalancerControllerIAMPolicy \\\n--profile $AWS_PROFILE\n"})}),"\n",(0,t.jsxs)(n.p,{children:["We then annotate the AWS Load Balancer Kubernetes ",(0,t.jsx)(n.code,{children:"ServiceAccount"})," with new role ARN:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'ROLE_ARN=$(aws iam get-role --role-name eks-$EKS_CLUSTER_NAME-aws-lb-controller --query "Role.Arn" --output text --profile $AWS_PROFILE)\n\nkubectl annotate serviceaccounts -n $NAMESPACE aws-lb-controller eks.amazonaws.com/role-arn=$ROLE_ARN --overwrite\n'})}),"\n",(0,t.jsx)(n.p,{children:"Restart the controller to pick up the new role:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl rollout restart deployment -n $NAMESPACE -l app.kubernetes.io/name=aws-load-balancer-controller\n"})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>r});var t=s(96540);const a={},l=t.createContext(a);function o(e){const n=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);