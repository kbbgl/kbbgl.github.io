"use strict";(self.webpackChunkkgkb=self.webpackChunkkgkb||[]).push([[78426],{24974:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var a=t(74848),i=t(28453);const s={slug:"how-to-trace-read-rabbitmq-messages",title:"How To Trace/Read RabbitMQ\xa0Messages",description:"Fill me up!",authors:["kbbgl"],tags:["debugging","docker","kubernetes","rabbitmq","trace"],image_url:"https://tilsupport.files.wordpress.com/2021/04/1_unyl-2r54_7anewqv0cvxa.png"},r=void 0,o={permalink:"/blog/how-to-trace-read-rabbitmq-messages",source:"@site/blog/how-to-trace-read-rabbitmq\xa0messages.md",title:"How To Trace/Read RabbitMQ\xa0Messages",description:"Fill me up!",date:"2025-02-26T01:16:43.000Z",tags:[{inline:!1,label:"Debugging",permalink:"/blog/tags/debugging"},{inline:!1,label:"Docker",permalink:"/blog/tags/docker"},{inline:!1,label:"Kubernetes",permalink:"/blog/tags/kubernetes"},{inline:!1,label:"Rabbitmq",permalink:"/blog/tags/rabbitmq"},{inline:!1,label:"Trace",permalink:"/blog/tags/trace"}],readingTime:7.335,hasTruncateMarker:!0,authors:[{name:"Kobbi Gal",title:"I like to pick things apart and see how they work inside",url:"https://github.com/kbbgl",imageURL:"https://avatars.githubusercontent.com/u/14372649",key:"kbbgl",page:null}],frontMatter:{slug:"how-to-trace-read-rabbitmq-messages",title:"How To Trace/Read RabbitMQ\xa0Messages",description:"Fill me up!",authors:["kbbgl"],tags:["debugging","docker","kubernetes","rabbitmq","trace"],image_url:"https://tilsupport.files.wordpress.com/2021/04/1_unyl-2r54_7anewqv0cvxa.png"},unlisted:!1,prevItem:{title:"Hack The Box \u2018Archetype\u2019 Challenge",permalink:"/blog/hack-the-box-archetype-challenge"},nextItem:{title:"Installing PiHole On Raspberry Pi 4, MicroK8s running Ubuntu 20.04\xa0(focal)",permalink:"/blog/install-pihole-rpi4-microk8s-ubuntu-2004"}},c={authorsImageUrls:[void 0]},l=[{value:"Introduction",id:"introduction",level:2},{value:"Disclaimer for Performance Degradation",id:"disclaimer-for-performance-degradation",level:2},{value:"Configuration (Optional)",id:"configuration-optional",level:2},{value:"Enabling Tracing Plugin",id:"enabling-tracing-plugin",level:2},{value:"Getting <code>rabbitmqadmin</code> Binary",id:"getting-rabbitmqadmin-binary",level:2},{value:"Creating RabbitMQ Resources and Bindings",id:"creating-rabbitmq-resources-and-bindings",level:2},{value:"Reading Messages",id:"reading-messages",level:2},{value:"Cleanup",id:"cleanup",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,a.jsx)(n.p,{children:"This week, I needed to debug a production issue where one of the critical ReactJS applications happened to load exactly after 60 seconds."}),"\n",(0,a.jsx)(n.p,{children:"When I opened the browser development tools network tab, I saw that the request was stuck in Pending state indicating that it was waiting for the server to respond."}),"\n",(0,a.jsx)(n.p,{children:"As I am already quite familiar with the relevant GraphQL server which works as a backend for this ReactJS application, I knew that the constant 60 seconds response time was no coincidence. It was a hardcoded RabbitMQ RPC (Remote Procedure Call) timeout which is configured systemwide. This means that any microservice in the cluster has 60 seconds to respond to the RPC, and if it doesn\u2019t do so by that interval, the message is dropped. In order to further debug the issue, I needed to somehow figure out which RPC call was stuck as neither the RabbitMQ or the GraphQL services DEBUG/TRACE logs had printed information about these RPCs."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:"https://www.cloudamqp.com/img/blog/workflow-rabbitmq.png",alt:"broker"})}),"\n",(0,a.jsxs)(n.p,{children:["Microservices use the RabbitMQ message broker to transfer messages between them. These messages, when consumed by the destination service, will ",(0,a.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Glossary/TCP_handshake",children:(0,a.jsx)(n.code,{children:"ACK"})})," with a response message to the service which requested the information. Once the reply was accepted by the requesting service, the message is deleted from the queue."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:"https://www.cloudamqp.com/img/blog/exchanges-bidings-routing-keys.png",alt:"queue"})}),"\n",(0,a.jsx)(n.p,{children:"In some cases, such as investigation of this issue, we would need to be able to review which messages were published and consumed in the RabbitMQ message broker prior to deletion."}),"\n",(0,a.jsx)(n.p,{children:"This tutorial will explain how to enable message tracing to be able to review the messages published and consumed. It was created because I found it very frustrating that the official RabbitMQ documentation for this feature and its relevant plugin were unclear, not up-to-date and not procedural."}),"\n",(0,a.jsx)(n.h2,{id:"disclaimer-for-performance-degradation",children:"Disclaimer for Performance Degradation"}),"\n",(0,a.jsxs)(n.p,{children:["Enabling message tracing is a very costly operation and increases the processing and memory consumption of the ",(0,a.jsx)(n.a,{href:"https://www.erlang.org/doc/man/erl.html",children:(0,a.jsx)(n.code,{children:"erl"})})," process/RabbitMQ container."]}),"\n",(0,a.jsxs)(n.p,{children:["You might need to increase the ",(0,a.jsx)(n.a,{href:"https://www.rabbitmq.com/memory.html#threshold",children:"RabbitMQ memory watermark"})," and/or the RabbitMQ container memory/CPU limits in the environment where you\u2019re debugging. It is mandatory to clean up thereafter (see last section on how to do so)."]}),"\n",(0,a.jsx)(n.p,{children:"The environment where this issue was occurring was in an Ubuntu server running a Kubernetes 3-node cluster where the RabbitMQ container was running as a ClusterIP Service (which means it\u2019s only exposed to internally). With some minor modifications, it could also be tweaked to be relevant for Windows environments."}),"\n",(0,a.jsxs)(n.p,{children:["Follow ",(0,a.jsxs)(n.a,{href:"https://www.rabbitmq.com/management-cli.html",children:["these instruction\xa0on how to set up ",(0,a.jsx)(n.code,{children:"rabbitmqadmin"})," for Windows environments"]}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"configuration-optional",children:"Configuration (Optional)"}),"\n",(0,a.jsx)(n.p,{children:"We can create a configuration file which we will use to authenticate the commands we\u2019ll send to the RabbitMQ service. This will save us some time as we won\u2019t need to specify mandatory arguments for every command we type and can use the configuration file instead which will include these arguments.\nOne of the mandatory arguments is the IP where the RabbitMQ service is running. We can retrieve the IP by running the following command:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl get endpoints rabbitmq-ha -n prod -o=jsonpath='{.subsets[0].addresses[0].ip}'\n \n192.168.1.15\n"})}),"\n",(0,a.jsx)(n.p,{children:"Let\u2019s create a configuration file:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"cat <<EOT >> /tmp/rmq.conf\n# Name of instance we want to connect to\n[instance]\n \n# Host/IP where the RabbitMQ server is running\nhostname = 192.168.1.15\n \n# RabbitMQ credentials\nusername = YOUR_UN\npassword = YOUR_PW\nEOT\nnano \n"})}),"\n",(0,a.jsx)(n.p,{children:"Inside the text editor, specify the following:"}),"\n",(0,a.jsxs)(n.p,{children:["Notice that the file follows the ",(0,a.jsx)(n.a,{href:"https://docs.python.org/3/library/configparser.html#supported-ini-file-structure",children:"Python INI configuration"})," format. This is because ",(0,a.jsx)(n.code,{children:"rabbitmqadmin"})," is written in Python."]}),"\n",(0,a.jsx)(n.h2,{id:"enabling-tracing-plugin",children:"Enabling Tracing Plugin"}),"\n",(0,a.jsxs)(n.p,{children:["RabbitMQ ships by default with a plugin called ",(0,a.jsx)(n.code,{children:"rabbitmq_tracing"}),".\nTo enable it, we run the following command:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl exec rabbitmq-ha-0 -c rabbitmq-ha -n prod -- rabbitmq-plugins enable rabbitmq_tracing\n"})}),"\n",(0,a.jsx)(n.p,{children:"We can verify that the plugin was enabled by running:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl exec rabbitmq-ha-0 -c rabbitmq-ha -n prod -- rabbitmq-plugins list\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Enabling the ",(0,a.jsx)(n.code,{children:"rabbitmq_tracing"})," plugin creates a new exchange named ",(0,a.jsx)(n.code,{children:"amq.rabbitmq.trace"})," where all messages sent to the vhost will be forwarded to."]}),"\n",(0,a.jsxs)(n.h2,{id:"getting-rabbitmqadmin-binary",children:["Getting ",(0,a.jsx)(n.code,{children:"rabbitmqadmin"})," Binary"]}),"\n",(0,a.jsxs)(n.p,{children:["In order to read the forwarded messages, we would need to create a new queue where all messages will be sent to and bind this new queue to the ",(0,a.jsx)(n.code,{children:"amq.rabbitmq.trace"})," exchange."]}),"\n",(0,a.jsxs)(n.p,{children:["The fastest way to do this is using the ",(0,a.jsx)(n.code,{children:"rabbitmqadmin"})," command line tool."]}),"\n",(0,a.jsx)(n.p,{children:"We can download it from different locations but the best place is from the container itself as it will pair with the exact version of the RabbitMQ server running in the container. To copy the binary to the host machine, we run the following command:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl cp rabbitmq-ha-0:/var/lib/rabbitmq/mnesia/rabbit@rabbitmq-ha-0.rabbitmq-ha-discovery.prod.svc.cluster.local-plugins-expand/rabbitmq_management-$VERSION/priv/www/cli/rabbitmqadmin -c rabbitmq-ha ~/rabbitmqadmin\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This will download the ",(0,a.jsx)(n.code,{children:"rabbitmqadmin"})," command line tool to the home (~) directory.\nIt\u2019s worth to keep in mind that the path might be different in other deployments as this tutorial was tested with a specific RabbitMQ version (represented by ",(0,a.jsx)(n.code,{children:"$VERSION"}),")."]}),"\n",(0,a.jsxs)(n.p,{children:["To use the ",(0,a.jsx)(n.code,{children:"rabbitmqadmin"})," tool, we need to either (a) specify the configuration file path created in the ",(0,a.jsx)(n.a,{href:"#configuration-optional",children:"Configuration section"})," or (b) the command line arguments for the host, user and password alongside the rest of the commands."]}),"\n",(0,a.jsx)(n.p,{children:"Option (a) will be used for the remainder of the document but if you insist on not creating a configuration file, you can also run the commands in the following format:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ip=$(kubectl get endpoints -n prod rabbitmq-ha -o=jsonpath='{.subsets[0].addresses[0].ip}')\nrabbitmqadmin -H $ip -u YOUR_USERNAME -p YOUR_PASSWORD ...[rest of commands]\n"})}),"\n",(0,a.jsx)(n.h2,{id:"creating-rabbitmq-resources-and-bindings",children:"Creating RabbitMQ Resources and Bindings"}),"\n",(0,a.jsx)(n.p,{children:"Now that we have the tool to use to interact with the RabbitMQ cluster, we need to do two things before we\u2019re able to read the RPC messages:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"rabbitmqadmin -c /tmp/rmq.conf -N instance declare queue name=debug\n"})}),"\n",(0,a.jsxs)(n.ol,{start:"2",children:["\n",(0,a.jsxs)(n.li,{children:["Bind the debug queue to the exchange ",(0,a.jsx)(n.code,{children:"amq.rabbitmq.trace"}),". To do this, run the following command:"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"rabbitmqadmin -c /tmp/rmq.conf -N instance declare binding source=amq.rabbitmq.trace destination=debug routing_key=#\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"routing_key=#"})," parameter ensures that we forward all published, delivered and consumed messages across queues and exchanges to the bound debug queue."]}),"\n",(0,a.jsx)(n.h2,{id:"reading-messages",children:"Reading Messages"}),"\n",(0,a.jsx)(n.p,{children:"Now that all messages are set up to be forwarded to queue debug, we can see how many there are. In the example below we have 317 messages:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"rabbitmqadmin -c /tmp/rmq.conf -N instance get queue=debug\n+-------------+--------------------+---------------+---------+---------------+------------------+-------------+\n| routing_key |      exchange      | message_count | payload | payload_bytes | payload_encoding | redelivered |\n+-------------+--------------------+---------------+---------+---------------+------------------+-------------+\n| publish.    | amq.rabbitmq.trace | 317           | {}      | 2             | string           | False       |\n+-------------+--------------------+---------------+---------+---------------+------------------+-------------+\n"})}),"\n",(0,a.jsx)(n.p,{children:"We can also read the actual payload. Here we specify to read the first 5 (includes only the headers, not actual data):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"rabbitmqadmin -c /tmp/rmq.conf -N instance get queue=debug count=5\n \n+--------------------------------------+--------------------+---------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+------------------+-------------+\n|             routing_key              |      exchange      | message_count |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | payload_bytes | payload_encoding | redelivered |\n+--------------------------------------+--------------------+---------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+------------------+-------------+\n|...\n"})}),"\n",(0,a.jsxs)(n.p,{children:["A better way to see the messages would be to connect to the queue as a consumer. We can do this faily easily by using the ",(0,a.jsxs)(n.a,{href:"https://pika.readthedocs.io/en/stable/",children:[(0,a.jsx)(n.code,{children:"pika"})," Python library"]}),".\nWe first need to install it:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pip install pika\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Then we can use the following script ",(0,a.jsx)(n.code,{children:"receive.py"})," to connect to it:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"#!/usr/bin/env python\nimport pika, sys, os\n \ndef main():\n    cred = pika.PlainCredentials(username=YOUR_USER, password=YOUR_PASSWORD)\n    connection = pika.BlockingConnection(pika.ConnectionParameters(host='192.168.1.15', credentials=cred))\n    channel = connection.channel()\n \n    channel.queue_declare(queue='debug', durable=True)\n \n    def callback(ch, method, properties, body):\n         \n        print(\" [x] Received method '{}', body {}\".format(method.routing_key, body.decode()))\n \n    channel.basic_consume(queue='debug', on_message_callback=callback, auto_ack=True)\n \n    print(' [*] Waiting for messages. To exit press CTRL+C')\n    channel.start_consuming()\n \nif __name__ == '__main__':\n    try:\n        main()\n    except KeyboardInterrupt:\n        print('Interrupted')\n        try:\n            sys.exit(0)\n        except SystemExit:\n            os._exit(0)\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Keep in mind that you need to change the ",(0,a.jsx)(n.code,{children:"YOUR_USER"})," and ",(0,a.jsx)(n.code,{children:"YOUR_PASSWORD"})," values (as well as the ",(0,a.jsx)(n.code,{children:"host=IP"}),") according to your credentials/address."]}),"\n",(0,a.jsx)(n.p,{children:"We can then run the script to begin consuming the messages:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"chmod u+x receive.py\n./receive.py\n \n[x] Received u'{...}'\n"})}),"\n",(0,a.jsx)(n.p,{children:"This is the stage where we would use the payload to troubleshoot our issue. In the specific case I was debugging, we found that the environment had an RPC timeout because of a very large database query to retrieve data for thousands of resources created in the application. We recommended a scaling solution to resolve it."}),"\n",(0,a.jsx)(n.h2,{id:"cleanup",children:"Cleanup"}),"\n",(0,a.jsx)(n.p,{children:"Creating the debug queue without consumers means that the messages will get stuck there forever. This could lead to increase in server/container resources, specifically RAM, disk and CPU and in turn, to severe application performance degradation. Thererfore, it\u2019s required to erase all created resources before terminating the session."}),"\n",(0,a.jsx)(n.p,{children:"We first need to remove the binding between the exchange and the queue to stop forwarding messages to the queue. To do this, we run the following command:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'rabbitmqadmin -c /tmp/rmq.conf -N instance delete binding source=amq.rabbitmq.trace destination=debug destination_type=queue properties_key="#"\nbinding deleted\n'})}),"\n",(0,a.jsx)(n.p,{children:"Next step is to purge (i.e. delete/remove) all the messages in the debug queue:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"rabbitmqadmin -c /tmp/rmq.conf -N instance purge queue name=debug\nqueue purged\n"})}),"\n",(0,a.jsx)(n.p,{children:"Delete the debug queue:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"rabbitmqadmin -c /tmp/rmq.conf -N instance delete queue name=debug\nqueue deleted\n"})}),"\n",(0,a.jsxs)(n.p,{children:["And finally, disable the ",(0,a.jsx)(n.code,{children:"rabbitmq_tracing"})," plugin to remove the ",(0,a.jsx)(n.code,{children:"amq.rabbitmq.trace"})," exchange:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl exec rabbitmq-ha-0 -c rabbitmq-ha -n prod -- rabbitmq-plugins disable rabbitmq_tracing\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var a=t(96540);const i={},s=a.createContext(i);function r(e){const n=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);