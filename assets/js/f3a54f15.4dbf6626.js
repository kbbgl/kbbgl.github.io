"use strict";(self.webpackChunkkgkb=self.webpackChunkkgkb||[]).push([[74912],{86112:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>d});var s=t(74848),o=t(28453);const i={slug:"add-flaky-network",title:"How to Add Network Flakiness",description:"How to add network flakiness for testing applications.",authors:["kgal-akl"],tags:["network","testing","development","vm","linux","kernel","traffic","latency","performance","kubernetes","k8s","chaos"]},a=void 0,r={id:"software/chaos/jitter",title:"How to Add Network Flakiness",description:"How to add network flakiness for testing applications.",source:"@site/docs/software/chaos/jitter.md",sourceDirName:"software/chaos",slug:"/software/chaos/add-flaky-network",permalink:"/docs/software/chaos/add-flaky-network",draft:!1,unlisted:!1,tags:[{inline:!0,label:"network",permalink:"/docs/tags/network"},{inline:!0,label:"testing",permalink:"/docs/tags/testing"},{inline:!0,label:"development",permalink:"/docs/tags/development"},{inline:!0,label:"vm",permalink:"/docs/tags/vm"},{inline:!0,label:"linux",permalink:"/docs/tags/linux"},{inline:!0,label:"kernel",permalink:"/docs/tags/kernel"},{inline:!0,label:"traffic",permalink:"/docs/tags/traffic"},{inline:!0,label:"latency",permalink:"/docs/tags/latency"},{inline:!0,label:"performance",permalink:"/docs/tags/performance"},{inline:!0,label:"kubernetes",permalink:"/docs/tags/kubernetes"},{inline:!0,label:"k8s",permalink:"/docs/tags/k-8-s"},{inline:!0,label:"chaos",permalink:"/docs/tags/chaos"}],version:"current",frontMatter:{slug:"add-flaky-network",title:"How to Add Network Flakiness",description:"How to add network flakiness for testing applications.",authors:["kgal-akl"],tags:["network","testing","development","vm","linux","kernel","traffic","latency","performance","kubernetes","k8s","chaos"]},sidebar:"docsSidebar",previous:{title:"Introduction",permalink:"/docs/"},next:{title:"How to Set Up GitLab Self-Hosted Runner",permalink:"/docs/software/cicd/how-to-setup-gitlab-self-hosted-runner"}},l={},d=[];function c(e){const n={code:"code",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["On a VM, we can use the ",(0,s.jsx)(n.code,{children:"tc"})," tool to manipulate outbound traffic control."]}),"\n",(0,s.jsxs)(n.p,{children:["On an Azure VM that has a ",(0,s.jsx)(n.code,{children:"k3s"})," cluster deployed, the traffic path from an application running in a Pod to SaaS service would go like this:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Gateway Pod -> ",(0,s.jsx)(n.code,{children:"cni0"})," (bridge)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cni0"})," -> host routing"]}),"\n",(0,s.jsxs)(n.li,{children:["Host -> physical interface (",(0,s.jsx)(n.code,{children:"eth0"}),") -> internet"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["So we will apply ",(0,s.jsx)(n.code,{children:"tc"})," rules to the ",(0,s.jsx)(n.code,{children:"eth0"})," interface. We can display information about the interface:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kgal@kgal-azure-dev:~$ ip a show eth0\n\n6: cni0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc prio state UP group default qlen 1000\n    link/ether da:01:a4:37:22:4e brd ff:ff:ff:ff:ff:ff\n    inet 10.42.0.1/24 brd 10.42.0.255 scope global cni0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::5884:dfff:fe48:9a1/64 scope link\n       valid_lft forever preferred_lft forever\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The first step is to create a root queueing discipline (A.K.A. ",(0,s.jsx)(n.code,{children:"qdisc"}),"). Whenever the kernel needs to send a packet to an interface, it is enqueued to the ",(0,s.jsx)(n.code,{children:"qdisc"})," configured for that interface. Immediately afterwards, the kernel tries to get as  many  packets  as possible from the ",(0,s.jsx)(n.code,{children:"qdisc"}),", for giving them to the network adaptor driver."]}),"\n",(0,s.jsxs)(n.p,{children:["To create a root ",(0,s.jsx)(n.code,{children:"qdisc"})," on ",(0,s.jsx)(n.code,{children:"en0"})," interface with 500ms delay, 50ms jitter and 10% packet loss:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'SAAS_IPS=("123.123.123.123" "122.122.122.122")\nPODS_IPS=($(kubectl get pod -n  -l "app.kubernetes.io/name=myapp" -o jsonpath=\'{.items[*].status.podIP}\'))\necho $POD_IPS\n("10.42.0.73" "10.42.0.74" "10.42.0.75")\n\nDELAY_MS=500\nJITTER_MS=50\nCONNECTION_LOSS_PERCENTAGE=10\n\n# 1. Clear any existing config on the physical interface\nsudo tc qdisc del dev eth0 root 2>/dev/null\n\n# 2. Add the root priority qdisc\nsudo tc qdisc add dev eth0 root handle 1: prio\n\n# 3. Create the netem "Chaos Lane" (Handle 10: attached to Band 1:1)\nsudo tc qdisc add dev eth0 parent 1:1 handle 10: netem delay "${DELAY_MS}ms" "${JITTER_MS}ms" loss "${CONNECTION_LOSS_PERCENTAGE}"\n\nfor s_ip in "${SAAS_IPS[@]}"; do\n  for p_ip in "${POD_IPS[@]}"; do\n    sudo iptables -t mangle -A POSTROUTING -s "$p_ip" -d "$s_ip" -j MARK --set-mark 1\n  done\ndone\n\n# 5. Direct marked traffic into the Chaos Lane\nsudo tc filter add dev eth0 protocol ip parent 1:0 prio 1 handle 1 fw flowid 1:1\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," Adding this will destabilize the VM where this is run from."]}),"\n",(0,s.jsx)(n.p,{children:"To remove all rules:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo tc qdisc del dev cni root\n"})})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var s=t(96540);const o={},i=s.createContext(o);function a(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);