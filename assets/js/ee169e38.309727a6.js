"use strict";(globalThis.webpackChunkkgkb=globalThis.webpackChunkkgkb||[]).push([[22607],{496:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>l,metadata:()=>r,toc:()=>d});var a=t(74848),i=t(28453);const l={slug:"how-to-deploy-app-with-azure-workload-identity",title:"How To Deploy Application with Azure Workload Identity",description:"This blog post describes how to set up split tunneling with a VPN on MacOS.",authors:["kgal-akl"],tags:["cloud","azure","aks","workload_identity","k8s","kubernetes","federation"],date:new Date("2026-02-24T00:00:00.000Z")},o=void 0,r={permalink:"/blog/how-to-deploy-app-with-azure-workload-identity",source:"@site/blog/how-to-deploy-app-with-azure-workload-identity.md",title:"How To Deploy Application with Azure Workload Identity",description:"This blog post describes how to set up split tunneling with a VPN on MacOS.",date:"2026-02-24T00:00:00.000Z",tags:[{inline:!0,label:"cloud",permalink:"/blog/tags/cloud"},{inline:!0,label:"azure",permalink:"/blog/tags/azure"},{inline:!0,label:"aks",permalink:"/blog/tags/aks"},{inline:!0,label:"workload_identity",permalink:"/blog/tags/workload-identity"},{inline:!1,label:"K8s",permalink:"/blog/tags/k-8-s"},{inline:!1,label:"Kubernetes",permalink:"/blog/tags/kubernetes"},{inline:!0,label:"federation",permalink:"/blog/tags/federation"}],readingTime:2.475,hasTruncateMarker:!1,authors:[{name:"Kobbi Gal (Akeyless)",title:"Escalations Engineer at Akeyless",url:"https://github.com/kgal-akl",imageURL:"https://avatars.githubusercontent.com/u/195813801",key:"kgal-akl",page:null}],frontMatter:{slug:"how-to-deploy-app-with-azure-workload-identity",title:"How To Deploy Application with Azure Workload Identity",description:"This blog post describes how to set up split tunneling with a VPN on MacOS.",authors:["kgal-akl"],tags:["cloud","azure","aks","workload_identity","k8s","kubernetes","federation"],date:"2026-02-24T00:00:00.000Z"},unlisted:!1,nextItem:{title:"How to Deploy Kubernetes Services using Gateway API/AWS Load Balancer Controller",permalink:"/blog/how-to-deploy-k8s-svcs-using-aws-lbc-gw-api"}},s={authorsImageUrls:[void 0]},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Enable OIDC on AKS",id:"enable-oidc-on-aks",level:2},{value:"(Optional) Enable Workload Identity plugin",id:"optional-enable-workload-identity-plugin",level:2},{value:"Create User Assigned Managed Identity for Application",id:"create-user-assigned-managed-identity-for-application",level:2},{value:"Create a Federated Credential",id:"create-a-federated-credential",level:2},{value:"Install Azure Workload Identity Webhook",id:"install-azure-workload-identity-webhook",level:2},{value:"Create a Kubernetes ServiceAccount",id:"create-a-kubernetes-serviceaccount",level:2},{value:"Deploy Application with Workload Identity",id:"deploy-application-with-workload-identity",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"This tutorial is a guide on how to deploy an application in Kubernetes that will authenticate using Azure Workload Identity on Azure Kubernetes Services (AKS)."}),"\n",(0,a.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Access to the Azure CLI and an Azure account."}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"kubectl"})," installed and access to the AKS cluster."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"helm"}),"."]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["See links for more information about ",(0,a.jsx)(n.a,{href:"/docs/cloud_services/azure/azure-identity",children:"Azure Identity"})," and ",(0,a.jsx)(n.a,{href:"/docs/cloud_services/azure/managing-aks-azure",children:"AKS"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"enable-oidc-on-aks",children:"Enable OIDC on AKS"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"/docs/cloud_services/azure/managing-aks-azure#check-workload-identity",children:"Check if the OIDC issuer is enabled in the AKS cluster"}),". ",(0,a.jsx)(n.a,{href:"/docs/cloud_services/azure/managing-aks-azure#enable-workload-identity",children:"Enable it"})," if it's not."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"optional-enable-workload-identity-plugin",children:"(Optional) Enable Workload Identity plugin"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'az aks update \\\n--resource-group "$AZURE_RESOURCE_GROUP" \\\n--name "$AKS_CLUSTER_NAME" \\\n--enable-workload-identity\n'})}),"\n",(0,a.jsxs)(n.p,{children:["This will deploy a ",(0,a.jsx)(n.code,{children:"Deployment"})," named ",(0,a.jsx)(n.code,{children:"azure-wi-webhook-controller-manager"})," in the ",(0,a.jsx)(n.code,{children:"kube-system"})," namespace:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"\u276f kubectl get deploy -n kube-system\nNAME                                  READY   UP-TO-DATE   AVAILABLE   AGE\nazure-wi-webhook-controller-manager   2/2     2            2           48d\n"})}),"\n",(0,a.jsx)(n.p,{children:"This step is optional since we can explicitly specify the application that will use Azure Workload Identity to mount the Azure token as a volume. More on that in a bit."}),"\n",(0,a.jsx)(n.h2,{id:"create-user-assigned-managed-identity-for-application",children:"Create User Assigned Managed Identity for Application"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# Replace with your preferred names and location\nIDENTITY_NAME="app-wi"\nIDENTITY_RG="$AZURE_RESOURCE_GROUP"\nLOCATION="${AZURE_LOCATION:-eastus}"\n\naz identity create --resource-group "$IDENTITY_RG" --name "$IDENTITY_NAME" --location "$LOCATION"\nCLIENT_ID=$(az identity show --resource-group "$IDENTITY_RG" --name "$IDENTITY_NAME" --query clientId -o tsv)\nPRINCIPAL_ID=$(az identity show --resource-group "$IDENTITY_RG" --name "$IDENTITY_NAME" --query principalId -o tsv)\nTENANT_ID=$(az account show --query tenantId -o tsv)\nOIDC_ISSUER=$(az aks show --resource-group "$AZURE_RESOURCE_GROUP" --name "$AKS_CLUSTER_NAME" --query "oidcIssuerProfile.issuerUrl" -o tsv)\n'})}),"\n",(0,a.jsx)(n.h2,{id:"create-a-federated-credential",children:"Create a Federated Credential"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# namespace and service account name that your test app will use\nNAMESPACE="default"\nSA_NAME="app-wi-sa"\n\naz identity federated-credential create \\\n--resource-group "$IDENTITY_RG" \\\n--name "${IDENTITY_NAME}-fc" \\\n--identity-name "$IDENTITY_NAME" \\\n--issuer "$OIDC_ISSUER" \\\n--subject "system:serviceaccount:${NAMESPACE}:${SA_NAME}"\n'})}),"\n",(0,a.jsx)(n.h2,{id:"install-azure-workload-identity-webhook",children:"Install Azure Workload Identity Webhook"}),"\n",(0,a.jsxs)(n.p,{children:["This is what injects ",(0,a.jsx)(n.code,{children:"AZURE_CLIENT_ID"}),", ",(0,a.jsx)(n.code,{children:"AZURE_TENANT_ID"}),", ",(0,a.jsx)(n.code,{children:"AZURE_FEDERATED_TOKEN_FILE"}),", and the projected token volume into pods that use the label. See ",(0,a.jsx)(n.a,{href:"/docs/cloud_services/azure/azure-identity#service-principal-with-secret",children:"Service Principal"})," for more info on those environmental variables."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'helm repo add azure-workload-identity https://azure.github.io/azure-workload-identity/charts\nhelm repo update\nkubectl create namespace azure-workload-identity-system 2>/dev/null || true\nhelm upgrade --install workload-identity-webhook azure-workload-identity/workload-identity-webhook \\\n--namespace azure-workload-identity-system \\\n--set azureTenantId="$TENANT_ID"s\n'})}),"\n",(0,a.jsx)(n.h2,{id:"create-a-kubernetes-serviceaccount",children:"Create a Kubernetes ServiceAccount"}),"\n",(0,a.jsx)(n.p,{children:"Here is where the link between Kubernetes and Azure Workload Identity happens:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'kubectl create namespace "$NAMESPACE" 2>/dev/null || true\nkubectl apply -f - <<EOF\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: $SA_NAME\n  namespace: $NAMESPACE\n  annotations:\n    azure.workload.identity/client-id: "$CLIENT_ID"\nEOF\n'})}),"\n",(0,a.jsxs)(n.p,{children:["As we can see, we annotate the ",(0,a.jsx)(n.code,{children:"ServiceAccount"})," with ",(0,a.jsx)(n.code,{children:'azure.workload.identity/client-id: "$CLIENT_ID"'}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"deploy-application-with-workload-identity",children:"Deploy Application with Workload Identity"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'kubectl apply -f - <<EOF\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hello-wid\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: hello-wid\n  template:\n    metadata:\n      labels:\n        app: hello-wid\n        azure.workload.identity/use: "true"\n    spec:\n      serviceAccountName: $SA_NAME\n      containers:\n      - name: alpine\n        image: alpine\n        command:\n          - "sh"\n          - "-c"\n          - "echo "Workload Identity tutorial done! Sleeping..." && sleep 10000"\nEOF\n'})}),"\n",(0,a.jsx)(n.p,{children:"The main things we're doing here are:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["We set the application ",(0,a.jsx)(n.code,{children:"Deployment"})," to use the ",(0,a.jsx)(n.code,{children:"ServiceAccount"})," we created in the previous step and that is linked to an Azure Workload Identity."]}),"\n",(0,a.jsxs)(n.li,{children:["We set the ",(0,a.jsx)(n.code,{children:"Deployment"})," ",(0,a.jsx)(n.code,{children:"Pod"})," specification to use Azure Workload Identity by setting the label ",(0,a.jsx)(n.code,{children:'azure.workload.identity/use: "true"'}),"."]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var a=t(96540);const i={},l=a.createContext(i);function o(e){const n=a.useContext(l);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(l.Provider,{value:n},e.children)}}}]);