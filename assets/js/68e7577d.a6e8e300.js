"use strict";(self.webpackChunkkgkb=self.webpackChunkkgkb||[]).push([[6624],{89496:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var i=t(74848),s=t(28453);const o={slug:"gulpjs-task-using-powershell",title:"How to Run a Sequential gulp.js Task using\xa0PowerShell",description:"Fill me up!",authors:["kbbgl"],tags:["gulp","gulp.js","gulpjs","script","scripting","task_scheduler","windows"]},a=void 0,l={permalink:"/blog/gulpjs-task-using-powershell",source:"@site/blog/gulpjs-task-using-powershell.md",title:"How to Run a Sequential gulp.js Task using\xa0PowerShell",description:"Fill me up!",date:"2025-02-26T01:16:43.000Z",tags:[{inline:!1,label:"Gulp",permalink:"/blog/tags/gulp"},{inline:!1,label:"Gulp.js",permalink:"/blog/tags/gulp-js"},{inline:!1,label:"Gulpjs",permalink:"/blog/tags/gulpjs"},{inline:!1,label:"Script",permalink:"/blog/tags/script"},{inline:!1,label:"Scripting",permalink:"/blog/tags/scripting"},{inline:!1,label:"Task_scheduler",permalink:"/blog/tags/task-scheduler"},{inline:!1,label:"Windows",permalink:"/blog/tags/windows"}],readingTime:6.83,hasTruncateMarker:!0,authors:[{name:"Kobbi Gal",title:"I like to pick things apart and see how they work inside",url:"https://github.com/kbbgl",imageURL:"https://avatars.githubusercontent.com/u/14372649",key:"kbbgl",page:null}],frontMatter:{slug:"gulpjs-task-using-powershell",title:"How to Run a Sequential gulp.js Task using\xa0PowerShell",description:"Fill me up!",authors:["kbbgl"],tags:["gulp","gulp.js","gulpjs","script","scripting","task_scheduler","windows"]},unlisted:!1,prevItem:{title:"Fixing Ubuntu Hibernation",permalink:"/blog/fixing-ubuntu-hibernation"},nextItem:{title:"Hack The Box \u2018Archetype\u2019 Challenge",permalink:"/blog/hack-the-box-archetype-challenge"}},r={authorsImageUrls:[void 0]},d=[{value:"Introduction",id:"introduction",level:2},{value:"Starting Point",id:"starting-point",level:2},{value:"<code>gulp</code> Research",id:"gulp-research",level:2},{value:"<code>gulp</code> Powered by PowerShell",id:"gulp-powered-by-powershell",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(n.p,{children:"One of our largest and strategic customer recently requested to be able to execute an automated ETL pipeline from one of their Windows multinode cluster in a sequential manner."}),"\n",(0,i.jsx)(n.p,{children:"The ETL pipeline has basically 3-stages:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Initialize an import from their many data sources into a consolidated database on master node."}),"\n",(0,i.jsx)(n.li,{children:"After the import step finishes, copy the flat files representing the consolidated database to the slave nodes."}),"\n",(0,i.jsx)(n.li,{children:"After the copying step is completed, delete the old instance of the database from the slave nodes and launch the newly-copied database."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"The customer\u2019s request rose out of a necessity because there was no way to perform this process in a sequential manner out-of-the-box as the product only by offered using scheduled manner. Since the Windows version of this feature was deprecated and no longer maintained, it was left up to Support to provide a crafty solution to this problem as R&D and Product were not willing to put in hours to add this feature."}),"\n",(0,i.jsx)(n.h2,{id:"starting-point",children:"Starting Point"}),"\n",(0,i.jsxs)(n.p,{children:["Although the product did not supply a way to perform the sequential task out-of-the-box, I did have a pretty solid ground to begin with.\nOn the master node, where the ETL process needs to initilize from, there were a few Windows Services running which allowed the non-sequential, scheduled build and copy operation to be done.\nThe first service was a management service written in .NET/C# that managed the consolidated database instances and exposed a CLI to be able to interact with them. Using this CLI, we\u2019re able to start initialize the ETL process and refresh the remote databases after copying the flat files to the slave nodes.\nThe second service was a NodeJS application which wrapped a ",(0,i.jsx)(n.a,{href:"https://gulpjs.com/",children:(0,i.jsx)(n.code,{children:"gulp.js"})})," task initializer. The tasks were responsible for interacting with the first service using the CLI to perform the following operations:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Initialize the ETL process."}),"\n",(0,i.jsx)(n.li,{children:"After the ETL process finishes on the master node, synchronously copy the database flat files from the master node to the slave nodes."}),"\n",(0,i.jsx)(n.li,{children:"Send a command to the slave nodes to restart the database instance with the copied flat files."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"The way product worked out-of-the-box is to read a configuration file which includes:"}),"\n",(0,i.jsxs)(n.p,{children:["a. The cron pattern to initialize the ",(0,i.jsx)(n.code,{children:"gulp"})," task represented by scheduler.schedule, ",(0,i.jsx)(n.code,{children:"15 20 1 * *"}),".\nb. The slave nodes\u2019 remote copy location. This is where the flat files copied from the master node will be copied into the slave nodes. Represented by ",(0,i.jsx)(n.code,{children:"dbN.slave_path"}),".\nc. The name of the database for which to initialize the ETL process on the master node. Represented by ",(0,i.jsx)(n.code,{children:"tasks.some_db_task.build.db"}),".\nThe configuration file (very redacted) looks something like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "db1": {\n      "db_name": "SomeDB",\n      "slave_path": "\\\\\\\\slave_node_1_hostname\\\\C:\\\\path\\\\to\\\\SomeDB\\\\FlatFiles"\n    },\n    "db1": {\n      "db_name": "SomeDB",\n      "slave_path": "\\\\\\\\slave_node_2_hostname\\\\C:\\\\path\\\\to\\\\SomeDB\\\\FlatFiles"\n    },\n    "scheduler":[  \n      {  \n         "task":"some_db_task",\n         "schedule":"15 20 1 * *",\n         "enabled": true\n      }\n   ],\n   "tasks":{  \n      "some_db_task":[  \n         {  \n            "build":{  \n               "db":[  \n                  "SomeDB"\n                  ]\n            }\n         },\n         {  \n            "distribute":[  \n               "db1.slave_path",\n               "db2.slave_path"\n               ]\n         }\n      ]\n   }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["I figured, if I could find a way to launch the ",(0,i.jsx)(n.code,{children:"gulp"})," task independently, in the example above ",(0,i.jsx)(n.code,{children:"some_db_task"}),", and develop some logic to initialize it sequentially, I would be able to supply a solution to the customer.\nThe first step was to understand how ",(0,i.jsx)(n.code,{children:"gulp"})," tasks worked."]}),"\n",(0,i.jsxs)(n.h2,{id:"gulp-research",children:[(0,i.jsx)(n.code,{children:"gulp"})," Research"]}),"\n",(0,i.jsxs)(n.p,{children:["After reviewing the source code of the NodeJS service which initializes the ",(0,i.jsx)(n.code,{children:"gulp"})," tasks, I found that there are a few ways to run them:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"We can run the task using"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"node.exe /path/to/gulp.js\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"We can specify the task name according to what\u2019s configured:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"node.exe /path/to/gulp.js some_db_task\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Run it using ",(0,i.jsx)(n.code,{children:"gulp"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"gulp some_db_task\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Unfortunately, option 3 was too cumbersome as it required installing NPM/NodeJS on the master node since the product does not install it by default (it just uses the ",(0,i.jsx)(n.code,{children:"node.exe"})," binary). And since the customer requested a specific DB to run this pipeline on, I decided to discard option 1 and develop a script to run option 2."]}),"\n",(0,i.jsx)(n.p,{children:"As I began testing the procedure, I noticed that the gulp tasks created a forked process by which they would interact with the .NET management service. The problem was, once the command to initialize the ETL process finished executing, the process would hang and would not complete the remote copying operations. I needed to figure out what was causing this hang so I opened my IDE to review the source code behind gulp.\nWhat I found was that after the gulp task stopped its execution, it did not gracefully terminate the process. It can be seen here:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"gulpInst.on('task_stop', function(e) {\n    var time = prettyTime(e.hrDuration);\n    gutil.log(\n        'Finished', '\\'' + chalk.cyan(e.task) + '\\'',\n        'after', chalk.magenta(time)\n    );\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:"I added the following line to ensure that the process exited when the task stopped:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"gulpInst.on('task_stop', function(e) {\n    var time = prettyTime(e.hrDuration);\n    gutil.log(\n        'Finished', '\\'' + chalk.cyan(e.task) + '\\'',\n        'after', chalk.magenta(time)\n    );\n    process.exit(0); // <-------- SHOULD BE HERE!\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:"After updating the source code, the hanging processes issue was resolved!\nNext step was to write a script to run the sequential build."}),"\n",(0,i.jsxs)(n.h2,{id:"gulp-powered-by-powershell",children:[(0,i.jsx)(n.code,{children:"gulp"})," Powered by PowerShell"]}),"\n",(0,i.jsxs)(n.p,{children:["My scripting language of choice is bash but since I was working on a Windows environment, without an ability to install 3rd-party tools such as ",(0,i.jsx)(n.code,{children:"cygwin"})," and no access to Python either, I defaulted to PowerShell. The script name is ",(0,i.jsx)(n.code,{children:"gulpTaskSequentialWithWait.ps1"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-powershell",children:'#  -------------------\n#  -------------------\n#  User configuration \n \n# Configurate number of minutes to wait before each ETL\n$waitTimeBetweenBuildsInMinutes = 1\n \n# The gulp task name\n$taskName = "some_db_task"\n \n# log location -default writes to directory where ps script was launched from\n$currentLocation = $PSScriptRoot\n$logLocation = Join-Path -Path $currentLocation -ChildPath "gulpTaskSequential.log"\nWrite-Host "Writing logs to \'$logLocation\'"\n \n#  -------------------\n#  -------------------\n \n \n$workingDir = "C:\\path\\to\\dir"\n$env:NODE_ENV = \'production\'\n$gulpFile = "./node_modules/gulp/bin/gulp.js"\n$nodeJsExecutableFilePath = "node.exe"\n \n \n# Start gulp task infintely\ndo {\n \n     \n    # Create a new process\n    $pinfo = New-Object System.Diagnostics.ProcessStartInfo\n \n    # Set working dir to Orchestrator folder\n    $pinfo.WorkingDirectory = $workingDir\n \n    Write-Host "Changed working dir:" $pinfo.WorkingDirectory\n \n    # Initialize process arguments and output redirection\n    $pinfo.FileName = Join-Path -Path $workingDir -ChildPath $nodeJsExecutableFilePath\n    $pinfo.RedirectStandardError = $true\n    $pinfo.RedirectStandardOutput = $true\n    $pinfo.UseShellExecute = $false\n    $pinfo.CreateNoWindow = $true\n    $pinfo.Arguments = @($gulpFile, $taskName)\n     \n    $p = New-Object System.Diagnostics.Process\n    $p.StartInfo = $pinfo\n    $p.Start() | Out-Null\n     \n    Write-Host (Get-Date -Format U) "Starting task \'$nodeJsExecutableFilePath $gulpFile $taskName\'..."\n    (Get-Date -Format U) + "Starting task \'$nodeJsExecutableFilePath $gulpFile $taskName\'..." | Out-File -FilePath $logLocation -Append\n \n    $stdout = $p.StandardOutput.ReadToEnd()\n    $stderr = $p.StandardError.ReadToEnd()\n    $p.WaitForExit()\n \n    # Terminate process if non-zero exit code returned from command\n    if ($p.ExitCode -ne 0){\n \n        (Get-Date -Format U) +  " exit code: " + $p.ExitCode | Out-File -FilePath $logLocation -Append\n        Write-Host (Get-Date -Format U) "exit code: " $p.ExitCode\n \n        (Get-Date -Format U) +  " stderr: $stderr" | Out-File -FilePath $logLocation -Append\n        Write-Host (Get-Date -Format U) "stderr: $stderr"\n \n        (Get-Date -Format U) + "Exiting.." | Out-File -FilePath $logLocation -Append\n        Write-Host (Get-Date -Format U) "Exiting.."\n        exit\n    } else {\n \n        (Get-Date -Format U) + " stdout: $stdout" | Out-File -FilePath $logLocation -Append\n        Write-Host (Get-Date -Format U) "stdout: $stdout"\n \n        $sleepTimeInSeconds = $waitTimeBetweenBuildsInMinutes * 60\n \n        Write-Host (Get-Date -Format U) " Starting sleep timer: $sleepTimeInSeconds seconds..."\n        (Get-Date -Format U) + " Starting sleep timer: $sleepTimeInSeconds seconds..." | Out-File -FilePath $logLocation -Append\n \n \n        Start-Sleep -Seconds $sleepTimeInSeconds\n \n \n        Write-Host (Get-Date -Format U) "Sleep ended"\n        (Get-Date -Format U) + " Sleep ended" | Out-File -FilePath $logLocation -Append\n \n    }\n} while ($True) \n'})}),"\n",(0,i.jsxs)(n.p,{children:["The script basically runs an infinite loop with a configurable timeout (line 6, variable ",(0,i.jsx)(n.code,{children:"waitTimeBetweenBuildsInMinutes"}),") executing the ",(0,i.jsx)(n.code,{children:"gulp"})," task. We can also configure the name of the task in line 9, variable ",(0,i.jsx)(n.code,{children:"taskName"}),".\nI needed to ensure that the PowerShell script would be initialized after a reboot so I wrote a Task Scheduler XML to automatically start the script upon server boot:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-markup",children:'<?xml version="1.0" encoding="UTF-16"?>\n<Task version="1.2" xmlns="http://schemas.microsoft.com/windows/2004/02/mit/task">\n  <RegistrationInfo>\n    <Date>2020-01-01T00:00:00.0000000</Date>\n    <Author>SOME_DOMAIN\\YOUR_USER</Author>                    \x3c!--Change author--\x3e\n  </RegistrationInfo>\n  <Triggers>\n    <BootTrigger>\n      <ExecutionTimeLimit>PT12H</ExecutionTimeLimit>\n      <Enabled>true</Enabled>\n    </BootTrigger>\n  </Triggers>\n  <Principals>\n    <Principal id="Author">\n      <UserId>SOME_DOMAIN\\YOUR_USER</UserId>                  \x3c!--Change author--\x3e\n      <LogonType>Password</LogonType>\n      <RunLevel>HighestAvailable</RunLevel>\n    </Principal>\n  </Principals>\n  <Settings>\n    <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>\n    <DisallowStartIfOnBatteries>true</DisallowStartIfOnBatteries>\n    <StopIfGoingOnBatteries>true</StopIfGoingOnBatteries>\n    <AllowHardTerminate>true</AllowHardTerminate>\n    <StartWhenAvailable>false</StartWhenAvailable>\n    <RunOnlyIfNetworkAvailable>false</RunOnlyIfNetworkAvailable>\n    <IdleSettings>\n      <StopOnIdleEnd>true</StopOnIdleEnd>\n      <RestartOnIdle>false</RestartOnIdle>\n    </IdleSettings>\n    <AllowStartOnDemand>true</AllowStartOnDemand>\n    <Enabled>true</Enabled>\n    <Hidden>false</Hidden>\n    <RunOnlyIfIdle>false</RunOnlyIfIdle>\n    <WakeToRun>false</WakeToRun>\n    <ExecutionTimeLimit>P1D</ExecutionTimeLimit>\n    <Priority>7</Priority>\n  </Settings>\n  <Actions Context="Author">\n    <Exec>\n      <Command>powershell.exe</Command>\n      <Arguments>-ExecutionPolicy Bypass "C:\\path\\to\\gulpTaskSequentialWithWait.ps1"</Arguments> \x3c!--Change script location--\x3e\n    </Exec>\n  </Actions>\n</Task>\n'})}),"\n",(0,i.jsx)(n.p,{children:"The Task runs the following commands:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-powershell",children:"powershell.exe -ExecutionPolicy Bypass gulpTaskSequentialWithWait.ps1\n"})}),"\n",(0,i.jsx)(n.p,{children:"And ensures that the Task is run on boot:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-markup",children:"<Triggers>\n    <BootTrigger>\n      <ExecutionTimeLimit>PT12H</ExecutionTimeLimit>\n      <Enabled>true</Enabled>\n    </BootTrigger>\n  </Triggers>\n"})}),"\n",(0,i.jsx)(n.p,{children:"Another happy customer!"})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>l});var i=t(96540);const s={},o=i.createContext(s);function a(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);