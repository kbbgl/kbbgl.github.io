"use strict";(self.webpackChunkkgkb=self.webpackChunkkgkb||[]).push([[63925],{16370:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>c,toc:()=>l});var i=s(74848),r=s(28453);const t={title:"NGINX Cookbook",slug:"nginx-cookbook",authors:["kbbgl"],tags:["nginx","proxy","load_balancing","routing","web","server","docker","devops","containers","images"]},a=void 0,c={id:"software/infrastructure/nginx/nginx_cookbook",title:"NGINX Cookbook",description:"Serving Static Content",source:"@site/docs/software/infrastructure/nginx/nginx_cookbook.md",sourceDirName:"software/infrastructure/nginx",slug:"/software/infrastructure/nginx/nginx-cookbook",permalink:"/docs/software/infrastructure/nginx/nginx-cookbook",draft:!1,unlisted:!1,tags:[{inline:!0,label:"nginx",permalink:"/docs/tags/nginx"},{inline:!0,label:"proxy",permalink:"/docs/tags/proxy"},{inline:!0,label:"load_balancing",permalink:"/docs/tags/load-balancing"},{inline:!0,label:"routing",permalink:"/docs/tags/routing"},{inline:!0,label:"web",permalink:"/docs/tags/web"},{inline:!0,label:"server",permalink:"/docs/tags/server"},{inline:!0,label:"docker",permalink:"/docs/tags/docker"},{inline:!0,label:"devops",permalink:"/docs/tags/devops"},{inline:!0,label:"containers",permalink:"/docs/tags/containers"},{inline:!0,label:"images",permalink:"/docs/tags/images"}],version:"current",frontMatter:{title:"NGINX Cookbook",slug:"nginx-cookbook",authors:["kbbgl"],tags:["nginx","proxy","load_balancing","routing","web","server","docker","devops","containers","images"]},sidebar:"docsSidebar",previous:{title:"NGINX Files and Directories",permalink:"/docs/software/infrastructure/nginx/nginx-files-dirs"},next:{title:"Erlang Cookie Location in Windows",permalink:"/docs/software/infrastructure/rabbitmq/rabbitmq-cookie-location-windows"}},o={},l=[{value:"Serving Static Content",id:"serving-static-content",level:2},{value:"High-Performance Load Balancing",id:"high-performance-load-balancing",level:2},{value:"HTTP Load Balancing",id:"http-load-balancing",level:3},{value:"TCP Load Balancing",id:"tcp-load-balancing",level:3},{value:"UDP Load Balancing",id:"udp-load-balancing",level:3},{value:"Load Balancing Methods",id:"load-balancing-methods",level:3},{value:"Health Checks",id:"health-checks",level:3},{value:"Traffic Management",id:"traffic-management",level:2},{value:"Split Clients between different Versions (A/B Testing)",id:"split-clients-between-different-versions-ab-testing",level:3},{value:"Geolocation of Clients Physical Location",id:"geolocation-of-clients-physical-location",level:3},{value:"Restrict Access Based on Country",id:"restrict-access-based-on-country",level:3},{value:"Limiting Connections Based on IP Address",id:"limiting-connections-based-on-ip-address",level:3},{value:"Limiting Rate of Requests by Client IP Address",id:"limiting-rate-of-requests-by-client-ip-address",level:3},{value:"Limiting Bandwidth",id:"limiting-bandwidth",level:3},{value:"Massively Scalable Content Caching",id:"massively-scalable-content-caching",level:2},{value:"Caching Zones",id:"caching-zones",level:3},{value:"Bypass Cache",id:"bypass-cache",level:3},{value:"Cache Performance Boost: Client Side",id:"cache-performance-boost-client-side",level:3},{value:"Programmability",id:"programmability",level:2},{value:"Expose JavaScript Functionality within NGINX",id:"expose-javascript-functionality-within-nginx",level:3},{value:"Authentication",id:"authentication",level:2},{value:"HTTP Basic Authentication",id:"http-basic-authentication",level:3},{value:"Third-Party Authentication System (Subrequest)",id:"third-party-authentication-system-subrequest",level:3},{value:"Security Controls",id:"security-controls",level:2},{value:"Access Based on IP Address",id:"access-based-on-ip-address",level:3},{value:"Enable CORS",id:"enable-cors",level:3},{value:"Client-Side Encryption",id:"client-side-encryption",level:3},{value:"Upstream Encryption",id:"upstream-encryption",level:3},{value:"Securing a Location",id:"securing-a-location",level:3},{value:"Generating a Secure Link with a Secret",id:"generating-a-secure-link-with-a-secret",level:3},{value:"Securing a Location with Expire Date",id:"securing-a-location-with-expire-date",level:3},{value:"Generating an Expiring Link",id:"generating-an-expiring-link",level:3},{value:"Redirect HTTPS",id:"redirect-https",level:3},{value:"HTTP Strict Transport Security (HSTS)",id:"http-strict-transport-security-hsts",level:3},{value:"HTTP/2",id:"http2",level:2},{value:"gRPC",id:"grpc",level:3},{value:"HTTP/2 Server Push",id:"http2-server-push",level:3},{value:"Containers/Microservices",id:"containersmicroservices",level:2},{value:"Using NGINX as an API Gateway",id:"using-nginx-as-an-api-gateway",level:3},{value:"Creating an NGINX Dockerfile",id:"creating-an-nginx-dockerfile",level:3},{value:"Using Environment Variables in NGINX",id:"using-environment-variables-in-nginx",level:3},{value:"Kubernetes Ingress Controller",id:"kubernetes-ingress-controller",level:3},{value:"Prometheus Exporter Module",id:"prometheus-exporter-module",level:3},{value:"Debugging and Troubleshooting",id:"debugging-and-troubleshooting",level:2},{value:"Configuring Access Logs",id:"configuring-access-logs",level:3},{value:"Configuring Error Logs",id:"configuring-error-logs",level:3},{value:"Forwarding to Syslog",id:"forwarding-to-syslog",level:3},{value:"Request Tracing",id:"request-tracing",level:3}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"serving-static-content",children:"Serving Static Content"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"server {\n listen 80 default_server;\n server_name www.example.com;\n location / {\n root /usr/share/nginx/html;\n # alias /usr/share/nginx/html;\n index index.html index.htm;\n }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This configuration serves static files over HTTP on port 80 from the directory ",(0,i.jsx)(n.code,{children:"/usr/share/nginx/html/"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"server_name"})," directive defines the hostname or the names of requests that should be directed to this server. If the configuration had not defined this context as the ",(0,i.jsx)(n.code,{children:"default_server"}),", NGINX would direct requests to this server only if the HTTP host header matched the value provided to the ",(0,i.jsx)(n.code,{children:"server_name"})," directive. With the ",(0,i.jsx)(n.code,{children:"default_server"})," context set, you can omit the ",(0,i.jsx)(n.code,{children:"server_name"})," directive if you do not yet have a domain name to use."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"location"})," block defines a configuration based on the path in the URL. The path, or portion of the URL after the domain, is referred to as the uniform resource identifier (URI). NGINX will best match the URI requested to a ",(0,i.jsx)(n.code,{children:"location"})," block. The example uses ",(0,i.jsx)(n.code,{children:"/"})," to match all requests. The root directive shows NGINX where to look for static files when serving content for the given context. The URI of the request\nis appended to the root directive\u2019s value when looking for the requested file. If we had provided a URI prefix to the ",(0,i.jsx)(n.code,{children:"location"})," directive, this would be included in the appended path, unless we used the alias directive rather than root. The ",(0,i.jsx)(n.code,{children:"location"})," directive is able to match a wide range of expressions."]}),"\n",(0,i.jsx)(n.h2,{id:"high-performance-load-balancing",children:"High-Performance Load Balancing"}),"\n",(0,i.jsx)(n.h3,{id:"http-load-balancing",children:"HTTP Load Balancing"}),"\n",(0,i.jsx)(n.p,{children:"Distribute load between two or more HTTP servers."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"upstream backend {\n server 10.10.12.45:80  weight=1;\n server app.example.com:80 weight=2;\n server spare.example.com:80 backup;\n}\n\nserver {\n location / {\n  proxy_pass http://backend;\n }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This configuration balances load across two HTTP servers on port 80, and defines one as a ",(0,i.jsx)(n.code,{children:"backup"}),", which is used when the primary two are unavailable. The ",(0,i.jsx)(n.code,{children:"weight"})," parameter instructs NGINX to pass twice as many requests to the second server, and the ",(0,i.jsx)(n.code,{children:"weight"})," parameter defaults to 1."]}),"\n",(0,i.jsx)(n.h3,{id:"tcp-load-balancing",children:"TCP Load Balancing"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",metastring:'title="/etc/nginx/nginx.conf"',children:"user nginx;\nworker_processes auto;\npid /run/nginx.pid;\n\nstream {\n include /etc/nginx/stream.conf.d/*.conf;\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",metastring:'title="/etc/nginx/stream.conf.d/mysql_reads.conf"',children:"stream {\n upstream mysql_read {\n  server 10.10.12.45:3306   weight=5;\n  server app.example.com:3306    ;\n  server spare.example.com:3306   backup;\n }\n\n server {\n   listen 3306;\n   proxy_pass mysql_read;\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The main difference between the ",(0,i.jsx)(n.code,{children:"http"})," and ",(0,i.jsx)(n.code,{children:"stream"})," context is that they operate on different layers of the OSI model. ",(0,i.jsx)(n.code,{children:"http"})," context operates on the application layer (7) and is intended for working with the HTTP protocol whereas ",(0,i.jsx)(n.code,{children:"stream"})," operates at the transport level (4)."]}),"\n",(0,i.jsx)(n.h3,{id:"udp-load-balancing",children:"UDP Load Balancing"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",metastring:'title="/etc/nginx/stream.conf.d/ntp.conf"',children:"stream {\n upstream ntp {\n  server ntp1.example.com:123  weight=5;\n  server ntp2.example.com:123;\n }\n\n server {\n   listen 123 udp;\n   proxy_pass ntp;\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["If the service over which you\u2019re load balancing requires multiple packets to be sent back and forth between client and server, you can specify the ",(0,i.jsx)(n.code,{children:"reuseport"})," parameter:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"stream {\n server {\n  listen 1195 udp reuseport;\n  proxy_pass 127.0.0.1:1194;\n }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"reuseport"})," parameter instructs NGINX to create an individual listening socket for each worker process. This allows the kernel to distribute incoming connections between worker processes to handle multiple packets being sent between client and server."]}),"\n",(0,i.jsxs)(n.p,{children:["When working with datagrams, there are some other directives that might apply where they would not in TCP, such as the ",(0,i.jsx)(n.code,{children:"proxy_response"})," directive, which specifies to NGINX how many expected\nresponses can be sent from the upstream server. By default, this is unlimited until the\n",(0,i.jsx)(n.code,{children:"proxy_timeout"})," limit is reached. The ",(0,i.jsx)(n.code,{children:"proxy_timeout"})," directive sets the time between\ntwo successive read-or-write operations on client or proxied server connections before the connection is closed."]}),"\n",(0,i.jsx)(n.h3,{id:"load-balancing-methods",children:"Load Balancing Methods"}),"\n",(0,i.jsx)(n.p,{children:"NGINX has different methods for load balancing such as Round-robin, least connections, least time, generic hash, random or IP hash."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Round Robin"})," is the default load balancing method which distributes the reqeusts in the order of the list of servers in the upstream pool. We can add the ",(0,i.jsx)(n.code,{children:"weight"})," parameter to distribute requests within the server upstream pool. The higer the ",(0,i.jsx)(n.code,{children:"weight"}),", the more requests will be routed to that server."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Least connections"})," (",(0,i.jsx)(n.code,{children:"last_conn"}),") balances by proxying the current request to the upstream server with the least number of open connections. We can also use the ",(0,i.jsx)(n.code,{children:"weight"})," parameter."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"upstream backend {\n least_conn;\n server backend1.example.com;\n server backend2.example.com;\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Least time"})," (",(0,i.jsx)(n.code,{children:"least_time"}),") only in NGINX Plus taking ",(0,i.jsx)(n.code,{children:"header"})," or ",(0,i.jsx)(n.code,{children:"last_byte"})," parameter."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Generic hash"})," (",(0,i.jsx)(n.code,{children:"hash"}),") which takes a hash defined by the admin with the given text, variables of the request or runtime, or both. NGINX distributes the load among the servers by producing a hash for the current request and placing it against the upstream servers. This gives more control over where requests are sent."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Random"})," (",(0,i.jsx)(n.code,{children:"random"}),") Randomly-distribute requests taking ",(0,i.jsx)(n.code,{children:"weight"})," into consideration. It takes an optional ",(0,i.jsx)(n.code,{children:"two [method]"})," parameter which directs NGINX to randomly select two servers and use the load balancing ",(0,i.jsx)(n.code,{children:"method"}),"  between the two."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"health-checks",children:"Health Checks"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"upstream backend {\n server backend1.example.com:1234 max_fails=3 fail_timeout=3s;\n server backend2.example.com:1234 max_fails=3 fail_timeout=3s;\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Passive monitoring watches for failed or timed-out connections as they\npass through NGINX as requested by a client. Passive health checks are enabled by default; the parameters mentioned here allow you to tweak their behavior. The default ",(0,i.jsx)(n.code,{children:"max_fails"})," value is 1, and the default ",(0,i.jsx)(n.code,{children:"fail_timeout"})," value is 10s."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check",children:"HTTP Health Check"}),"\n",(0,i.jsx)(n.a,{href:"https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-health-check",children:"TCP Health Check"}),"\n",(0,i.jsx)(n.a,{href:"https://docs.nginx.com/nginx/admin-guide/load-balancer/udp-health-check",children:"UDP Health Check"})]}),"\n",(0,i.jsx)(n.h2,{id:"traffic-management",children:"Traffic Management"}),"\n",(0,i.jsx)(n.p,{children:"NGINX and NGINX Plus are also classified as web-traffic controllers. You can use NGINX to intelligently route traffic and control flow based on many attributes. This chapter covers NGINX\u2019s ability to split client requests based on percentages; utilize the geographical location of the clients; and control the flow of traffic in the form of rate, connection, and bandwidth limiting."}),"\n",(0,i.jsx)(n.h3,{id:"split-clients-between-different-versions-ab-testing",children:"Split Clients between different Versions (A/B Testing)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'split_clients "\\$\\{remote_addr\\}AAA" $variant {\n 20.0% "backendv2";\n *  "backendv1";\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"split_clients"}),' directive hashes the string "${remote_addr}AAA". The value of ',(0,i.jsx)(n.code,{children:"variant"}),' will be "backendv2" 20% of the client IP addresses and the rest "backendv1".']}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'http {\n split_clients \\${\\remote_addr\\}" $static_site_root_folder {\n  33.3% "/var/www/sitev2/";\n  *  "/var/www/sitev1/";\n }\n\n server {\n  listen 80 _;\n  root $static_site_root_folder;\n  location / {\n   index index.html\n  }\n }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"geolocation-of-clients-physical-location",children:"Geolocation of Clients Physical Location"}),"\n",(0,i.jsx)(n.p,{children:"Install the module:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"apt install nginx-module-geoip\n"})}),"\n",(0,i.jsx)(n.p,{children:"Download the city and country databases:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n\nGEO_IP_DIR=/etc/nginx/geoip\nCOUNTRY_DB_URI="http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz"\nCITY_DB_URI="http://geolite.maxmind.com/download/geoip/database/GeoLiteCity/GeoLiteCity.dat.gz"\n\nmkdir $GEO_IP_DIR&&cd $GEO_IP_DIR\n\nwget $COUNTRY_DB_URI && gunzip GeoIP.dat.gz\nwget $CITY_DB_URI && gunzip GeoLiteCity.dat.gz\n'})}),"\n",(0,i.jsx)(n.p,{children:"Then load the module and specify the database location:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'load_module = "/usr/lib64/nginx/modules/ngx_http_geoip_module.so"\n\nhttp {\n geoip_country /etc/nginx/geoip/GeoIP.dat\n geoip_city /etc/nginx/geoip/GeoLiteCity.dat\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"$geoip_country_code"})," (two letters, e.g. IL, US), ",(0,i.jsx)(n.code,{children:"$geoip_country_code3"})," (three letters, e.g. USA), ",(0,i.jsx)(n.code,{children:"$geoip_country_name"})," (full country name) embedded variables are exposed."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"geoip_city"})," directive enables all the same variables as the ",(0,i.jsx)(n.code,{children:"geoip_country"})," directive, just with different names, such as ",(0,i.jsx)(n.code,{children:"$geoip_city_country_code"}),", ",(0,i.jsx)(n.code,{children:"$geoip_city_country_code3"}),", and ",(0,i.jsx)(n.code,{children:"$geoip_city_country_name"}),". Other variables include ",(0,i.jsx)(n.code,{children:"$geoip_city"}),", ",(0,i.jsx)(n.code,{children:"$geoip_latitude"}),", ",(0,i.jsx)(n.code,{children:"$geoip_longitude"}),", ",(0,i.jsx)(n.code,{children:"$geoip_city_continent_code"}),", and ",(0,i.jsx)(n.code,{children:"$geoip_postal_code"}),", all of which are descriptive of the value they return. ",(0,i.jsx)(n.code,{children:"$geoip_region"})," and ",(0,i.jsx)(n.code,{children:"$geoip_region_name"})," describe the region, territory, state, province, federal land, and the like. Region is the two-letter code, where region name is the full name. ",(0,i.jsx)(n.code,{children:"$geoip_area_code"}),", only valid in the US, returns the three-digit telephone area code."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"http://nginx.org/en/docs/http/ngx_http_geoip_module.html",children:"nginx HTTP GeoIP Module"}),"\n",(0,i.jsx)(n.a,{href:"https://github.com/maxmind/geoipupdate",children:"GeoIP Update"})]}),"\n",(0,i.jsx)(n.h3,{id:"restrict-access-based-on-country",children:"Restrict Access Based on Country"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'load_module "/usr/lib64/nginx/modules/ngx_http_geoip_module.so";\n\nhttp {\n map $geoip_country_code $country_access {\n  "US" 0;\n  default 1;\n }\n\n server {\n  if ($country_access = \'1\') {\n   return 403;\n  }\n }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"limiting-connections-based-on-ip-address",children:"Limiting Connections Based on IP Address"}),"\n",(0,i.jsxs)(n.p,{children:["We use the ",(0,i.jsx)(n.code,{children:"limit_conn"})," directive:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"http {\n limit_conn_zone $binary_remote_addr zone=limitbyaddr:10m;\n limit_conn_status 429;\n\n server {\n  limit_conn liitbyaddr 40;\n }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This configuration creates a shared memory zone named ",(0,i.jsx)(n.code,{children:"limitbyaddr"}),". The key we use is the client IP address in binary form ",(0,i.jsx)(n.code,{children:"$binary_remote_addr"}),". The size of the shared memory zone is 10MB."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"limit_conn"})," directive takes the name of the zone and the nunber of connections allowed (40)."]}),"\n",(0,i.jsx)(n.p,{children:"Be cautious when using the client IP as the key to the zone because if the IP address represents an organization behind a VPN, the whole organization will be limited."}),"\n",(0,i.jsxs)(n.p,{children:["Testing limitations can be tricky. It\u2019s often hard to simulate live traffic in an alternate environment for testing. In this case, you can set the ",(0,i.jsx)(n.code,{children:"limit_req_dry_run"})," directive to on, then use the variable ",(0,i.jsx)(n.code,{children:"$limit_req_status"})," in your access log. The ",(0,i.jsx)(n.code,{children:"$limit_req_status"})," variable will evaluate to either ",(0,i.jsx)(n.code,{children:"PASSED"}),", ",(0,i.jsx)(n.code,{children:"DELAYED"}),", ",(0,i.jsx)(n.code,{children:"REJECTED"}),", ",(0,i.jsx)(n.code,{children:"DELAYED_DRY_RUN"}),", or ",(0,i.jsx)(n.code,{children:"REJECTED_DRY_RUN"}),". With dry run enabled, you\u2019ll be able to analyze the logs of live traffic and tweak your limits as needed before enabling, providing you with assurance that your limit configuration is correct."]}),"\n",(0,i.jsx)(n.h3,{id:"limiting-rate-of-requests-by-client-ip-address",children:"Limiting Rate of Requests by Client IP Address"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"http {\n limit_req_zone $binary_remote_addr zone=limitbyaddr:10m rate=3r/s;\n limit_req_status 429;\n\n server {\n  limit_req zone=limitbyaddr;\n }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We can also use ",(0,i.jsx)(n.code,{children:"burst"}),", ",(0,i.jsx)(n.code,{children:"delay"}),", ",(0,i.jsx)(n.code,{children:"nodelay"})," to fine tune the rate-limiting."]}),"\n",(0,i.jsx)(n.p,{children:"This is a recommended way to prevent brute-forcing or DDoS."}),"\n",(0,i.jsx)(n.h3,{id:"limiting-bandwidth",children:"Limiting Bandwidth"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"location /download/ {\n limit_rate_after 10m;\n limit_rate 1m;\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["URIs with the prefix ",(0,i.jsx)(n.code,{children:"download"})," will be limited after 10MB to a rate of 1MB per second."]}),"\n",(0,i.jsx)(n.h2,{id:"massively-scalable-content-caching",children:"Massively Scalable Content Caching"}),"\n",(0,i.jsx)(n.p,{children:"Scaling and distribution of caching servers in strategic locations should be close to the consumer for the best performance such as CDNs. Wherever the NGINX server is hosted, it will be cached in that location."}),"\n",(0,i.jsx)(n.h3,{id:"caching-zones",children:"Caching Zones"}),"\n",(0,i.jsx)(n.p,{children:"Cache the content and define where it is stored."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"proxy_cache_path \n /var/nginx/cache\n keys_zone=CACHE:60m\n levels=1:2\n inactive=3h\n max_size=20g;\n\nproxy_cache CACHE;\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This configuration creates a shared memory space ",(0,i.jsx)(n.code,{children:"CACHE"})," with 60MB of memory and  a directory for cached responses on the filesystem. It defines the maximum size of the cache to 20GB."]}),"\n",(0,i.jsx)(n.p,{children:"It also sets the directory structure level and defines the release of cached responses after they have not been requested in 3 hours."}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"levels"})," parameter defines how the file structure is created. The value is a colon- separated value that declares the length of subdirectory names, with a maximum of three levels."]}),"\n",(0,i.jsx)(n.p,{children:"We can also tell NGINX to not proxy requests that are currently being written to cache to an upstream server."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"proxy_cache_lock on;\nproxy_cache_lock_age 10s;\nproxy_cache_lock_timeout 3s;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"bypass-cache",children:"Bypass Cache"}),"\n",(0,i.jsxs)(n.p,{children:["We use the ",(0,i.jsx)(n.code,{children:"proxy_cache_bypass"})," directive with a nonempty or nonzero value."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"proxy_cache_bypass $http_cache_bypass;\n"})}),"\n",(0,i.jsxs)(n.p,{children:["NGINX will bypass the cache if the HTTP request header named ",(0,i.jsx)(n.code,{children:"cache_bypass"})," is set to any value that is not 0."]}),"\n",(0,i.jsx)(n.h3,{id:"cache-performance-boost-client-side",children:"Cache Performance Boost: Client Side"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'location ~* \\.(css|js)$ {\n expires 1y;\n add_header Cache-Control "public";\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The client can cache the content of CSS and JavaScript files. The ",(0,i.jsx)(n.code,{children:"expires"})," directive instructs the client that their cached resource will no longer be valid after one year. The ",(0,i.jsx)(n.code,{children:"add_header"})," directive adds the HTTP response header ",(0,i.jsx)(n.code,{children:"Cache-Control"})," to the response and allows any caching server along the way to cache the resource. If we specify ",(0,i.jsx)(n.code,{children:"private"}),", only the client is allowed to cache the value."]}),"\n",(0,i.jsx)(n.h2,{id:"programmability",children:"Programmability"}),"\n",(0,i.jsx)(n.h3,{id:"expose-javascript-functionality-within-nginx",children:"Expose JavaScript Functionality within NGINX"}),"\n",(0,i.jsx)(n.p,{children:"If we need to perform custom logic on requests and responses, we can use the NJS module."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"apt install nginx-module-njs\n\nmkdir -p /etc/nginx/njs\n"})}),"\n",(0,i.jsx)(n.p,{children:"We create a file that will export two functions to NGINX:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",metastring:"title=/etc/nginx/njs/jwt.js",children:"function jwt(data) {\n        var parts = data.split('.').slice(0,2)\n            .map(v=>Buffer.from(v, 'base64url').toString())\n            .map(JSON.parse);\n        return { headers:parts[0], payload: parts[1] };\n    }\n    function jwt_payload_subject(r) {\n  // slice(7) to remove the \"Bearer \" from the Authorization header\n        return jwt(r.headersIn.Authorization.slice(7)).payload.sub;\n    }\n    function jwt_payload_issuer(r) {\n        return jwt(r.headersIn.Authorization.slice(7)).payload.iss;\n    }\nexport default {jwt_payload_subject, jwt_payload_issuer}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then we load the NJS module:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'load_module /etc/nginx/njs/modules/ngx_http_js_module.so\n\nhttp {\n js_path "/etc/nginx/njs";\n js_import_main from jwt.js;\n js_set $jwt_payload_subject main.jwt_payload_subject;\n js_set $jwt_payload_issuer main.jwt_payload_issuer;\n\n server {\n  listen 80 default_server;\n  listen [::]:80 default_server;\n  server_name _;\n  location / {\n   return 200 "$jwt_payload_subject $jwt_payload_issuer";\n  }\n }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"We can then test this out:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl 'http://localhost/' -H \\\n    \"Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1\\\n    NiIsImV4cCI6MTU4NDcyMzA4NX0.eyJpc3MiOiJuZ2lueCIsInN1YiI6Im\\\n    FsaWNlIiwiZm9vIjoxMjMsImJhciI6InFxIiwie\\\n    nl4IjpmYWxzZX0.Kftl23Rvv9dIso1RuZ8uHaJ83BkKmMtTwch09rJtwgk\"\n\nalice nginx\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.a,{href:"https://nginx.org/en/docs/njs/",children:[(0,i.jsx)(n.code,{children:"njs"})," scripting language"]})}),"\n",(0,i.jsx)(n.h2,{id:"authentication",children:"Authentication"}),"\n",(0,i.jsx)(n.p,{children:"We can authenticate clients using NGINX."}),"\n",(0,i.jsx)(n.h3,{id:"http-basic-authentication",children:"HTTP Basic Authentication"}),"\n",(0,i.jsxs)(n.p,{children:["We can create an encrypted password using the C ",(0,i.jsx)(n.code,{children:"crypt()"})," function with:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'echo "name1:$(openssl passwd password1)" > conf.d/passwd\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Then use the ",(0,i.jsx)(n.code,{children:"auth_basic"})," and ",(0,i.jsx)(n.code,{children:"auth_basic_user_file"})," directives to enable basic authentication:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'location / {\n auth_basic    "Private site";\n auth_basic_user_file conf.d/passwd;\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:'A popup with a "Private site" is going to be presented to an unauthenticated user.'}),"\n",(0,i.jsx)(n.p,{children:"We can then test it out:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl --user name1:password1 http://localhost\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Unauthenticated requests will be rejected with 401 and a ",(0,i.jsx)(n.code,{children:"WWW-Authenticate"})," response header. The header will have a value of ",(0,i.jsx)(n.code,{children:'Basic realm="your string"'})," which  causes the browser to prompt for a username and password. The username and password are the concatenated and delimited with a colon, ",(0,i.jsx)(n.code,{children:"base64"}),"-encoded and then sent in the request header named ",(0,i.jsx)(n.code,{children:"Authorization"}),". The ",(0,i.jsx)(n.code,{children:"Authorization"})," request header will specify a ",(0,i.jsx)(n.code,{children:"Basic"})," and ",(0,i.jsx)(n.code,{children:"user:pass3word"})," encoded string. The server decodes the header and verifies against the provided ",(0,i.jsx)(n.code,{children:"auth_basic_user_file"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Use HTTPS with basic authentication."}),"\n",(0,i.jsx)(n.h3,{id:"third-party-authentication-system-subrequest",children:"Third-Party Authentication System (Subrequest)"}),"\n",(0,i.jsxs)(n.p,{children:["We use the ",(0,i.jsx)(n.code,{children:"http_auth_request_module"})," to make a request to the authentication service before serving the request:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'location /private/ {\n auth_request  /auth;\n auth_request_set $auth_status $upstream_status;\n}\n\nlocation = /auth {\n internal;\n proxy_pass    http://auth-server;\n proxy_pass_request_body off;\n proxy_set_header  Content-Length "";\n proxt_set_header  X-Original-URI $request_uri;\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["A request that will arrive in ",(0,i.jsx)(n.code,{children:"/private/"})," will be passed to a subrequest sent to the ",(0,i.jsx)(n.code,{children:"auth-server"})," and it will observer the subrequest response before routing the request to its destination.\nIf the HTTP request status code is 200, permission will be granted. If the status code is 401 or 403, the same will be returned to the original request. We're dropping the body in the request to the authentication service."]}),"\n",(0,i.jsx)(n.h2,{id:"security-controls",children:"Security Controls"}),"\n",(0,i.jsx)(n.h3,{id:"access-based-on-ip-address",children:"Access Based on IP Address"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"location /admin/ {\n deny 10.0.0.1;\n allow 10.0.0.0/20;\n allow 2001:0db8::/32;\n deny all;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"This configuration:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Allows access from any IPv4 address in 10.0.0.0/20 except for 10.0.0.1."}),"\n",(0,i.jsx)(n.li,{children:"Allows access from IPv6 in the 2001:0db8::/32 subnet."}),"\n",(0,i.jsx)(n.li,{children:"Returns 403 for requests from any other address."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"enable-cors",children:"Enable CORS"}),"\n",(0,i.jsx)(n.p,{children:"Resource such as JavaScript make CORS when the resource they're requesting is of a domain other than their own. The browser will not use a resource if it does not have appropriate headers that specifically allow it to use it."}),"\n",(0,i.jsx)(n.p,{children:"We can alter the headers based on the request method:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"map $request_method $cors_method {\n OPTIONS 11;\n GET  1;\n POST 1;\n default 0;\n}\n\nserver {\n location / {\n  if($cors_method ~ '1') {\n   add_header 'Access-Control-Allow-Methods' 'GET,POST,OPTIONS';\n   add_header 'Access-Control-Allow-Origin' '*.example.com';\n   add_header 'Access-Control-Allow-Headers'\n    'DNT\n    ,Keep-Alive,\n    ,User-Agent\n    ,X-Requested-With\n    ,If-Modified-Since\n    ,Cache-Control\n    ,ContentType'\n    ;\n  }\n\n  if($cors_method = '11') {\n   add_header 'Access-Control-Max-Age', 1728000;\n   add_header 'Content-Type', 'text/plain; charset=UTF-8';\n   add_header 'Content-Length' 0;\n   return 204;\n  }\n }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"OPTIONS"})," request method returns a preflight request to ask for the CORS rules enforced by the server. ",(0,i.jsx)(n.code,{children:"OPTIONS, GET, POST"})," are allowed under CORS. Setting the ",(0,i.jsx)(n.code,{children:"Access-Control-Allow-Origin"})," header allows for content being served from this server to also be used on pages of origins that match this header. The preflight request can be cached on the client for 1,728,000 seconds, or 20 days."]}),"\n",(0,i.jsx)(n.h3,{id:"client-side-encryption",children:"Client-Side Encryption"}),"\n",(0,i.jsxs)(n.p,{children:["Encrypt traffic between NGINX server and the client. We can utilize the ",(0,i.jsx)(n.code,{children:"ngx_http_ssl_module"})," and ",(0,i.jsx)(n.code,{children:"ngx_stream_ssl_module"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"http {\n server {\n  listen 8443 ssl;\n  ssl_certificate /etc/nginx/ssl/example.crt;\n  ssl_certificate_key /etc/nginx/ssl/example.key;\n\n  # Set accepted protocol and cipher\n  ssl_protocols TLSv1.2 TLSv1.3;\n  ssl_ciphers HIGH:!aNULL:!MD5;\n\n  # Client-Server negotiation caching\n        ssl_session_cache shared:SSL:10m;\n        ssl_session_timeout 10m;\n }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"upstream-encryption",children:"Upstream Encryption"}),"\n",(0,i.jsxs)(n.p,{children:["We can proxy over HTTPS by changing the protocol on the value passed to the ",(0,i.jsx)(n.code,{children:"proxy_pass"})," directive:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"location / {\n proxy_pass https://upstream.example.com;\n proxy_ssl_verify on;\n proxy_ssl_verify_depth 2;\n proxy_ssl_protocols TLSv1.2;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"securing-a-location",children:"Securing a Location"}),"\n",(0,i.jsxs)(n.p,{children:["Securing resources with a secret is a great way to ensure your files are protected. The argument to ",(0,i.jsx)(n.code,{children:"secure_link_secret"})," is ",(0,i.jsx)(n.code,{children:"md5"})," hashed and the hex digest of that ",(0,i.jsx)(n.code,{children:"md5"})," is used in the URI."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'location /resources {\n secure_link_secret mySecret;\n if ($secure_link = "") { return 403; }\n\n rewrite ^ /secured/$secure_link;\n}\n\nlocation /secured/ {\n internal;\n root /var/www;\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The configuration creates an internal and public facing location block. The public-facing one will return 403 if the secure link is empty. The secure link is empty when the ",(0,i.jsx)(n.code,{children:"md5"})," hash was not verified."]}),"\n",(0,i.jsx)(n.h3,{id:"generating-a-secure-link-with-a-secret",children:"Generating a Secure Link with a Secret"}),"\n",(0,i.jsxs)(n.p,{children:["Let's say we have a file ",(0,i.jsx)(n.code,{children:"/var/www/secured/index.html"})," and the same configuration from ",(0,i.jsx)(n.a,{href:"#securing-a-location",children:"Securing a Location"}),". We can generate a secure link by concatenating the URI path and the secret."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"echo -n 'index.htmlmySecret' | openssl md5 -hex\na53bee08a4bf0bbea978ddf736363a12\n"})}),"\n",(0,i.jsx)(n.p,{children:"We can do the same in Python:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"import hashlib\nhashlib.md5(b'index.htmlmySecret').hexdigest()\n'a53bee08a4bf0bbea978ddf736363a12'\n"})}),"\n",(0,i.jsx)(n.p,{children:"We can access the resource by constructing the request:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl http://www.example.com/resources/a53bee08a4bf0bbea978ddf736363a12/index.html\n"})}),"\n",(0,i.jsx)(n.h3,{id:"securing-a-location-with-expire-date",children:"Securing a Location with Expire Date"}),"\n",(0,i.jsx)(n.p,{children:"We can secure a location with a link that expires at some future time and specific to a client.\nThis is a very secure option as it prevents sharing of links to access secured locations."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'location /resources {\n root /var/www;\n secure_link $arg_md5,$arg_expires;\n secure_link_md5 "$secure_link_expires$uri$remote_addrmySecret";\n if ($secure_link = "") { return 403;}\n if ($secure_link = "0") { return 410;}\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"secure_link"})," takes the variable holding the ",(0,i.jsx)(n.code,{children:"md5"})," hash (which in this example is an HTTP argument of ",(0,i.jsx)(n.code,{children:"md5"}),") ad a variable that holds the time in which the link expires in Unix epoch time format. If the secure link equals 0, it means that the link expired and a 410 Gone is returned."]}),"\n",(0,i.jsx)(n.h3,{id:"generating-an-expiring-link",children:"Generating an Expiring Link"}),"\n",(0,i.jsx)(n.p,{children:"In the example below, we're able to generate a secure link in a special format that can be used in URLs. It's secure because the value of the variable is never sent to the client."}),"\n",(0,i.jsx)(n.p,{children:"This script generates a secure link that expires after 1 hour:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",metastring:'title="securelink.py"',children:"from datetime import datetime, timedelta from base64 import b64encode\nimport hashlib\n    # Set environment vars\n    resource = b'/resources/index.html'\n    remote_addr = b'127.0.0.1'\n    host = b'www.example.com'\n    mysecret = b'mySecret'\n    # Generate expire timestamp\n    now = datetime.utcnow()\n    expire_dt = now + timedelta(hours=1)\n    expire_epoch = str.encode(expire_dt.strftime('%s'))\n    # md5 hash the string\n    uncoded = expire_epoch + resource + remote_addr + mysecret\n    md5hashed = hashlib.md5(uncoded).digest()\n    # Base64 encode and transform the string\n    b64 = b64encode(md5hashed)\n    unpadded_b64url = b64.replace(b'+', b'-')\\\n        .replace(b'/', b'_')\\\n        .replace(b'=', b'')\n    # Format and generate the link\n    linkformat = \"{}{}?md5={}?expires={}\"\n    securelink = linkformat.format(\n        host.decode(),\n        resource.decode(),\n        unpadded_b64url.decode(),\n        expire_epoch.decode()\n) print(securelink)\n"})}),"\n",(0,i.jsx)(n.p,{children:"Another way is by generating a Unix epoch expiration date:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'date -d "2030-12-31 00:00" +%s --utc\n1924905600\n'})}),"\n",(0,i.jsxs)(n.p,{children:["If we use the value of ",(0,i.jsx)(n.code,{children:"secure_link_md5"})," example provided in ",(0,i.jsx)(n.a,{href:"#securing-a-location-with-expire-date",children:"Securing a Location with Expire Date"}),", we can construct the link as so:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"echo -n '1924905600/resources/index.html127.0.0.1 mySecret' \\\n| openssl md5 -binary \\\n| openssl base64 \\\n| tr +/ -_ \\\n| tr -d =\n\nsqysOw5kMvQBL3j9ODCyoQ\n"})}),"\n",(0,i.jsx)(n.p,{children:"We can then access the resource:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'curl "http://example.com/resources/index.html?md5=sqysOw5kMvQBL3j9ODCyoQ&expires=1924905600"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"redirect-https",children:"Redirect HTTPS"}),"\n",(0,i.jsx)(n.p,{children:"If we need to redirect unencrypted requests to HTTPS:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"server {\n listen 80 default_server;\n listen [::]:80 default_server;\n server_name _;\n return 301 https://$host$request_uri;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"http-strict-transport-security-hsts",children:"HTTP Strict Transport Security (HSTS)"}),"\n",(0,i.jsx)(n.p,{children:"Instruct browsers to never send requests over HTTP."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"add_header Strict-Transport-Security max-age=31536000\n"})}),"\n",(0,i.jsx)(n.h2,{id:"http2",children:"HTTP/2"}),"\n",(0,i.jsxs)(n.p,{children:["To use HTTP/2, we add the ",(0,i.jsx)(n.code,{children:"http2"})," argument:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"server {\n listen 443 ssl http2 default_server;\n\n ssl_certificate  server.crt;\n ssl_certificate_key server.key;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"grpc",children:"gRPC"}),"\n",(0,i.jsx)(n.p,{children:"We can listen on HTTP/2 traffic and proxy that traffic to a machine"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"server {\n listen 80 http2;\n\n location / {\n  grpc_pass grpc://backend.local:50051;\n }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"For TLS encryption that terminates at NGINX and passes the gPRC communication to the application over unencrypted HTTP/2:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"server {\n listen 443 ssl http2 default_server;\n\n ssl_certificate  server.crt;\n ssl_certificate_key server.key;\n location / {\n  grpc_pass grpc://backend.local:50051;\n  # for end-to-end encryption\n  # grpc_pass grpcs://backend.local:50051;\n }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"We can also route the calls to different backend services:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"location /mypackage.service1 {\n grpc_pass grpc://$grpc_service1;\n}\n\nlocation /mypackage.service2 {\n grpc_pass grpc://$grpc_service2;\n}\n\nlocation / {\n root /usr/share/nginx/html;\n index index.html index.htm;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"http2-server-push",children:"HTTP/2 Server Push"}),"\n",(0,i.jsx)(n.p,{children:"To preemtively push content to the client:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"server {\n listen 443 ssl http2 default_server;\n\n ssl_certificate  server.crt;\n ssl_certificate_key server.key;\n root /usr/share/nginx/html;\n\n location /demo.html {\n  http2_push /style.css;\n  http2_push /image1.jpg;\n }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["NGINX can automatically push resources to clients if proxied applications include an HTTP response header named ",(0,i.jsx)(n.code,{children:"Link"}),". To enable this feature, we add ",(0,i.jsx)(n.code,{children:"http2_push_preload on;"})," to the configuration."]}),"\n",(0,i.jsx)(n.h2,{id:"containersmicroservices",children:"Containers/Microservices"}),"\n",(0,i.jsx)(n.h3,{id:"using-nginx-as-an-api-gateway",children:"Using NGINX as an API Gateway"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",metastring:"title=/etc/nginx/api_gateway.conf",children:'server {\n listen 443 ssl;\n server_name api.company.com;\n default_type application/json\n\n # Error handling\n proxy_intercept_errors on;\n\n error_page 400 = @400;\n location @400 { return 400 \'{"status": 400, "message": "Bad request"}\\n;\'}\n\n error_page 401 = @401;\n location @401 { return 401 \'{"status": 401, "message": "Bad Unauthorized"}\\n;\'}\n\n error_page 403 = @403;\n location @403 { return 403 \'{"status": 403, "message": "Forbidden"}\\n;\'}\n\n error_page 404 = @404;\n location @404 { return 404 \'{"status": 404, "message": "Resource not found"}\\n;\'}\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"We can then import this into the main configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",metastring:"title=/etc/nginx/nginx.conf",children:"include /etc/nginx/api_gateway.conf\n"})}),"\n",(0,i.jsx)(n.p,{children:"Now we can define the upstream service endpoints."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",metastring:"title=/etc/nginx/nginx.conf",children:"upstream service_1 {\n server 10.0.0.12:80;\n server 10.0.0.13:80;\n}\n\nupstream service_2 {\n server 10.0.0.14:80;\n server 10.0.0.15:80;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"In case services should also be defined as proxy location endpoints, we can define an endpoint as a variable:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"location = /_service_1 {\n internal;\n # Config common to service\n proxy_pass http://service_1/$request_uri;\n\n}\n\nlocation = /_service_2 {\n internal;\n # Config common to service\n proxy_pass http://service_2/$request_uri;\n\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then we need to build up ",(0,i.jsx)(n.code,{children:"location"})," blocks that define specific URI paths for a given service."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"mkdir /etc/nginx/api_conf.d\ntouch /etc/nginx/api_conf.d/service_1.conf\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",metastring:"title=/etc/nginx/api_conf.d/service_1.conf",children:"location /api/service_1/object {\n limit_except GET PUT { deny all; }\n rewrite ^ /_service_1 last;\n}\n\nlocation /api/service_1/object/[^/]*$ {\n limit_except GET POST { deny all; }\n rewrite ^ /_service_1 last;\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"rewrite"})," directive directs the request to the prior configured ",(0,i.jsx)(n.code,{children:"location"})," block that proxies the request to a service. In the example above, ",(0,i.jsx)(n.code,{children:"rewrite"})," instructs NGINX to reprocess the request with an altered URI. It specifies the expected HTTP methods and reroutes the request."]}),"\n",(0,i.jsxs)(n.p,{children:["We do the above for all services and make sure to include them configuration files in ",(0,i.jsx)(n.code,{children:"nginx.conf"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",metastring:"title=/etc/nginx/nginx.conf",children:"server {\n listen 443 ssl;\n server_name api.company.com\n\n default_type application/json;\n\n include api_conf.d/*.conf;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then make sure to enable authentication such as simple preshared API keys:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'map $http_apikey $api_client_name {\n default "";\n\n "1234jdankfjna" "client_one";\n "5678jdankfjna" "client_two";\n "9012jdankfjna" "client_three";\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Also, protect the backend services from attacks:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'http {\n limit_req_zone $http_apikey zone=limitbyapikey rate=100r/s;\n limit_req_status 429;\n\n location /api/service_2/object {\n  limit_req zone=lomitbyapikey;\n\n  if ($http_apikey = "") {\n   return 401;\n  }\n\n  if ($api_client_name = "") {\n   return 403;\n  }\n\n  limit_except GET PUT {deny_all;}\n  rewrite ^ /_service_2 last;\n }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"creating-an-nginx-dockerfile",children:"Creating an NGINX Dockerfile"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"tree .\n\n .\n    \u251c\u2500\u2500 Dockerfile\n    \u2514\u2500\u2500 nginx-conf\n        \u251c\u2500\u2500 conf.d\n        \u2502   \u2514\u2500\u2500 default.conf\n        \u251c\u2500\u2500 fastcgi.conf\n        \u251c\u2500\u2500 fastcgi_params\n        \u251c\u2500\u2500 koi-utf\n        \u251c\u2500\u2500 koi-win\n        \u251c\u2500\u2500 mime.types\n        \u251c\u2500\u2500 nginx.conf\n        \u251c\u2500\u2500 scgi_params\n        \u251c\u2500\u2500 uwsgi_params\n        \u2514\u2500\u2500 win-utf\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dockerfile",children:'FROM centos:7\n\nRUN yum -y install epel-release && yum -y install nginx\n\nADD /nginx-conf /etc/nginx\n\nEXPOSE 80 443\n\nCMD ["nginx"]\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Since we need to run NGINX in the foreground inside a container, we start it using\n",(0,i.jsx)(n.code,{children:'-g "daemon off;"'})," or add ",(0,i.jsx)(n.code,{children:"daemon off;"})," to NGINX configuration.\nWe also need to alter the NGINX configuration to log to ",(0,i.jsx)(n.code,{children:"/dev/std[out|err]"})," so that the container logs will be routed to the Docker daemon."]}),"\n",(0,i.jsx)(n.h3,{id:"using-environment-variables-in-nginx",children:"Using Environment Variables in NGINX"}),"\n",(0,i.jsxs)(n.p,{children:["Use the ",(0,i.jsx)(n.code,{children:"ngx_http_perl_module"})," to set variables in NGINX from the environment:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"daemon off;\nenv APP_DNS;\ninclude /usr/share/nginx/modules/*.conf\n\nhttp {\n perl_set $upstream_app 'sub { return $ENV{\"APP_DNS\"}; }';\n server {\n  location / {\n   proxy_pass https://$upstream_app;\n  }\n }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To use ",(0,i.jsx)(n.code,{children:"perl_set"}),", we must have the ",(0,i.jsx)(n.code,{children:"ngx_http_perl_module"})," installed."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"yum -y install nginx nginx-mod-http-perl\n"})}),"\n",(0,i.jsxs)(n.p,{children:["When installing modules from the package utility for CentOS, they\u2019re placed in the ",(0,i.jsx)(n.code,{children:"/usr/lib64/nginx/modules/"})," directory, and configuration files that dynamically load these modules are placed in the ",(0,i.jsx)(n.code,{children:"/usr/share/nginx/modules/"})," directory."]}),"\n",(0,i.jsxs)(n.p,{children:["By default, NGINX gets rid of env vars so we need to specifiy them explicitly using ",(0,i.jsx)(n.code,{children:"env"}),".\nThe ",(0,i.jsx)(n.code,{children:"perl_set"})," directive takes the variable name and the string that renders the result as arguments."]}),"\n",(0,i.jsx)(n.h3,{id:"kubernetes-ingress-controller",children:"Kubernetes Ingress Controller"}),"\n",(0,i.jsxs)(n.p,{children:["We can use the ",(0,i.jsx)(n.code,{children:"nginx/nginx-ingress"})," image from Dockerhub."]}),"\n",(0,i.jsxs)(n.p,{children:["To set it up, we use the ",(0,i.jsx)(n.a,{href:"https://oreil.ly/KxF7i",children:"kubernetes-ingress repository on GitHub"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["We first create a ",(0,i.jsx)(n.code,{children:"Namespace"})," and a ",(0,i.jsx)(n.code,{children:"ServiceAccount"})," for the ingress controller."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f common/ns-and-sa.yaml\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We then create a ",(0,i.jsx)(n.code,{children:"Secret"})," with TLS certificate and key:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f common/default-server-secret.yaml\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We can also create a ",(0,i.jsx)(n.code,{children:"ConfigMap"})," for customizing configuration."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f common/nginx-config.yaml\n"})}),"\n",(0,i.jsxs)(n.p,{children:["If RBAC is enabled in the cluster, we need to create a ",(0,i.jsx)(n.code,{children:"ClusterRole"})," and bind it to the ",(0,i.jsx)(n.code,{children:"ServiceAccount"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f rbac/rbac.yaml\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We can then choose to create a ",(0,i.jsx)(n.code,{children:"Deployment"})," or ",(0,i.jsx)(n.code,{children:"DaemonSet"}),". Use the ",(0,i.jsx)(n.code,{children:"Deployment"})," if there are plans to dynamically change the number of ingress controller replicas or use ",(0,i.jsx)(n.code,{children:"DaemonSet"})," to deploy an ingress controller on every ",(0,i.jsx)(n.code,{children:"Node"})," or subset of ",(0,i.jsx)(n.code,{children:"Node"}),"s."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# FOR DEPLOYMENT\nkubectl apply -f deployment/nginx-ingress.yaml\n\n# FOR DAEMONSET\nkubectl apply -f daemon-set/nginx-ingress.yaml\n"})}),"\n",(0,i.jsxs)(n.p,{children:["If a ",(0,i.jsx)(n.code,{children:"DaemonSet"})," was created, ports 80 and 443are mapped to the same ports on the ",(0,i.jsx)(n.code,{children:"Node"})," where the container is running."]}),"\n",(0,i.jsxs)(n.p,{children:["For a ",(0,i.jsx)(n.code,{children:"Deployment"}),", there are 2 options for accessing the ingress controller ",(0,i.jsx)(n.code,{children:"Pod"}),"s. Either we instruct Kubernetes to randomly assign a ",(0,i.jsx)(n.code,{children:"Node"})," port that maps to the ingress controller ",(0,i.jsx)(n.code,{children:"Pod"})," using a ",(0,i.jsx)(n.code,{children:"Service"})," with type ",(0,i.jsx)(n.code,{children:"NodePort"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl create -f service/nodeport.yaml\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To statically configure the port that is opened for the ",(0,i.jsx)(n.code,{children:"Pod"}),", alter the YAML and add the attribute:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"nodePort: {port}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Or create a ",(0,i.jsx)(n.code,{children:"LoadBalancer"}),"-type ",(0,i.jsx)(n.code,{children:"Service"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl create -f service/loadbalancer.yaml\n\n# for AWS/ELB\nkubectl create -f service/loadbalancer-aws-elb.yaml\n"})}),"\n",(0,i.jsxs)(n.p,{children:["For AWS, Kubernetes creates a classic ELB in TCP mode with the PROXY Protocol enabled. We must configure NGINX to use the PROXY Protocol by adding the following to the ",(0,i.jsx)(n.code,{children:"ConfigMap"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:"title=common/nginx-config.yaml",children:'proxy-protocol: "True"\nreal-ip-header: "proxy_protocol"\nset-real-ip-from: "0.0.0.0/0"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["And update the ",(0,i.jsx)(n.code,{children:"ConfigMap"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f common/nginx-config.yaml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"prometheus-exporter-module",children:"Prometheus Exporter Module"}),"\n",(0,i.jsx)(n.p,{children:"We can configure Prometheus to collect NGINX statistics for monitoring purposes."}),"\n",(0,i.jsxs)(n.p,{children:["There's an NGINX Prometheus Exporter Module and can be found in ",(0,i.jsx)(n.a,{href:"https://oreil.ly/mC_i9",children:"Docker Image on Docker Hub"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["The exported will be started for NGINX and only harvest the ",(0,i.jsx)(n.code,{children:"stub_status"})," info. We must ensure the stub status is enabled."]}),"\n",(0,i.jsx)(n.p,{children:"To enable stub status:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"location /stub_status {\n stub_status;\n allow 127.0.0.1;\n deny all;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then we can run:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker run -p 9113:9113 nginx/nginx-prometheus-exporter:0.8.0 -nginx.scrape-uri http://${nginxEndpoint}:8080/stub_status\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"stub_status"})," module enables some basic monitoring such as number of active connections (",(0,i.jsx)(n.code,{children:"$connections_active"}),"), accepted connections, connections handled and requests served. Also, the current number of connections being read (",(0,i.jsx)(n.code,{children:"$connections_reading"}),"), written (",(0,i.jsx)(n.code,{children:"$connections_writing"}),") or in waiting (",(0,i.jsx)(n.code,{children:"$connections_waiting"}),")."]}),"\n",(0,i.jsx)(n.h2,{id:"debugging-and-troubleshooting",children:"Debugging and Troubleshooting"}),"\n",(0,i.jsx)(n.p,{children:"NGINX allows us to divide access logs into different files and formats for different contexts and to change the log level of error logging to get a deep understanding of what's happening. Logs can be streamed to Syslog."}),"\n",(0,i.jsx)(n.h3,{id:"configuring-access-logs",children:"Configuring Access Logs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"http {\n log_format geoproxy\n    '[$time_local] $remote_addr '\n    '$realip_remote_addr $remote_user '\n    '$proxy_protocol_server_addr $proxy_protocol_server_port '\n    '$request_method $server_protocol '\n    '$scheme $server_name $uri $status '\n    '$request_time $body_bytes_sent '\n    '$geoip_city_country_code3 $geoip_region '\n    '\"$geoip_city\" $http_x_forwarded_for '\n    '$upstream_status $upstream_response_time '\n    '\"$http_referer\" \"$http_user_agent\"';\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The log format configuration is named ",(0,i.jsx)(n.code,{children:"geoproxy"})]}),"\n",(0,i.jsxs)(n.p,{children:["We can set an optional ",(0,i.jsx)(n.code,{children:"escape"})," parameter to ",(0,i.jsx)(n.code,{children:"log_format"})," such as ",(0,i.jsx)(n.code,{children:"default,json,none"})," to escape prohibited characters."]}),"\n",(0,i.jsx)(n.p,{children:"To use this log format:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"server {\n access_log /var/log/nginx/access.log geoproxy;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"configuring-error-logs",children:"Configuring Error Logs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"error_log /var/log/nginx/error.log warn;\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The log level is optional (",(0,i.jsx)(n.code,{children:"warn"})," in this case) and is ",(0,i.jsx)(n.code,{children:"error"})," by default. It can be set to ",(0,i.jsx)(n.code,{children:"debug/info/notice/warn/error/crit/alert/emerg"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"This log will include information about configuration files not working correctly and errors produced by the application servers."}),"\n",(0,i.jsx)(n.h3,{id:"forwarding-to-syslog",children:"Forwarding to Syslog"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"error_log syslog:server=10.0.1.42 debug;\naccess_log syslog:server=10.0.1.42,tag=nginx,severity=info geoproxy;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"request-tracing",children:"Request Tracing"}),"\n",(0,i.jsxs)(n.p,{children:["We can use NGINX logs to have an end-to-end understanding of a request. ",(0,i.jsx)(n.code,{children:"$request_id"})," provides a randomly generated UUIDv4 string to help in correlate a request across the upstream servers handling the request."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"log_format trace '$remote_addr - $remote_user [$time_local] '\n     '\"$request\" $status $body_bytes_sent '\n     '\"$http_referer\" \"$http_user_agent\" '\n     '\"$http_x_forwarded_for\" $request_id';\n\nupstream backend {\n server 10.0.0.42;\n}\n\nserver {\n listen 80;\n\n # Add the X-Request-ID header to the response to client\n add_header X-Request-ID $request_id;\n\n location / {\n  proxy_pass http://backend;\n\n  # Send the header to the application\n  proxy_set_header X-Request-ID $request_id;\n  access_log /var/log/nginx/access_trace.log trace;\n }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"In the frontend client, the request will include the header. We'll need to capture this header value and add it to the application logs."})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>c});var i=s(96540);const r={},t=i.createContext(r);function a(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);