"use strict";(globalThis.webpackChunkkgkb=globalThis.webpackChunkkgkb||[]).push([[34318],{32715:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>A,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>o,toc:()=>c});var t=s(74848),r=s(28453);const a={slug:"analyzing-smtp",title:"Analyzing SMTP",description:"Fill me up!",authors:["kbbgl"],tags:["pcap","smtp","tshark","wireshark"]},i=void 0,o={id:"cybersecurity/Forensics/packet_analysis/Analyzing SMTP",title:"Analyzing SMTP",description:"Fill me up!",source:"@site/docs/cybersecurity/Forensics/packet_analysis/Analyzing SMTP.md",sourceDirName:"cybersecurity/Forensics/packet_analysis",slug:"/cybersecurity/Forensics/packet_analysis/analyzing-smtp",permalink:"/docs/cybersecurity/Forensics/packet_analysis/analyzing-smtp",draft:!1,unlisted:!1,tags:[{inline:!0,label:"pcap",permalink:"/docs/tags/pcap"},{inline:!0,label:"smtp",permalink:"/docs/tags/smtp"},{inline:!0,label:"tshark",permalink:"/docs/tags/tshark"},{inline:!0,label:"wireshark",permalink:"/docs/tags/wireshark"}],version:"current",frontMatter:{slug:"analyzing-smtp",title:"Analyzing SMTP",description:"Fill me up!",authors:["kbbgl"],tags:["pcap","smtp","tshark","wireshark"]},sidebar:"docsSidebar",previous:{title:"Network Capture Techniques",permalink:"/docs/cybersecurity/Forensics/network-capture-techniques"},next:{title:"smtp",permalink:"/docs/cybersecurity/Forensics/packet_analysis/smtp"}},A={},c=[{value:"Description",id:"description",level:2},{value:"Mission",id:"mission",level:2},{value:"Network",id:"network",level:2},{value:"Evidence",id:"evidence",level:2},{value:"Analysis",id:"analysis",level:2},{value:"Protocol Summary",id:"protocol-summary",level:3},{value:"Keyword Search",id:"keyword-search",level:3},{value:"Carving Out Attachment",id:"carving-out-attachment",level:3}];function l(e){const n={code:"code",em:"em",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["Taken from ",(0,t.jsx)(n.em,{children:"Network Forensics, Tracking Hackers through Cyberspace"}),", Case Study 4.6."]}),"\n",(0,t.jsx)(n.h2,{id:"description",children:"Description"}),"\n",(0,t.jsx)(n.p,{children:"After being released on bail, Ann Dercover disappears! Fortunately, investigators were carefully monitoring her network activity before she skipped town. \u201cWe believe Ann may have communicated with her secret lover, Mr. X, before she left,\u201d says the police chief. \u201cThe packet capture may contain clues to her whereabouts.\u201d"}),"\n",(0,t.jsx)(n.h2,{id:"mission",children:"Mission"}),"\n",(0,t.jsx)(n.p,{children:"Your mission is to analyze the packet capture and gather information about Ann\u2019s activities and plans."}),"\n",(0,t.jsx)(n.p,{children:"The following questions will help guide your investigation:\n\u2022 Provide any online aliases or addresses and corresponding account credentials that may be used by the suspect under investigation."}),"\n",(0,t.jsx)(n.p,{children:"\u2022 Who did Ann communicate with? Provide a list of email addresses and any other identifying information."}),"\n",(0,t.jsx)(n.p,{children:"\u2022 Extract any transcripts of Ann\u2019s conversations and present them to investigators."}),"\n",(0,t.jsx)(n.p,{children:"\u2022 If Ann transferred or received any files of interest, recover them."}),"\n",(0,t.jsx)(n.p,{children:"\u2022 Are there any indications of Ann\u2019s physical whereabouts? If so, provide supporting evidence."}),"\n",(0,t.jsx)(n.h2,{id:"network",children:"Network"}),"\n",(0,t.jsxs)(n.p,{children:["\u2022 Internal network: ",(0,t.jsx)(n.code,{children:"192.168.30.0/24"})]}),"\n",(0,t.jsxs)(n.p,{children:["\u2022 DMZ: ",(0,t.jsx)(n.code,{children:"10.30.30.0/24"})]}),"\n",(0,t.jsxs)(n.p,{children:["\u2022 The \u201cInternet\u201d: ",(0,t.jsx)(n.code,{children:"172.30.1.0/24"})," [Note that for the purposes of this case study, we are treating the ",(0,t.jsx)(n.code,{children:"172.30.1.0/24"})," subnet as \u201cthe Internet.\u201d In real life, this is a reserved nonroutable IP address space.]"]}),"\n",(0,t.jsx)(n.h2,{id:"evidence",children:"Evidence"}),"\n",(0,t.jsxs)(n.p,{children:["Investigators provide you with a packet capture from Ann\u2019s home network, [",(0,t.jsx)(n.code,{children:"evidence-packet-analysis.pcap"}),"]. They also inform you that in the course of their monitoring, they have found that Ann\u2019s laptop has the MAC address ",(0,t.jsx)(n.code,{children:"00:21:70:4D:4F:AE"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"analysis",children:"Analysis"}),"\n",(0,t.jsx)(n.h3,{id:"protocol-summary",children:"Protocol Summary"}),"\n",(0,t.jsx)(n.p,{children:"Let's first review the protocols used in this packet capture."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"tshark -n  -r evidence-packet-analysis.pcap -q -z io,ph\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"===================================================================\nProtocol Hierarchy Statistics\nFilter: \n\neth                                      frames:2487 bytes:1508942\n  ip                                     frames:2487 bytes:1508942\n    udp                                  frames:481 bytes:53801\n      ntp                                frames:17 bytes:1530\n      dhcp                               frames:10 bytes:3509\n      nbdgm                              frames:18 bytes:3888\n        smb                              frames:18 bytes:3888\n          mailslot                       frames:18 bytes:3888\n            browser                      frames:18 bytes:3888\n      nbns                               frames:108 bytes:10584\n      dns                                frames:328 bytes:34290\n    tcp                                  frames:2000 bytes:1454781\n      http                               frames:111 bytes:71429\n        data-text-lines                  frames:18 bytes:15217\n          tcp.segments                   frames:11 bytes:10088\n        media                            frames:2 bytes:1490\n          tcp.segments                   frames:1 bytes:694\n        image-gif                        frames:4 bytes:2205\n          tcp.segments                   frames:1 bytes:995\n        png                              frames:23 bytes:14320\n          tcp.segments                   frames:18 bytes:8640\n          _ws.malformed                  frames:2 bytes:2251\n        image-jfif                       frames:6 bytes:4737\n          tcp.segments                   frames:6 bytes:4737\n      smtp                               frames:269 bytes:303146\n        imf                              frames:3 bytes:180\n      imap                               frames:291 bytes:307021\n        imf                              frames:2 bytes:1189\n        tcp.segments                     frames:202 bytes:284153\n    igmp                                 frames:6 bytes:360\n===================================================================\n"})}),"\n",(0,t.jsx)(n.p,{children:"All ethernet (layer 2) and IP (layer 3) communication."}),"\n",(0,t.jsx)(n.p,{children:"We can see that DHCP communication occurred. It can help us link the provided MAC address to the assigned IP address."}),"\n",(0,t.jsx)(n.p,{children:"As a reminder, this is how the DHCP request/response works:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://www.researchgate.net/profile/Chi-Fu-Huang/publication/4109437/figure/fig8/AS:670523923103777@1536876769687/llustrates-the-related-DHCP-message-flows-The-DHCP-Discover-is-forwarded-by-the-DHCP.ppm",alt:"dhcp-req-res"})}),"\n",(0,t.jsx)(n.p,{children:"Let's list all DHCP communication in the packet capture:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'\u276f tshark -r evidence-packet-analysis.pcap -Y "eth.addr == 00:21:70:4d:4f:ae and bootp" -V\n'})}),"\n",(0,t.jsxs)(n.p,{children:["We can see in frame 2 that the DHCP message is sent to request a local IP address ",(0,t.jsx)(n.code,{children:"192.168.30.108"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Frame 2: 352 bytes on wire (2816 bits), 352 bytes captured (2816 bits)\n    ...\nDynamic Host Configuration Protocol (Request)\n    Message type: Boot Request (1)\n    Option: (53) DHCP Message Type (Request)\n        Length: 1\n        DHCP: Request (3)\n    Option: (61) Client identifier\n        Length: 7\n        Hardware type: Ethernet (0x01)\n        Client MAC address: Dell_4d:4f:ae (00:21:70:4d:4f:ae)\n    Option: (50) Requested IP Address (192.168.30.108)\n        Length: 4\n        Requested IP Address: 192.168.30.108\n    Option: (12) Host Name\n        Length: 10\n        Host Name: ann-laptop\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Then, in frame 5, we see the reply/acknowledgement for the requeted IP address, the DNS server (",(0,t.jsx)(n.code,{children:"10.30.30.20"}),") and the DHCP server (",(0,t.jsx)(n.code,{children:"192.168.30.108"}),")"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Frame 5: 358 bytes on wire (2864 bits), 358 bytes captured (2864 bits)\n\nDynamic Host Configuration Protocol (ACK)\n    Message type: Boot Reply (2)\n    Option: (53) DHCP Message Type (ACK)\n        Length: 1\n        DHCP: ACK (5)\n    Option: (54) DHCP Server Identifier (192.168.30.10)\n        Length: 4\n        DHCP Server Identifier: 192.168.30.10\n    Option: (51) IP Address Lease Time\n        Length: 4\n        IP Address Lease Time: (3600s) 1 hour\n    Option: (58) Renewal Time Value\n        Length: 4\n        Renewal Time Value: (1800s) 30 minutes\n    Option: (59) Rebinding Time Value\n        Length: 4\n        Rebinding Time Value: (3150s) 52 minutes, 30 seconds\n    Option: (81) Client Fully Qualified Domain Name\n        Length: 25\n        Flags: 0x00\n            0000 .... = Reserved flags: 0x0\n            .... 0... = Server DDNS: Some server updates\n            .... .0.. = Encoding: ASCII encoding\n            .... ..0. = Server overrides: No override\n            .... ...0 = Server: Client\n        A-RR result: 0\n        PTR-RR result: 0\n        Client name: ann-laptop.example.com\n    Option: (1) Subnet Mask (255.255.255.0)\n        Length: 4\n        Subnet Mask: 255.255.255.0\n    Option: (6) Domain Name Server\n        Length: 4\n        Domain Name Server: 10.30.30.20\n    Option: (46) NetBIOS over TCP/IP Node Type\n        Length: 1\n        NetBIOS over TCP/IP Node Type: H-node (8)\n    Option: (3) Router\n        Length: 4\n        Router: 192.168.30.10\n    Option: (255) End\n        Option End: 255\n"})}),"\n",(0,t.jsx)(n.h3,{id:"keyword-search",children:"Keyword Search"}),"\n",(0,t.jsx)(n.p,{children:"A common way to find any information is to perform some search for keywords. Since we know the targets name is 'Ann Dercover', we can search for it within the packet capture."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'\u276f ngrep "Ann" -N -t -q -I evidence-packet-analysis.pcap\n'})}),"\n",(0,t.jsx)(n.p,{children:"We can see that Ann sent message to get a fake passport which was split into a couple of messages (output was cleaned up):"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'T(6) 2011/05/17 22:33:08.648555 192.168.30.108:1685 -> 205.188.58.10:143 [AP] #1615\n  From: "Ann Dercover" <sneakyg33ky@aol.com>\n  To: <inter0pt1c@aol.com>\n  Subject: need a favor\n  Date: Tue, 17 May 2011 13:32:17 -0600\n  Hey, can you hook me up quick with that fake passport you were taking \n  about? - Ann\n\n  T(6) 2011/05/17 22:34:16.481132 192.168.30.108:1687 -> 64.12.168.40:587 [A] #1749\n  From: "Ann Dercover" <sneakyg33ky@aol.com>\n  To: <d4rktangent@gmail.com>\n  Subject: lunch next week\n  Date: Tue, 17 May 2011 13:33:26 -0600\n  Sorry-- I can\'t do lunch next week after all. Heading out of town. \n  Another time!\n  \n  -Ann\n\nT(6) 2011/05/17 22:35:16.962873 192.168.30.108:1689 -> 64.12.168.40:587 [A] #1825\n  From: "Ann Dercover" <sneakyg33ky@aol.com>\n  To: <mistersekritx@aol.com>\n  Subject: rendezvous\n  Date: Tue, 17 May 2011 13:34:26 -0600\n  \n  Hi sweetheart! Bring your fake passport and a bathing suit. Address \n  attached. love, Ann\n'})}),"\n",(0,t.jsxs)(n.p,{children:["And we see there's an email attachment called ",(0,t.jsx)(n.code,{children:"secretrendezvous.docx"})," and the base64 representation of this file:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'T(6) 2011/05/17 22:35:16.963123 192.168.30.108:1689 -> 64.12.168.40:587 [A] #1826\n  it. Address attached. love, Ann</FONT></DIV></BODY></HTML>\n  Content-Type: application/octet-stream;\n  name="secretrendezvous.docx"\n  Content-Transfer-Encoding: base64\n  Content-Disposition: attachment;\n  filename="secretrendezvous.docx"\n\n  UEsDBBQABgAIAAAAIQCht/xGcgEAAFIFAAATAAgCW0NvbnRlbnRfVHlwZXNdLnhtbCCiBAIooAAC\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n....\n'})}),"\n",(0,t.jsx)(n.h3,{id:"carving-out-attachment",children:"Carving Out Attachment"}),"\n",(0,t.jsxs)(n.p,{children:["Putting this base64 payload into a file ",(0,t.jsx)(n.code,{children:"evidence-packet-analysis-smtp3-attachment.b64.enc"})]}),"\n",(0,t.jsx)(n.p,{children:"We can take the base64 payload and decrypt it into a Microsoft Word document format:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"\u276f base64 -d evidence-packet-analysis-smtp3-attachment.b64.enc > secretrendezvous.docx\n\n\u276f file secretrendezvous.docx\nsecretrendezvous.docx: Microsoft Word 2007+\n"})}),"\n",(0,t.jsx)(n.p,{children:"Opening the document, we can see that it has an image in png format. We can also carve it out:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"\u276f unzip secretrendezvous.docx\nArchive:  secretrendezvous.docx\n  inflating: [Content_Types].xml\n  inflating: _rels/.rels\n  inflating: word/_rels/document.xml.rels\n  inflating: word/document.xml\n extracting: word/media/image1.png\n  inflating: word/theme/theme1.xml\n  inflating: word/settings.xml\n  inflating: word/webSettings.xml\n  inflating: docProps/core.xml\n  inflating: word/styles.xml\n  inflating: word/fontTable.xml\n  inflating: docProps/app.xml\n\u276f open word/media/image1.png\n"})})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>o});var t=s(96540);const r={},a=t.createContext(r);function i(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);