"use strict";(self.webpackChunkkgkb=self.webpackChunkkgkb||[]).push([[43059],{96190:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>l});var s=t(74848),a=t(28453);const i={slug:"dotless-email-regex-validation-swagger",title:"How To Set Up Dotless Email Validation in Swagger",description:"A detailed explanation what dotless emails are and how to set them up in Swagger.",authors:["kbbgl"],tags:["email","regex","web-dev","swagger"],image:"./res/swagger-logo.png"},r=void 0,o={permalink:"/blog/dotless-email-regex-validation-swagger",source:"@site/blog/dotless-email-regex-validation-swagger.md",title:"How To Set Up Dotless Email Validation in Swagger",description:"A detailed explanation what dotless emails are and how to set them up in Swagger.",date:"2025-03-12T20:45:38.000Z",tags:[{inline:!1,label:"Email",permalink:"/blog/tags/email"},{inline:!1,label:"Regex",permalink:"/blog/tags/regex"},{inline:!1,label:"Web-dev",permalink:"/blog/tags/web-dev"},{inline:!1,label:"Swagger",permalink:"/blog/tags/swagger"}],readingTime:4.675,hasTruncateMarker:!0,authors:[{name:"Kobbi Gal",title:"I like to pick things apart and see how they work inside",url:"https://github.com/kbbgl",imageURL:"https://avatars.githubusercontent.com/u/14372649",key:"kbbgl",page:null}],frontMatter:{slug:"dotless-email-regex-validation-swagger",title:"How To Set Up Dotless Email Validation in Swagger",description:"A detailed explanation what dotless emails are and how to set them up in Swagger.",authors:["kbbgl"],tags:["email","regex","web-dev","swagger"],image:"./res/swagger-logo.png"},unlisted:!1,prevItem:{title:"Debugging NodeJS Microservice with Shared Storage on\xa0Kubernetes",permalink:"/blog/debugging-nodejs-microservice-with-shared-storage-on-kubernetes"},nextItem:{title:"Fixing Ubuntu Hibernation",permalink:"/blog/fixing-ubuntu-hibernation"}},d={image:t(10417).A,authorsImageUrls:[void 0]},l=[{value:"Introduction",id:"introduction",level:2},{value:"Email Address Syntax Compliance",id:"email-address-syntax-compliance",level:2},{value:"Adding TLD Zone Record to DNS",id:"adding-tld-zone-record-to-dns",level:2},{value:"Changing Swagger Validation",id:"changing-swagger-validation",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,s.jsxs)(n.p,{children:["One of our customers recently attempted (for reason unknown to us) to log into our platform using ",(0,s.jsx)(n.a,{href:"https://www.okta.com/products/single-sign-on/",children:"Okta Single Sign On (SSO)"})," and ",(0,s.jsx)(n.a,{href:"https://openid.net/connect/",children:"OpenID-Connect"})," with emails missing a top-level domain (TLD) while they could log in just fine with a standard email address."]}),"\n",(0,s.jsxs)(n.p,{children:["While most of us in the day-to-day use the standard email address format with a top-level domain added, e.g. ",(0,s.jsx)(n.code,{children:"user@domain.org"}),", this customer required to be able to log in with user@domain. Our platform rejected the user and they were unable to log in."]}),"\n",(0,s.jsxs)(n.p,{children:["My first question was whether this email address (",(0,s.jsx)(n.code,{children:"user@domain"}),") was even allowed. If it was, I needed to find why it's being rejected."]}),"\n",(0,s.jsx)(n.h2,{id:"email-address-syntax-compliance",children:"Email Address Syntax Compliance"}),"\n",(0,s.jsxs)(n.p,{children:["Reaching out to the web to figure out whether the customer's request was valid, I was surprised to find that the only necessary parts of an email address are according to ",(0,s.jsx)(n.a,{href:"https://datatracker.ietf.org/doc/html/rfc2821#section-2.3.10",children:"section 2.3.10 of the RFC 2821"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"A 'local' part, anything on the left of the @ sign."}),"\n",(0,s.jsx)(n.li,{children:"A 'domain host' part, anything on the right of the @ sign."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["I found that the ",(0,s.jsx)(n.a,{href:"https://www.icann.org/en/system/files/files/ua-factsheet-a4-17dec15-en.pdf",children:"Internet Corporation for Assigned Names (ICANN) highly discourages the use of unspecified TLD"})," and that it ",(0,s.jsx)(n.a,{href:"https://www.icann.org/en/announcements/details/new-gtld-dotless-domain-names-prohibited-30-8-2013-en",children:"requires a specified record in the apex of the TLD zone in the DNS"}),". Aside from that, it is compliant with ",(0,s.jsx)(n.a,{href:"https://datatracker.ietf.org/doc/html/rfc5322#section-3",children:"RFC 5322"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"So the customer's request is a valid one! This meant that I needed to perform 2 changes in two different areas:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Modify the name server configuration on the customer's Windows instance."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Find where within our code there's validation for the email address and modify it."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"adding-tld-zone-record-to-dns",children:"Adding TLD Zone Record to DNS"}),"\n",(0,s.jsxs)(n.p,{children:["After a few days of awaiting access to the DNS, I now needed to understand what record I needed to add to the DNS. The ",(0,s.jsx)(n.a,{href:"https://www.icann.org/en/announcements/details/new-gtld-dotless-domain-names-prohibited-30-8-2013-en",children:"ICANN link above"})," suggested that:"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Dotless names would require the inclusion of, for example, an A, AAAA, or MX, record in the apex of a TLD zone in the DNS (i.e., the record relates to the TLD-string itself)."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["I found out that the ",(0,s.jsx)(n.a,{href:"https://www.cloudflare.com/learning/dns/dns-records/dns-a-record/",children:"A record indicates the IPv4 address"})," of a domain and that the the ",(0,s.jsx)(n.a,{href:"https://il.godaddy.com/en/help/add-an-aaaa-record-19214",children:"AAAA record was the same but for IPv6"}),". The relevant record seemed to be ",(0,s.jsx)(n.a,{href:"https://www.cloudflare.com/learning/dns/dns-records/dns-mx-record/",children:"MX as it directs emails to SMTP servers"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Now that I knew that I needed to add an MX record, I found a ",(0,s.jsxs)(n.a,{href:"https://docs.microsoft.com/en-us/powershell/module/dnsserver/add-dnsserverresourcerecordmx?view=windowsserver2019-ps",children:["PowerShell cmdlet called ",(0,s.jsx)(n.code,{children:"Add-DnsServerResourceRecordMX"})]})," which would allow me to do just that."]}),"\n",(0,s.jsx)(n.p,{children:"After reading through the documentation and doing some trial and error on my test machine, I formulated the following command to successfully add the MX record:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:"Add-DnsServerResourceRecordMX -Preference 1 -Name \u201c.\u201d -MailExchange \u201cGS-MEX001.domain.suffix\u201d -ZoneName \u201cdomain.suffix\u201d\n"})}),"\n",(0,s.jsx)(n.p,{children:"Here's an explanation of the cmdlet argments:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["I set ",(0,s.jsx)(n.code,{children:"-Preference"})," to ",(0,s.jsx)(n.code,{children:"1"})," ensure that all SMTP requests sent from this Windows instance to mailservers will go through this ",(0,s.jsx)(n.code,{children:"MX"})," record."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"-Name"})," specifies the name of the host for which this record will apply. In this case, we used ",(0,s.jsx)(n.code,{children:"."})," because we're going to be using the parent domain as the suffix instead of the TLD."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"-MailExchange"})," specifes the Fully Qualified Domain Name (FQDN) for the mail exchanger, e.g. the SMTP server address. Obviously the one used in the command above is made up."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"-ZoneName"})," specifies the DNS zone. DNS is split into different zones which allow administrators to have granular control of different DNS components such as certificates, authoritative nameservers and providers."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"After running this command on the production server, I saw that they were successfully added by running the following cmdlet:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:"Get-DnsServerSetting -All\n"})}),"\n",(0,s.jsxs)(n.p,{children:["So now, if someone sends an email to the address ",(0,s.jsx)(n.code,{children:"@domain.suffix"}),", the sender email server will review and choose the ",(0,s.jsx)(n.code,{children:"MX"})," record we created above and will direct the packet to it."]}),"\n",(0,s.jsx)(n.p,{children:"Our work with nameservers is done! Next step is to look at some platform code!"}),"\n",(0,s.jsx)(n.h2,{id:"changing-swagger-validation",children:"Changing Swagger Validation"}),"\n",(0,s.jsxs)(n.p,{children:["Reviewing our backend logic for the particular NodeJS microservice which handles all user authentication and management, I found out that when a user is able to successfully  log into the system using an SSO mechanism, the microservice generates an object for this user and saves in it in the database. As part of this user object generation, there is validation of the request body of the email property. This is why, when attempting to generate a user without a TLD on the platform, the API returns a ",(0,s.jsx)(n.code,{children:"422 - Unprocessable Entity"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST "http://test/api/users" -H "Accept: application/json" -H "Content-Type: application/json" -d\n{\n   "first_name": "John",\n   "last_name": "Doe",\n   "email": "jdoe@domain"\n}\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n   "error": {\n        "message": "Request validation failed: Parameter (user) failed schema validation",\n        "status": 422,\n        "httpMessage": "Unprocessable Entity"\n   }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["After further debugging, I was able to pinpoint where this user creation validation is enforced: in the ",(0,s.jsx)(n.a,{href:"https://swagger.io/",children:"Swagger"})," configuration:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'user:\n  type: object\n  properties:\n    email:\n      type: string\n      pattern: >-\n        ^(([^<>()[\\]\\\\.,;:\\s@"]+(\\.[^<>()[\\]\\\\.,;:\\s@"]+)*)|(".+"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$\n\n'})}),"\n",(0,s.jsx)(n.p,{children:"Removing this pattern-based validation and restarting the microservice, I was able to successfully generate a user!"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST "http://test/api/users" -H "Accept: application/json" -H "Content-Type: application/json" -d\n{\n   "firstName": "John",\n   "lastName": "Doe",\n   "email": "jdoe@domain"\n}\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n   "email" : "jdoe@domain",\n   "id" : "a1b2c3"\n   "active": true,\n   "created" : "2021-09-26T15:02:01.328Z",\n   "lastUpdated": "2021-09-26T15:02:01.328Z",\n   "firstName": "John",\n   "lastName": "Doe",\n   "username": "jdoe@domain"\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Applying the same changes in the customer's environment resolved their issue!"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"After note:"})," Please be mindful before making this change in a production environment. Removing the whole email validation in this case wasn't dangerous since we did it in an internal/dev environment to prove a point. A change such as the one described here can make your application API vulnerable to different attack vectors."]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},10417:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/swagger-logo-afd1bfb8320b5e8ca2cefb7c4960463d.png"},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var s=t(96540);const a={},i=s.createContext(a);function r(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);